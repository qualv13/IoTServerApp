<!DOCTYPE html>
<html lang="pl" data-bs-theme="dark">
<head>
  <meta charset="UTF-8">
  <title>IoT Control Panel</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #212529; color: #f8f9fa; }
    .card { background-color: #343a40; border-color: #495057; }
    .status-dot { height: 12px; width: 12px; background-color: #bbb; border-radius: 50%; display: inline-block; }
    .status-on { background-color: #28a745; box-shadow: 0 0 8px #28a745; }
    .status-off { background-color: #dc3545; }
    #dashboard-view { display: none; }
  </style>
</head>
<body class="d-flex align-items-center py-4 bg-body-tertiary">

<main class="container w-100 m-auto" style="max-width: 800px;">

  <div id="login-view" class="card p-4 shadow-lg">
    <h2 class="text-center mb-4">IoT System Login</h2>
    <form onsubmit="handleLogin(event)">
      <div class="mb-3">
        <label>Username</label>
        <input type="text" id="username" class="form-control" value="admin" required>
      </div>
      <div class="mb-3">
        <label>Password</label>
        <input type="password" id="password" class="form-control" value="password123" required>
      </div>
      <button type="submit" class="btn btn-primary w-100 py-2">Zaloguj się</button>
      <div id="login-error" class="text-danger mt-2 text-center" style="display:none">Błąd logowania</div>
    </form>
  </div>

  <div id="dashboard-view">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h3>Moje Urządzenia</h3>
      <button onclick="logout()" class="btn btn-outline-danger btn-sm">Wyloguj</button>
    </div>

    <div class="card mb-4">
      <div class="card-body d-flex gap-2">
        <input type="text" id="newLampId" class="form-control" placeholder="Numer seryjny lampy (np. device_001)">
        <button onclick="addLamp()" class="btn btn-success">Dodaj / Przejmij</button>
      </div>
    </div>

    <div class="card">
      <div class="card-header">Lista Aktywnych Lamp</div>
      <ul class="list-group list-group-flush" id="lamp-list">
      </ul>
    </div>
  </div>

</main>

<script>
  const API_URL = 'http://localhost:8080';
  let token = localStorage.getItem('jwt_token');

  // Sprawdź czy user jest już zalogowany przy starcie
  if (token) {
    showDashboard();
  }

  async function handleLogin(e) {
    e.preventDefault();
    const user = document.getElementById('username').value;
    const pass = document.getElementById('password').value;

    try {
      const response = await fetch(`${API_URL}/auth/login`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username: user, password: pass })
      });

      if (!response.ok) throw new Error('Auth failed');

      const data = await response.json();
      token = data.accessToken;
      localStorage.setItem('jwt_token', token);
      document.getElementById('login-error').style.display = 'none';
      showDashboard();
    } catch (err) {
      document.getElementById('login-error').style.display = 'block';
    }
  }

  function showDashboard() {
    document.getElementById('login-view').style.display = 'none';
    document.getElementById('dashboard-view').style.display = 'block';
    loadLamps();
  }

  function logout() {
    localStorage.removeItem('jwt_token');
    location.reload();
  }

  async function loadLamps() {
    const response = await fetch(`${API_URL}/users/me/lamps`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });

    if (response.status === 403) logout(); // Token wygasł

    const lamps = await response.json();
    const list = document.getElementById('lamp-list');
    list.innerHTML = '';

    lamps.forEach(lamp => {
      list.innerHTML += `
                <li class="list-group-item d-flex justify-content-between align-items-center bg-dark text-white border-secondary">
                    <div>
                        <span class="status-dot status-on me-2"></span>
                        <strong>${lamp.id}</strong>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-outline-light" onclick="sendCommand('${lamp.id}', 'TOGGLE')">Przełącz</button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteLamp('${lamp.id}')">Usuń</button>
                    </div>
                </li>
            `;
    });
  }

  async function addLamp() {
    const id = document.getElementById('newLampId').value;
    if (!id) return;

    await fetch(`${API_URL}/users/me/lamps`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ lampId: id })
    });

    document.getElementById('newLampId').value = '';
    loadLamps(); // Odśwież listę
  }

  async function sendCommand(lampId, cmd) {
    // Tu można podpiąć endpoint wysyłający komendę Protobuf
    alert(`Wysyłanie komendy ${cmd} do ${lampId}... (Backend musi obsłużyć to żądanie)`);
  }

  async function deleteLamp(lampId) {
    // Opcjonalnie: Implementacja DELETE
    if(confirm('Usunąć lampę?')) {
      console.log('Usuwanie', lampId);
      // fetch DELETE...
      // loadLamps();
    }
  }
</script>
</body>
</html>