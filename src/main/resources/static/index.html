<!DOCTYPE html>
<html lang="pl" data-bs-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IoT Control Panel v6.0 (FULL)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <style>
    body { background-color: #212529; color: #f8f9fa; font-family: 'Segoe UI', sans-serif; }
    .card { background-color: #2b3035; border: 1px solid #495057; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
    .status-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; transition: all 0.3s; }
    .status-on { background-color: #2ecc71; box-shadow: 0 0 10px #2ecc71; }
    .status-off { background-color: #e74c3c; box-shadow: none; }
    #loader {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.85); z-index: 9999; display: none;
      justify-content: center; align-items: center; flex-direction: column;
    }
    .auth-container { max-width: 400px; margin: 80px auto; }
    .chart-box { height: 250px; position: relative; width: 100%; }
    .nav-link { cursor: pointer; transition: color 0.2s; }
    .nav-link:hover { color: #fff !important; }
    .btn-action { width: 32px; height: 32px; padding: 0; display: inline-flex; align-items: center; justify-content: center; }
  </style>
</head>
<body>

<div id="loader">
  <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div>
  <div class="text-light">Ładowanie danych...</div>
</div>

<nav id="navbar" class="navbar navbar-expand-lg navbar-dark bg-dark border-bottom border-secondary mb-4 sticky-top" style="display: none;">
  <div class="container">
    <span class="navbar-brand fw-bold"><i class="fas fa-network-wired text-primary me-2"></i>IoT Manager</span>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav me-auto">
        <li class="nav-item"><a class="nav-link active" onclick="showView('dashboard')"><i class="fas fa-home me-1"></i> Pulpit</a></li>
        <li class="nav-item"><a class="nav-link" onclick="showView('stats')"><i class="fas fa-chart-pie me-1"></i> Statystyki</a></li>
      </ul>
      <div class="d-flex align-items-center gap-3">
        <div class="dropdown">
          <button class="btn btn-sm btn-outline-light dropdown-toggle" type="button" data-bs-toggle="dropdown">
            <i class="fas fa-user-circle me-1"></i> <span id="nav-username">User</span>
          </button>
          <ul class="dropdown-menu dropdown-menu-dark dropdown-menu-end">
            <li><a class="dropdown-item" href="#" onclick="openProfileModal()"><i class="fas fa-cog me-2"></i> Ustawienia konta</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item text-danger" href="#" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i> Wyloguj</a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</nav>

<main class="container py-4">

  <div id="login-view" class="auth-container">
    <div class="card p-4 shadow-lg border-0">
      <div class="text-center mb-4">
        <i class="fas fa-user-shield fa-3x text-primary mb-2"></i>
        <h3>Logowanie</h3>
      </div>
      <form onsubmit="handleLogin(event)">
        <div class="form-floating mb-3">
          <input type="text" id="loginUser" class="form-control" placeholder="Użytkownik" required>
          <label for="loginUser" class="text-secondary">Login</label>
        </div>
        <div class="form-floating mb-3">
          <input type="password" id="loginPass" class="form-control" placeholder="Hasło" required>
          <label for="loginPass" class="text-secondary">Hasło</label>
        </div>
        <button class="btn btn-primary w-100 fw-bold py-2 mb-3">Zaloguj się</button>
        <div class="text-center"><a href="#" onclick="showView('register')" class="text-decoration-none text-info">Nie masz konta? Zarejestruj się</a></div>
      </form>
    </div>
  </div>

  <div id="register-view" class="auth-container" style="display: none;">
    <div class="card p-4 shadow-lg border-info">
      <div class="text-center mb-4">
        <i class="fas fa-user-plus fa-3x text-info mb-2"></i>
        <h3>Rejestracja</h3>
      </div>
      <form onsubmit="handleRegister(event)">
        <div class="form-floating mb-3">
          <input type="text" id="regUser" class="form-control" placeholder="Login" required>
          <label for="regUser" class="text-secondary">Login</label>
        </div>
        <div class="form-floating mb-3">
          <input type="password" id="regPass" class="form-control" placeholder="Hasło" required>
          <label for="regPass" class="text-secondary">Hasło</label>
        </div>
        <button class="btn btn-info w-100 fw-bold py-2 mb-3 text-dark">Utwórz konto</button>
        <div class="text-center"><a href="#" onclick="showView('login')" class="text-decoration-none text-light">Powrót do logowania</a></div>
      </form>
    </div>
  </div>

  <div id="dashboard-view" style="display: none;">
    <div class="row g-4 mb-4">
      <div class="col-md-6">
        <div class="card h-100">
          <div class="card-header bg-success bg-opacity-25 fw-bold border-success"><i class="fas fa-plus-circle me-2"></i>Rejestracja Urządzenia</div>
          <div class="card-body d-flex align-items-center">
            <div class="input-group">
              <span class="input-group-text bg-dark border-secondary"><i class="fas fa-barcode"></i></span>
              <input type="text" id="newLampId" class="form-control bg-dark text-white border-secondary" placeholder="Serial Number (np. lamp_01)">
              <button onclick="addLamp()" class="btn btn-success">Dodaj</button>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card h-100 border-warning bg-dark">
          <div class="card-header bg-warning text-dark bg-opacity-75 fw-bold"><i class="fas fa-cloud-upload-alt me-2"></i>Aktualizacja Firmware (OTA)</div>
          <div class="card-body">
            <form onsubmit="handleOtaUpload(event)">
              <div class="input-group input-group-sm mb-2">
                <span class="input-group-text bg-dark border-secondary text-light">URL</span>
                <input type="url" id="otaUrl" class="form-control bg-dark text-white border-secondary" placeholder="http://server.com/firmware.bin" required>
              </div>
              <div class="row g-2">
                <div class="col-4">
                  <select id="otaTargetType" class="form-select form-select-sm bg-dark text-white border-secondary">
                    <option value="lamp">Lampa</option>
                    <option value="fleet">Flota</option>
                  </select>
                </div>
                <div class="col-8">
                  <input type="text" id="otaTargetId" class="form-control form-control-sm bg-dark text-white border-secondary" placeholder="ID Celu" required>
                </div>
              </div>
              <button type="submit" class="btn btn-sm btn-outline-warning w-100 mt-2">Wyślij Rozkaz Aktualizacji</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div class="row g-4">
      <div class="col-lg-8">
        <div class="d-flex justify-content-between align-items-center mb-3 border-bottom border-secondary pb-2">
          <h4 class="m-0"><i class="fas fa-lightbulb text-warning me-2"></i>Twoje Urządzenia</h4>
          <button onclick="loadLamps()" class="btn btn-sm btn-outline-light"><i class="fas fa-sync-alt"></i></button>
        </div>
        <div id="lamp-grid" class="row row-cols-1 row-cols-md-2 g-3"></div>
      </div>

      <div class="col-lg-4">
        <div class="card mb-4">
          <div class="card-header bg-primary bg-gradient text-white fw-bold"><i class="fas fa-layer-group me-2"></i>Zarządzanie Flotami</div>
          <div class="card-body p-2">
            <div class="input-group mb-3">
              <input type="text" id="newFleetName" class="form-control form-control-sm bg-dark text-white border-secondary" placeholder="Nazwa nowej floty">
              <button onclick="createFleet()" class="btn btn-sm btn-primary"><i class="fas fa-plus"></i></button>
            </div>
            <ul class="list-group list-group-flush small" id="fleet-list"></ul>
          </div>
        </div>

        <div class="alert alert-secondary d-flex align-items-center" role="alert">
          <i class="fas fa-info-circle me-2"></i>
          <small>Grupuj lampy, aby sterować nimi jednocześnie.</small>
        </div>
      </div>
    </div>
  </div>

  <div id="stats-view" style="display: none;">
    <h3 class="mb-4 text-info"><i class="fas fa-chart-line me-2"></i>Centrum Danych</h3>

    <div id="admin-stats-panel" class="card mb-5 border-warning" style="display: none;">
      <div class="card-header bg-warning text-dark fw-bold"><i class="fas fa-user-secret me-2"></i>Panel Administratora</div>
      <div class="card-body">
        <div class="row text-center mb-4">
          <div class="col-md-3"><h2 id="adm-users" class="text-warning fw-bold">0</h2><small>Użytkowników</small></div>
          <div class="col-md-3"><h2 id="adm-lamps" class="text-light fw-bold">0</h2><small>Wszystkie Lampy</small></div>
          <div class="col-md-3"><h2 id="adm-online" class="text-success fw-bold">0</h2><small>Globalnie Online</small></div>
          <div class="col-md-3"><h2 id="adm-temp" class="text-info fw-bold">0°C</h2><small>Śr. Temperatura</small></div>
        </div>
        <div class="row">
          <div class="col-md-4"><div class="chart-box"><canvas id="adminStatusChart"></canvas></div></div>
          <div class="col-md-4"><div class="chart-box"><canvas id="adminColorChart"></canvas></div></div>
          <div class="col-md-4"><div class="chart-box"><canvas id="adminTempChart"></canvas></div></div>
        </div>
      </div>
    </div>

    <div class="card border-primary">
      <div class="card-header bg-primary text-white fw-bold">Twoje Statystyki</div>
      <div class="card-body">
        <div class="row text-center mb-4">
          <div class="col-3"><h3 id="my-lamps" class="text-primary fw-bold">0</h3><small>Lampy</small></div>
          <div class="col-3"><h3 id="my-online" class="text-success fw-bold">0</h3><small>Włączone</small></div>
          <div class="col-3"><h3 id="my-offline" class="text-secondary fw-bold">0</h3><small>Wyłączone</small></div>
          <div class="col-3"><h3 id="my-temp" class="text-info fw-bold">0°C</h3><small>Śr. Temp</small></div>
        </div>
        <div class="row justify-content-center">
          <div class="col-md-5"><h6 class="text-center text-muted">Rozkład Kolorów</h6><div class="chart-box"><canvas id="userColorChart"></canvas></div></div>
          <div class="col-md-5"><h6 class="text-center text-muted">Średnia Temperatura</h6><div class="chart-box"><canvas id="userTempChart"></canvas></div></div>
        </div>
      </div>
    </div>
  </div>

</main>

<div class="modal fade" id="controlModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-white border-secondary">
      <div class="modal-header border-secondary">
        <h5 class="modal-title" id="modalTitle">Sterowanie</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-info py-2 small" id="targetInfo"></div>
        <div class="d-flex justify-content-center gap-4 mb-4">
          <button onclick="sendProtoCmd('ON')" class="btn btn-lg btn-success px-5 fw-bold shadow">ON</button>
          <button onclick="sendProtoCmd('OFF')" class="btn btn-lg btn-danger px-5 fw-bold shadow">OFF</button>
        </div>
        <hr class="border-secondary">
        <h6 class="mb-3 text-muted">Konfiguracja</h6>
        <div class="mb-3">
          <label class="form-label d-flex justify-content-between"><span>Jasność</span> <span id="briVal" class="badge bg-primary">50%</span></label>
          <input type="range" id="confBri" class="form-range" min="0" max="100" oninput="document.getElementById('briVal').innerText=this.value+'%'">
        </div>
        <div class="row mb-3">
          <div class="col-6">
            <label class="form-label">Kolor</label>
            <input type="color" id="confCol" class="form-control form-control-color w-100 bg-secondary border-0" value="#ffffff" title="Wybierz kolor">
          </div>
          <div class="col-6">
            <label class="form-label">Raportowanie (s)</label>
            <input type="number" id="confInt" class="form-control bg-dark text-white border-secondary" value="60">
          </div>
        </div>
        <button onclick="sendProtoConfig()" class="btn btn-primary w-100 mt-2"><i class="fas fa-save me-2"></i>Wyślij Konfigurację</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="detailsModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content bg-dark text-white border-secondary">
      <div class="modal-header border-secondary">
        <h5 class="modal-title"><i class="fas fa-chart-area me-2 text-info"></i>Telemetria: <span id="detLampId"></span></h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="row mb-3">
          <div class="col-md-4">
            <div class="p-3 border border-secondary rounded text-center bg-secondary bg-opacity-10">
              <small class="text-muted d-block">Czas pracy (Uptime)</small>
              <span id="detUptime" class="fs-5 fw-bold text-success">--</span>
            </div>
          </div>
          <div class="col-md-4">
            <div class="p-3 border border-secondary rounded text-center bg-secondary bg-opacity-10">
              <small class="text-muted d-block">Moc (W)</small>
              <span id="detPower" class="fs-5 fw-bold text-warning">--</span>
            </div>
          </div>
          <div class="col-md-4">
            <div class="p-3 border border-secondary rounded text-center bg-secondary bg-opacity-10">
              <small class="text-muted d-block">Jasność (Sensor)</small>
              <span id="detLux" class="fs-5 fw-bold text-info">--</span>
            </div>
          </div>
        </div>
        <h6 class="text-muted">Historia Temperatury</h6>
        <div class="chart-box">
          <canvas id="detailsChart"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="profileModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-white border-secondary">
      <div class="modal-header border-secondary">
        <h5 class="modal-title"><i class="fas fa-user-cog me-2"></i>Ustawienia Konta</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <ul class="nav nav-tabs border-secondary mb-3" id="profileTabs" role="tablist">
          <li class="nav-item"><button class="nav-link active text-light" data-bs-toggle="tab" data-bs-target="#tab-general">Ogólne</button></li>
          <li class="nav-item"><button class="nav-link text-light" data-bs-toggle="tab" data-bs-target="#tab-security">Bezpieczeństwo</button></li>
        </ul>
        <div class="tab-content">
          <div class="tab-pane fade show active" id="tab-general">
            <form onsubmit="updateProfile(event)">
              <div class="mb-3">
                <label class="form-label">Nazwa użytkownika</label>
                <input type="text" id="profUsername" class="form-control bg-dark text-white border-secondary">
              </div>
              <button class="btn btn-success w-100">Zapisz zmiany</button>
            </form>
            <hr class="border-secondary my-4">
            <button onclick="deleteAccount()" class="btn btn-outline-danger w-100"><i class="fas fa-trash me-2"></i>Usuń konto trwale</button>
          </div>
          <div class="tab-pane fade" id="tab-security">
            <form onsubmit="changePassword(event)">
              <div class="mb-3">
                <label class="form-label">Obecne hasło</label>
                <input type="password" id="passOld" class="form-control bg-dark text-white border-secondary" required>
              </div>
              <div class="mb-3">
                <label class="form-label">Nowe hasło</label>
                <input type="password" id="passNew" class="form-control bg-dark text-white border-secondary" required>
              </div>
              <button class="btn btn-warning text-dark w-100">Zmień hasło</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/protobufjs@7.2.4/dist/protobuf.min.js"></script>

<script>
  const API = window.location.origin;
  //const API = "http://localhost:8080"; // Uncomment for local dev if backend is on 8080
  let token = localStorage.getItem('jwt');
  let myFleets = [];
  let charts = {};
  let currentTarget = { type: 'lamp', id: null };

  // --- PROTOBUF DEFINITIONS ---
  let LampCommand, LampConfig, StatusReport;
  async function loadProtoDef() {
    try {
      // Definicja musi pasować do Twojego pliku .proto w backendzie
      let protoDef = `
        syntax = "proto3"; package com.iot.backend.proto;
        message LampCommand { enum Type { ON=0; OFF=1; REBOOT=2; OTA_UPDATE=3; } Type type=1; string ota_url=2; }
        message LampConfig { int32 brightness=1; string color=2; int32 report_interval=3; }
        message StatusReport {
            uint32 version=1;
            int64 ts=2;
            uint32 uptime_seconds=3;
            repeated double temperature_readings=4;
            float power_consumption_watts=5;
            float brightness_level=6;
        }
      `;
      const root = protobuf.parse(protoDef).root;
      LampCommand = root.lookupType("com.iot.backend.proto.LampCommand");
      LampConfig = root.lookupType("com.iot.backend.proto.LampConfig");
      StatusReport = root.lookupType("com.iot.backend.proto.StatusReport");
    } catch(e) { console.error("Proto error", e); }
  }

  // --- INIT ---
  (async function(){
    await loadProtoDef();
    if(token) init(); else showView('login');
  })();

  function showView(viewName) {
    // Hide all
    ['login-view','register-view','dashboard-view','stats-view','navbar'].forEach(id => document.getElementById(id).style.display='none');
    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));

    if(viewName === 'login') document.getElementById('login-view').style.display = 'block';
    if(viewName === 'register') document.getElementById('register-view').style.display = 'block';

    if(viewName === 'dashboard' || viewName === 'stats') {
      document.getElementById(viewName+'-view').style.display = 'block';
      document.getElementById('navbar').style.display = 'block';
      // Highlight nav item
      if(viewName === 'dashboard') document.querySelectorAll('.nav-link')[0].classList.add('active');
      if(viewName === 'stats') {
        document.querySelectorAll('.nav-link')[1].classList.add('active');
        loadStats();
      }
    }
  }

  // --- AUTH FETCH (POPRAWIONY) ---
  async function authFetch(url, opts={}) {
    document.getElementById('loader').style.display = 'flex';
    opts.headers = opts.headers || {};
    opts.headers['Authorization'] = `Bearer ${token}`;
    if(opts.body && !opts.headers['Content-Type']) opts.headers['Content-Type']='application/json';

    try {
      const res = await fetch(url, opts);
      document.getElementById('loader').style.display = 'none';

      // Obsługa wygasłego tokena (401)
      if(res.status === 401) { logout(); return null; }

      // Obsługa braku dostępu (403) - nie wylogowuje, tylko loguje błąd
      if(res.status === 403) { console.warn("403 Forbidden:", url); return res; }

      return res;
    } catch(e) {
      document.getElementById('loader').style.display = 'none';
      console.error("Network error", e);
      return null;
    }
  }

  async function handleLogin(e) {
    e.preventDefault();
    const u = document.getElementById('loginUser').value;
    const p = document.getElementById('loginPass').value;
    try {
      const res = await fetch(`${API}/auth/login`, {
        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({username: u, password: p})
      });
      if(!res.ok) throw new Error();
      const data = await res.json();
      token = data.accessToken;
      localStorage.setItem('jwt', token);
      localStorage.setItem('user', u);
      init();
    } catch(e) { alert('Błąd logowania. Sprawdź dane.'); }
  }

  async function handleRegister(e) {
    e.preventDefault();
    const u = document.getElementById('regUser').value;
    const p = document.getElementById('regPass').value;
    const res = await fetch(`${API}/users`, {
      method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({username: u, password: p})
    });
    if(res.ok) { alert("Konto utworzone!"); showView('login'); }
    else alert("Błąd rejestracji (może login zajęty?)");
  }

  function init() {
    showView('dashboard');
    document.getElementById('nav-username').innerText = localStorage.getItem('user');
    refreshAll();
  }

  function logout() { localStorage.removeItem('jwt'); location.reload(); }

  // --- PROFILE MANAGEMENT ---
  function openProfileModal() {
    document.getElementById('profUsername').value = localStorage.getItem('user');
    new bootstrap.Modal(document.getElementById('profileModal')).show();
  }

  async function updateProfile(e) {
    e.preventDefault();
    const newName = document.getElementById('profUsername').value;
    const res = await authFetch(`${API}/users/me`, { method: 'PUT', body: JSON.stringify({username: newName}) });
    if(res && res.ok) {
      localStorage.setItem('user', newName);
      alert('Nazwa zmieniona!');
      location.reload();
    } else {
      alert('Błąd zmiany nazwy.');
    }
  }

  async function changePassword(e) {
    e.preventDefault();
    const oldP = document.getElementById('passOld').value;
    const newP = document.getElementById('passNew').value;
    const res = await authFetch(`${API}/users/me/password`, { method: 'PUT', body: JSON.stringify({currentPassword: oldP, newPassword: newP}) });
    if(res && res.ok) { alert('Hasło zmienione!'); }
    else { alert('Błąd! Sprawdź stare hasło.'); }
  }

  async function deleteAccount() {
    if(confirm('CZY NA PEWNO? To usunie twoje konto i odepnie wszystkie lampy.')) {
      await authFetch(`${API}/users/me`, {method:'DELETE'});
      logout();
    }
  }

  // --- CORE DATA ---
  async function refreshAll() { await loadFleets(); await loadLamps(); }

  async function loadFleets() {
    const res = await authFetch(`${API}/fleets`);
    if(!res) return;
    myFleets = await res.json();
    const list = document.getElementById('fleet-list');
    list.innerHTML = '';
    myFleets.forEach(f => {
      list.innerHTML += `
        <li class="list-group-item bg-dark text-white border-secondary d-flex justify-content-between align-items-center p-2">
            <div class="d-flex align-items-center">
              <i class="fas fa-folder text-primary me-2"></i>
              <span class="fw-bold">${f.name}</span>
              <span class="badge bg-secondary ms-2 small">ID:${f.id}</span>
            </div>
            <div>
              <button onclick="openModal('fleet', ${f.id})" class="btn btn-action btn-sm btn-outline-info me-1" title="Steruj grupą"><i class="fas fa-sliders-h"></i></button>
              <button onclick="deleteFleet(${f.id})" class="btn btn-action btn-sm btn-outline-danger" title="Usuń flotę"><i class="fas fa-trash-alt"></i></button>
            </div>
        </li>`;
    });
  }

  async function createFleet() {
    const name = document.getElementById('newFleetName').value;
    if(!name) return;
    await authFetch(`${API}/fleets`, { method: 'POST', body: JSON.stringify({name}) });
    document.getElementById('newFleetName').value=''; refreshAll();
  }

  async function deleteFleet(id) {
    if(confirm("Czy usunąć tę flotę? Lampy zostaną zachowane (odpięte).")) {
      await authFetch(`${API}/fleets/${id}`, { method: 'DELETE' });
      refreshAll();
    }
  }

  async function loadLamps() {
    const res = await authFetch(`${API}/users/me/lamps`);
    if(!res) return;
    let lamps = await res.json();

    // Sortowanie: Bez floty -> Z flotą (po ID floty) -> Nazwa
    lamps.sort((a, b) => {
      const fA = a.fleetId; const fB = b.fleetId;
      if (!fA && !fB) return a.id.localeCompare(b.id);
      if (!fA) return -1;
      if (!fB) return 1;
      if (fA !== fB) return fA - fB;
      return a.id.localeCompare(b.id);
    });

    const grid = document.getElementById('lamp-grid');
    grid.innerHTML = '';

    lamps.forEach(lamp => {
      let optionsHtml = '<option value="" disabled selected>Wybierz flotę</option>';
      myFleets.forEach(f => { optionsHtml += `<option value="${f.id}">${f.name}</option>`; });

      let fleetSec = lamp.fleetId
              ? `<div class="d-flex justify-content-between align-items-center bg-secondary bg-opacity-25 rounded p-1 mb-2">
                   <small class="text-info mx-2"><i class="fas fa-link me-1"></i>Flota: ${lamp.fleetId}</small>
                   <button onclick="removeFromFleet(${lamp.fleetId}, '${lamp.id}')" class="btn btn-action btn-sm btn-outline-warning border-0" title="Odepnij"><i class="fas fa-unlink"></i></button>
                 </div>`
              : `<div class="input-group input-group-sm mb-2">
                   <select id="sel-${lamp.id}" class="form-select bg-dark text-white border-secondary py-0" style="font-size:0.8rem">${optionsHtml}</select>
                   <button onclick="assignToFleet('${lamp.id}')" class="btn btn-outline-secondary"><i class="fas fa-plus"></i></button>
                 </div>`;

      grid.innerHTML += `
        <div class="col"><div class="card h-100 border-secondary">
          <div class="card-body p-3 d-flex flex-column">
            <div class="d-flex justify-content-between align-items-start mb-2">
                <div>
                  <h5 class="card-title m-0 text-truncate fw-bold text-light" title="${lamp.id}">${lamp.id}</h5>
                  <span class="badge ${lamp.on ? 'bg-success':'bg-danger'} text-dark rounded-pill" style="font-size:0.6rem">${lamp.on ? 'ON':'OFF'}</span>
                </div>
                <span class="status-dot ${lamp.on ? 'status-on':'status-off'} mt-1"></span>
            </div>

            ${fleetSec}

            <div class="mt-auto d-flex gap-2">
                <button onclick="openModal('lamp', '${lamp.id}')" class="btn btn-sm btn-primary flex-grow-1"><i class="fas fa-sliders-h me-1"></i></button>
                <button onclick="openLampDetails('${lamp.id}')" class="btn btn-sm btn-outline-info" title="Wykresy"><i class="fas fa-chart-area"></i></button>
                <button onclick="delLamp('${lamp.id}')" class="btn btn-sm btn-outline-danger" title="Usuń"><i class="fas fa-trash"></i></button>
            </div>
        </div></div></div>`;
    });
  }

  // --- LAMP OPERATIONS ---
  async function addLamp() {
    const id = document.getElementById('newLampId').value;
    if(!id) return;
    const res = await authFetch(`${API}/users/me/lamps`, { method:'POST', body: JSON.stringify({lampId: id}) });
    if(res && res.ok) {
      const data = await res.json();
      alert("Lampa dodana!\n\nTOKEN URZĄDZENIA (Ważne!):\n" + data.device_token);
      document.getElementById('newLampId').value=''; loadLamps();
    }
  }
  async function delLamp(id) {
    if(confirm(`Usunąć lampę ${id}?`)) {
      await authFetch(`${API}/users/me/lamps/${id}`, {method:'DELETE'});
      loadLamps();
    }
  }
  async function assignToFleet(lId) {
    const fId = document.getElementById(`sel-${lId}`).value;
    if(!fId) return;
    await authFetch(`${API}/fleets/${fId}/lamps/${lId}`, { method: 'POST' });
    loadLamps();
  }
  async function removeFromFleet(fId, lId) {
    if(confirm('Odpiąć z floty?')) {
      await authFetch(`${API}/fleets/${fId}/lamps/${lId}`, { method: 'DELETE' });
      loadLamps();
    }
  }

  // --- CONTROL MODAL ---
  async function openModal(type, id) {
    currentTarget = { type: type, id: id };
    document.getElementById('modalTitle').innerText = (type==='lamp') ? `Lampa: ${id}` : `Flota: ${id}`;
    document.getElementById('targetInfo').innerText = (type==='fleet') ? "Sterowanie grupowe." : "Sterowanie indywidualne.";

    // Defaults
    document.getElementById('confBri').value = 50;
    document.getElementById('briVal').innerText = "50%";
    document.getElementById('confCol').value = "#ffffff";
    document.getElementById('confInt').value = 60;

    if(type === 'lamp') {
      try {
        const res = await fetch(`${API}/lamps/${id}/config`, { headers: { 'Authorization': `Bearer ${token}` } });
        if(res.ok) {
          const buffer = await res.arrayBuffer();
          const decoded = LampConfig.decode(new Uint8Array(buffer));
          if(decoded.brightness) {
            document.getElementById('confBri').value = decoded.brightness;
            document.getElementById('briVal').innerText = decoded.brightness+"%";
          }
          if(decoded.color) document.getElementById('confCol').value = decoded.color;
          if(decoded.report_interval) document.getElementById('confInt').value = decoded.report_interval;
        }
      } catch(e) {}
    }
    new bootstrap.Modal(document.getElementById('controlModal')).show();
  }

  async function sendBin(url, body, method='POST') {
    document.getElementById('loader').style.display='flex';
    const res = await fetch(url, { method: method, headers: {'Authorization':`Bearer ${token}`, 'Content-Type':'application/x-protobuf'}, body: body });
    document.getElementById('loader').style.display='none';
    if(!res.ok) alert('Błąd wysyłania komendy');
    return res;
  }

  async function sendProtoCmd(typeStr) {
    const payload = { type: (typeStr==='ON'?0:1) };
    const buf = LampCommand.encode(LampCommand.create(payload)).finish();
    const url = (currentTarget.type === 'lamp') ? `${API}/lamps/${currentTarget.id}/command` : `${API}/fleets/${currentTarget.id}/command`;
    await sendBin(url, buf);
    if(currentTarget.type==='lamp') setTimeout(loadLamps, 800);
  }

  async function sendProtoConfig() {
    const payload = {
      brightness: parseInt(document.getElementById('confBri').value),
      color: document.getElementById('confCol').value,
      report_interval: parseInt(document.getElementById('confInt').value)
    };
    const buf = LampConfig.encode(LampConfig.create(payload)).finish();
    const url = (currentTarget.type === 'lamp') ? `${API}/lamps/${currentTarget.id}/config` : `${API}/fleets/${currentTarget.id}/config`;
    await sendBin(url, buf, 'PUT');
    setTimeout(loadLamps, 500);
  }

  // --- OTA ---
  async function handleOtaUpload(e) {
    e.preventDefault();
    const urlStr = document.getElementById('otaUrl').value;
    const targetType = document.getElementById('otaTargetType').value;
    const targetId = document.getElementById('otaTargetId').value;

    if(!urlStr || !targetId) return;

    // Tworzymy komendę z Typem 3 (OTA) i URL-em
    const payload = { type: 3, ota_url: urlStr };
    const buf = LampCommand.encode(LampCommand.create(payload)).finish();

    const endpoint = (targetType === 'lamp') ? `${API}/lamps/${targetId}/command` : `${API}/fleets/${targetId}/command`;

    if(confirm(`Wysłać OTA ${urlStr} do ${targetId}?`)) {
      await sendBin(endpoint, buf);
      alert("Rozkaz aktualizacji wysłany!");
    }
  }

  // --- DETAILS & CHARTS ---
  async function openLampDetails(id) {
    document.getElementById('detLampId').innerText = id;

    // Clear previous data
    document.getElementById('detUptime').innerText = "...";
    document.getElementById('detPower').innerText = "...";
    document.getElementById('detLux').innerText = "...";

    // Show modal first
    const modal = new bootstrap.Modal(document.getElementById('detailsModal'));
    modal.show();

    try {
      const res = await fetch(`${API}/lamps/${id}/status`, {
        headers: {'Authorization': `Bearer ${token}`, 'Accept': 'application/x-protobuf'}
      });

      if(res.ok) {
        const buffer = await res.arrayBuffer();
        const report = StatusReport.decode(new Uint8Array(buffer));

        // Fill basics
        const uptimeHrs = (report.uptime_seconds / 3600).toFixed(1);
        document.getElementById('detUptime').innerText = `${uptimeHrs}h`;
        document.getElementById('detPower').innerText = (report.power_consumption_watts || 0).toFixed(1);
        document.getElementById('detLux').innerText = (report.brightness_level || 0).toFixed(0);

        // Render Chart
        const temps = report.temperature_readings || [];
        // Create fake labels (Latest is last)
        const labels = temps.map((_, i) => `Pomiar ${i+1}`);

        renderChart('detailsChart', 'line', labels, temps, 'Temperatura (°C)', ['#e74c3c']);
      } else {
        document.getElementById('detUptime').innerText = "Brak danych";
      }
    } catch(e) {
      console.error("Chart error", e);
    }
  }

  // --- STATS LOGIC ---
  async function loadStats() {
    const user = localStorage.getItem('user');
    // User stats
    try {
      const res = await authFetch(`${API}/stats/me`);
      if(res && res.ok) {
        const data = await res.json();
        document.getElementById('my-lamps').innerText = data.totalLamps;
        document.getElementById('my-online').innerText = data.onlineLamps;
        document.getElementById('my-offline').innerText = data.offlineLamps;
        document.getElementById('my-temp').innerText = (data.averageTemperature || 0).toFixed(1) + '°C';

        renderChart('userColorChart', 'doughnut', Object.keys(data.colorDistribution), Object.values(data.colorDistribution), 'Kolory');
        renderChart('userTempChart', 'bar', ['Twoja Średnia'], [data.averageTemperature], 'Temp °C', ['#3498db']);
      }
    } catch(e){}

    // Admin stats
    if(user === 'admin') {
      document.getElementById('admin-stats-panel').style.display = 'block';
      try {
        const res = await authFetch(`${API}/stats/global`);
        if(res && res.ok) {
          const data = await res.json();
          document.getElementById('adm-users').innerText = data.totalUsers;
          document.getElementById('adm-lamps').innerText = data.totalLamps;
          document.getElementById('adm-online').innerText = data.onlineLamps;
          document.getElementById('adm-temp').innerText = (data.averageTemperature || 0).toFixed(1) + '°C';

          renderChart('adminStatusChart', 'pie', ['On', 'Off'], [data.onlineLamps, data.offlineLamps], 'Status', ['#2ecc71', '#e74c3c']);
          renderChart('adminColorChart', 'doughnut', Object.keys(data.colorDistribution), Object.values(data.colorDistribution), 'Kolory');
          renderChart('adminTempChart', 'bar', ['Globalna Średnia'], [data.averageTemperature], 'Temp °C', ['#f1c40f']);
        }
      } catch(e){}
    } else {
      document.getElementById('admin-stats-panel').style.display = 'none';
    }
  }

  function renderChart(canvasId, type, labels, dataArr, label, colors = null) {
    const ctx = document.getElementById(canvasId).getContext('2d');
    if(charts[canvasId]) charts[canvasId].destroy();

    let bgColors = colors;
    if(!bgColors) bgColors = labels.map(c => c.startsWith('#') ? c : '#3498db');

    charts[canvasId] = new Chart(ctx, {
      type: type,
      data: {
        labels: labels,
        datasets: [{ label: label, data: dataArr, backgroundColor: bgColors, borderColor: bgColors[0], borderWidth: 1, tension: 0.3 }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { display: type!=='bar' && type!=='line', labels: { color: '#ccc' } } },
        scales: (type==='bar'||type==='line') ? { y: { beginAtZero: false, ticks:{color:'#999'} }, x:{ticks:{color:'#999'}} } : {}
      }
    });
  }
</script>
</body>
</html>

<!--<!DOCTYPE html>-->
<!--<html lang="pl" data-bs-theme="dark">-->
<!--<head>-->
<!--  <meta charset="UTF-8">-->
<!--  <meta name="viewport" content="width=device-width, initial-scale=1.0">-->
<!--  <title>IoT Control Panel v5.0 (FLEETS & TEMP)</title>-->
<!--  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">-->
<!--  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>-->
<!--  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">-->

<!--  <style>-->
<!--    body { background-color: #212529; color: #f8f9fa; font-family: 'Segoe UI', sans-serif; }-->
<!--    .card { background-color: #2b3035; border: 1px solid #495057; }-->
<!--    .status-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; }-->
<!--    .status-on { background-color: #2ecc71; box-shadow: 0 0 8px #2ecc71; }-->
<!--    .status-off { background-color: #e74c3c; }-->
<!--    #loader {-->
<!--      position: fixed; top: 0; left: 0; width: 100%; height: 100%;-->
<!--      background: rgba(0,0,0,0.8); z-index: 9999; display: none;-->
<!--      justify-content: center; align-items: center;-->
<!--    }-->
<!--    .auth-container { max-width: 400px; margin: 80px auto; }-->
<!--    .chart-box { height: 200px; position: relative; }-->
<!--  </style>-->
<!--</head>-->
<!--<body>-->

<!--<div id="loader">-->
<!--  <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>-->
<!--</div>-->

<!--<nav id="navbar" class="navbar navbar-expand-lg navbar-dark bg-dark border-bottom border-secondary mb-4" style="display: none;">-->
<!--  <div class="container">-->
<!--    <span class="navbar-brand"><i class="fas fa-network-wired text-primary"></i> IoT Manager</span>-->
<!--    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">-->
<!--      <span class="navbar-toggler-icon"></span>-->
<!--    </button>-->
<!--    <div class="collapse navbar-collapse" id="navbarNav">-->
<!--      <ul class="navbar-nav me-auto">-->
<!--        <li class="nav-item">-->
<!--          <a class="nav-link active" href="#" onclick="showView('dashboard')"><i class="fas fa-home"></i> Pulpit</a>-->
<!--        </li>-->
<!--        <li class="nav-item">-->
<!--          <a class="nav-link" href="#" onclick="showView('stats')"><i class="fas fa-chart-pie"></i> Statystyki</a>-->
<!--        </li>-->
<!--      </ul>-->
<!--      <div class="d-flex align-items-center">-->
<!--        <span id="nav-username" class="me-3 text-muted small">User</span>-->
<!--        <button onclick="logout()" class="btn btn-outline-danger btn-sm"><i class="fas fa-power-off"></i></button>-->
<!--      </div>-->
<!--    </div>-->
<!--  </div>-->
<!--</nav>-->

<!--<main class="container py-4">-->

<!--  <div id="login-view" class="auth-container">-->
<!--    <div class="card p-4 shadow-lg">-->
<!--      <h3 class="text-center mb-4"><i class="fas fa-user-shield"></i> Logowanie</h3>-->
<!--      <form onsubmit="handleLogin(event)">-->
<!--        <div class="mb-3"><input type="text" id="loginUser" class="form-control" placeholder="Użytkownik" required></div>-->
<!--        <div class="mb-3"><input type="password" id="loginPass" class="form-control" placeholder="Hasło" required></div>-->
<!--        <button class="btn btn-primary w-100 fw-bold mb-3">Zaloguj się</button>-->
<!--        <div class="text-center"><a href="#" onclick="showView('register')" class="text-decoration-none small text-info">Rejestracja</a></div>-->
<!--      </form>-->
<!--    </div>-->
<!--  </div>-->

<!--  <div id="register-view" class="auth-container" style="display: none;">-->
<!--    <div class="card p-4 shadow-lg border-info">-->
<!--      <h3 class="text-center mb-4 text-info"><i class="fas fa-user-plus"></i> Rejestracja</h3>-->
<!--      <form onsubmit="handleRegister(event)">-->
<!--        <div class="mb-3"><input type="text" id="regUser" class="form-control" placeholder="Login" required></div>-->
<!--        <div class="mb-3"><input type="password" id="regPass" class="form-control" placeholder="Hasło" required></div>-->
<!--        <button class="btn btn-info w-100 fw-bold mb-3 text-dark">Utwórz konto</button>-->
<!--        <div class="text-center"><a href="#" onclick="showView('login')" class="text-decoration-none small text-light">Powrót do logowania</a></div>-->
<!--      </form>-->
<!--    </div>-->
<!--  </div>-->

<!--  <div id="dashboard-view" style="display: none;">-->
<!--    <div class="row g-4 mb-4">-->
<!--      <div class="col-md-6">-->
<!--        <div class="card h-100">-->
<!--          <div class="card-header bg-success text-white bg-opacity-25 fw-bold"><i class="fas fa-tools"></i> Dodaj Urządzenie</div>-->
<!--          <div class="card-body">-->
<!--            <div class="input-group">-->
<!--              <span class="input-group-text bg-dark border-secondary"><i class="fas fa-barcode"></i></span>-->
<!--              <input type="text" id="newLampId" class="form-control" placeholder="ID Lampy (np. lamp_01)">-->
<!--              <button onclick="addLamp()" class="btn btn-success">Dodaj</button>-->
<!--            </div>-->
<!--          </div>-->
<!--        </div>-->
<!--      </div>-->
<!--      <div class="col-md-6">-->
<!--        <div class="card h-100 border-warning">-->
<!--          <div class="card-header bg-warning text-dark bg-opacity-75 fw-bold"><i class="fas fa-microchip"></i> Panel OTA</div>-->
<!--          <div class="card-body">-->
<!--            <form onsubmit="handleOtaUpload(event)">-->
<!--              <input type="file" id="otaFile" class="form-control form-control-sm bg-dark text-light border-secondary mb-2" required>-->
<!--              <div class="row g-2">-->
<!--                <div class="col-4">-->
<!--                  <select id="otaTargetType" class="form-select form-select-sm bg-dark text-light border-secondary" onchange="toggleOtaTarget()">-->
<!--                    <option value="lamp">Lampa</option>-->
<!--                    <option value="fleet">Flota</option>-->
<!--                  </select>-->
<!--                </div>-->
<!--                <div class="col-8">-->
<!--                  <input type="text" id="otaTargetId" class="form-control form-control-sm bg-dark text-light border-secondary" placeholder="ID Lampy" required>-->
<!--                </div>-->
<!--              </div>-->
<!--              <button type="submit" class="btn btn-sm btn-outline-warning w-100 mt-2">Wyślij Update</button>-->
<!--            </form>-->
<!--          </div>-->
<!--        </div>-->
<!--      </div>-->
<!--    </div>-->

<!--    <div class="row g-4">-->
<!--      <div class="col-lg-8">-->
<!--        <h4 class="mb-3 border-bottom pb-2 border-secondary">Twoje Urządzenia</h4>-->
<!--        <div id="lamp-grid" class="row row-cols-1 row-cols-md-2 g-3"></div>-->
<!--      </div>-->

<!--      <div class="col-lg-4">-->
<!--        <div class="card mb-4">-->
<!--          <div class="card-header bg-primary text-white fw-bold"><i class="fas fa-layer-group"></i> Floty</div>-->
<!--          <div class="card-body">-->
<!--            <div class="input-group mb-3">-->
<!--              <input type="text" id="newFleetName" class="form-control form-control-sm" placeholder="Nazwa floty">-->
<!--              <button onclick="createFleet()" class="btn btn-sm btn-light"><i class="fas fa-plus"></i></button>-->
<!--            </div>-->
<!--            <ul class="list-group list-group-flush small" id="fleet-list"></ul>-->
<!--          </div>-->
<!--        </div>-->
<!--        <div class="text-center">-->
<!--          <button onclick="deleteAccount()" class="btn btn-sm btn-outline-danger w-100">Usuń Konto</button>-->
<!--        </div>-->
<!--      </div>-->
<!--    </div>-->
<!--  </div>-->

<!--  <div id="stats-view" style="display: none;">-->
<!--    <h3 class="mb-4 text-info"><i class="fas fa-chart-line"></i> Centrum Danych</h3>-->

<!--    <div id="admin-stats-panel" class="card mb-5 border-warning" style="display: none;">-->
<!--      <div class="card-header bg-warning text-dark fw-bold">Admin View</div>-->
<!--      <div class="card-body">-->
<!--        <div class="row text-center mb-4">-->
<!--          <div class="col-md-3"><h2 id="adm-users" class="text-warning fw-bold">0</h2><small>Użytkowników</small></div>-->
<!--          <div class="col-md-3"><h2 id="adm-lamps" class="text-light fw-bold">0</h2><small>Lamp</small></div>-->
<!--          <div class="col-md-3"><h2 id="adm-online" class="text-success fw-bold">0</h2><small>Online</small></div>-->
<!--          <div class="col-md-3"><h2 id="adm-temp" class="text-info fw-bold">0°C</h2><small>Śr. Temperatura</small></div>-->
<!--        </div>-->
<!--        <div class="row">-->
<!--          <div class="col-md-4"><div class="chart-box"><canvas id="adminStatusChart"></canvas></div></div>-->
<!--          <div class="col-md-4"><div class="chart-box"><canvas id="adminColorChart"></canvas></div></div>-->
<!--          <div class="col-md-4"><div class="chart-box"><canvas id="adminTempChart"></canvas></div></div>-->
<!--        </div>-->
<!--      </div>-->
<!--    </div>-->

<!--    <div class="card border-primary">-->
<!--      <div class="card-header bg-primary text-white fw-bold">Twoje Statystyki</div>-->
<!--      <div class="card-body">-->
<!--        <div class="row text-center mb-4">-->
<!--          <div class="col-3"><h3 id="my-lamps" class="text-primary fw-bold">0</h3><small>Lampy</small></div>-->
<!--          <div class="col-3"><h3 id="my-online" class="text-success fw-bold">0</h3><small>Włączone</small></div>-->
<!--          <div class="col-3"><h3 id="my-offline" class="text-secondary fw-bold">0</h3><small>Wyłączone</small></div>-->
<!--          <div class="col-3"><h3 id="my-temp" class="text-info fw-bold">0°C</h3><small>Śr. Temp</small></div>-->
<!--        </div>-->
<!--        <div class="row justify-content-center">-->
<!--          <div class="col-md-5"><h6 class="text-center text-muted">Kolory</h6><div class="chart-box"><canvas id="userColorChart"></canvas></div></div>-->
<!--          <div class="col-md-5"><h6 class="text-center text-muted">Temperatura</h6><div class="chart-box"><canvas id="userTempChart"></canvas></div></div>-->
<!--        </div>-->
<!--      </div>-->
<!--    </div>-->
<!--  </div>-->

<!--</main>-->

<!--<div class="modal fade" id="controlModal" tabindex="-1">-->
<!--  <div class="modal-dialog">-->
<!--    <div class="modal-content bg-dark text-white border-secondary">-->
<!--      <div class="modal-header border-secondary">-->
<!--        <h5 class="modal-title" id="modalTitle">Sterowanie</h5>-->
<!--        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>-->
<!--      </div>-->
<!--      <div class="modal-body">-->
<!--        <div class="alert alert-info py-2 small" id="targetInfo"></div>-->
<!--        <div class="d-flex justify-content-center gap-3 mb-4">-->
<!--          <button onclick="sendProtoCmd('ON')" class="btn btn-lg btn-success px-4">ON</button>-->
<!--          <button onclick="sendProtoCmd('OFF')" class="btn btn-lg btn-danger px-4">OFF</button>-->
<!--        </div>-->
<!--        <hr class="border-secondary">-->
<!--        <div class="mb-3">-->
<!--          <label class="form-label">Jasność (<span id="briVal">50</span>%)</label>-->
<!--          <input type="range" id="confBri" class="form-range" min="0" max="100" oninput="document.getElementById('briVal').innerText=this.value">-->
<!--        </div>-->
<!--        <div class="row mb-3">-->
<!--          <div class="col-6">-->
<!--            <label class="form-label">Kolor</label>-->
<!--            <input type="color" id="confCol" class="form-control form-control-color w-100 bg-secondary border-0" value="#ffffff">-->
<!--          </div>-->
<!--          <div class="col-6">-->
<!--            <label class="form-label">Interwał (s)</label>-->
<!--            <input type="number" id="confInt" class="form-control bg-secondary text-white border-0" value="60">-->
<!--          </div>-->
<!--        </div>-->
<!--        <button onclick="sendProtoConfig()" class="btn btn-primary w-100 mt-2">Wyślij Konfigurację</button>-->
<!--      </div>-->
<!--    </div>-->
<!--  </div>-->
<!--</div>-->

<!--<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>-->
<!--<script src="https://cdn.jsdelivr.net/npm/protobufjs@7.2.4/dist/protobuf.min.js"></script>-->

<!--<script>-->
<!--  const API = window.location.origin;-->
<!--  let token = localStorage.getItem('jwt');-->
<!--  let myFleets = [];-->
<!--  let charts = {};-->

<!--  // ZMIENNE DO STEROWANIA: type='lamp'|'fleet', id='...'-->
<!--  let currentTarget = { type: 'lamp', id: null };-->

<!--  // -&#45;&#45; PROTOBUF -&#45;&#45;-->
<!--  let LampCommand, LampConfig;-->
<!--  async function loadProtoDef() {-->
<!--    try {-->
<!--      let protoDef = `-->
<!--        syntax = "proto3"; package com.iot.backend.proto;-->
<!--        message LampCommand { enum Type { ON=0; OFF=1; REBOOT=2; OTA_UPDATE=3; } Type type=1; string ota_url=2; }-->
<!--        message LampConfig { int32 brightness=1; string color=2; int32 report_interval=3; }-->
<!--        message LampStatus { bool is_on=1; double sensor_value=2; }-->
<!--        message StatusReport { uint32 version=1; int64 ts=2; uint32 uptime_seconds=3; repeated double temperature_readings=4; }-->
<!--      `;-->
<!--      const root = protobuf.parse(protoDef).root;-->
<!--      LampCommand = root.lookupType("com.iot.backend.proto.LampCommand");-->
<!--      LampConfig = root.lookupType("com.iot.backend.proto.LampConfig");-->
<!--    } catch(e) { console.error("Proto error", e); }-->
<!--  }-->

<!--  (async function(){-->
<!--    await loadProtoDef();-->
<!--    if(token) init(); else showView('login');-->
<!--  })();-->

<!--  function showView(viewName) {-->
<!--    document.getElementById('login-view').style.display = 'none';-->
<!--    document.getElementById('register-view').style.display = 'none';-->
<!--    document.getElementById('dashboard-view').style.display = 'none';-->
<!--    document.getElementById('stats-view').style.display = 'none';-->
<!--    document.getElementById('navbar').style.display = 'none';-->
<!--    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));-->

<!--    if(viewName === 'login') document.getElementById('login-view').style.display = 'block';-->
<!--    if(viewName === 'register') document.getElementById('register-view').style.display = 'block';-->
<!--    if(viewName === 'dashboard') {-->
<!--      document.getElementById('dashboard-view').style.display = 'block';-->
<!--      document.getElementById('navbar').style.display = 'block';-->
<!--      document.querySelector('a[onclick="showView(\'dashboard\')"]').classList.add('active');-->
<!--    }-->
<!--    if(viewName === 'stats') {-->
<!--      document.getElementById('stats-view').style.display = 'block';-->
<!--      document.getElementById('navbar').style.display = 'block';-->
<!--      document.querySelector('a[onclick="showView(\'stats\')"]').classList.add('active');-->
<!--      loadStats();-->
<!--    }-->
<!--  }-->

<!--  // -&#45;&#45; AUTH -&#45;&#45;-->
<!--  async function handleLogin(e) {-->
<!--    e.preventDefault();-->
<!--    const u = document.getElementById('loginUser').value;-->
<!--    const p = document.getElementById('loginPass').value;-->
<!--    try {-->
<!--      const res = await fetch(`${API}/auth/login`, {-->
<!--        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({username: u, password: p})-->
<!--      });-->
<!--      if(!res.ok) throw new Error();-->
<!--      const data = await res.json();-->
<!--      token = data.accessToken;-->
<!--      localStorage.setItem('jwt', token);-->
<!--      localStorage.setItem('user', u);-->
<!--      init();-->
<!--    } catch(e) { alert('Błąd logowania'); }-->
<!--  }-->

<!--  async function handleRegister(e) {-->
<!--    e.preventDefault();-->
<!--    const u = document.getElementById('regUser').value;-->
<!--    const p = document.getElementById('regPass').value;-->
<!--    try {-->
<!--      const res = await fetch(`${API}/users`, {-->
<!--        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({username: u, password: p})-->
<!--      });-->
<!--      if(res.ok) { alert("Konto utworzone!"); showView('login'); }-->
<!--      else alert("Błąd rejestracji");-->
<!--    } catch(e) {}-->
<!--  }-->

<!--  function init() {-->
<!--    showView('dashboard');-->
<!--    document.getElementById('nav-username').innerText = localStorage.getItem('user');-->
<!--    refreshAll();-->
<!--  }-->

<!--  // -&#45;&#45; STATS -&#45;&#45;-->
<!--  async function loadStats() {-->
<!--    const user = localStorage.getItem('user');-->
<!--    // User stats-->
<!--    try {-->
<!--      const res = await authFetch(`${API}/stats/me`);-->
<!--      if(res) {-->
<!--        const data = await res.json();-->
<!--        document.getElementById('my-lamps').innerText = data.totalLamps;-->
<!--        document.getElementById('my-online').innerText = data.onlineLamps;-->
<!--        document.getElementById('my-offline').innerText = data.offlineLamps;-->
<!--        document.getElementById('my-temp').innerText = (data.averageTemperature || 0) + '°C';-->

<!--        renderChart('userColorChart', 'doughnut', Object.keys(data.colorDistribution), Object.values(data.colorDistribution), 'Kolory');-->

<!--        // Wykres temperatury (Słupkowy - pojedynczy słupek dla średniej)-->
<!--        renderChart('userTempChart', 'bar', ['Średnia Temp'], [data.averageTemperature], 'Temperatura °C', ['#36a2eb']);-->
<!--      }-->
<!--    } catch(e) {}-->

<!--    // Admin stats-->
<!--    if(user === 'admin') {-->
<!--      document.getElementById('admin-stats-panel').style.display = 'block';-->
<!--      try {-->
<!--        const res = await authFetch(`${API}/stats/global`);-->
<!--        if(res && res.ok) {-->
<!--          const data = await res.json();-->
<!--          document.getElementById('adm-users').innerText = data.totalUsers;-->
<!--          document.getElementById('adm-lamps').innerText = data.totalLamps;-->
<!--          document.getElementById('adm-online').innerText = data.onlineLamps;-->
<!--          document.getElementById('adm-temp').innerText = (data.averageTemperature || 0) + '°C';-->

<!--          renderChart('adminStatusChart', 'pie', ['Online', 'Offline'], [data.onlineLamps, data.offlineLamps], 'Status', ['#2ecc71', '#e74c3c']);-->
<!--          renderChart('adminColorChart', 'doughnut', Object.keys(data.colorDistribution), Object.values(data.colorDistribution), 'Kolory');-->
<!--          renderChart('adminTempChart', 'bar', ['Średnia Temp'], [data.averageTemperature], 'Temperatura °C', ['#ffcd56']);-->
<!--        }-->
<!--      } catch(e) {}-->
<!--    } else {-->
<!--      document.getElementById('admin-stats-panel').style.display = 'none';-->
<!--    }-->
<!--  }-->

<!--  function renderChart(canvasId, type, labels, dataArr, label, colors = null) {-->
<!--    const ctx = document.getElementById(canvasId).getContext('2d');-->
<!--    if(charts[canvasId]) charts[canvasId].destroy();-->

<!--    let bgColors = colors;-->
<!--    if(!bgColors) bgColors = labels.map(c => c.startsWith('#') ? c : '#3498db');-->

<!--    charts[canvasId] = new Chart(ctx, {-->
<!--      type: type,-->
<!--      data: {-->
<!--        labels: labels,-->
<!--        datasets: [{ label: label, data: dataArr, backgroundColor: bgColors, borderWidth: 0 }]-->
<!--      },-->
<!--      options: {-->
<!--        responsive: true, maintainAspectRatio: false,-->
<!--        plugins: { legend: { display: type!=='bar', labels: { color: '#ccc' } } },-->
<!--        scales: (type==='bar') ? { y: { beginAtZero: true, ticks:{color:'#ccc'} }, x:{ticks:{color:'#ccc'}} } : {}-->
<!--      }-->
<!--    });-->
<!--  }-->

<!--  // -&#45;&#45; CORE LOGIC -&#45;&#45;-->
<!--  async function refreshAll() { await loadFleets(); await loadLamps(); }-->

<!--  async function loadFleets() {-->
<!--    const res = await authFetch(`${API}/fleets`);-->
<!--    if(!res) return;-->
<!--    myFleets = await res.json();-->
<!--    const list = document.getElementById('fleet-list');-->
<!--    list.innerHTML = '';-->
<!--    myFleets.forEach(f => {-->
<!--      // DODAŁEM PRZYCISK "STERUJ" DLA FLOTY-->
<!--      list.innerHTML += `-->
<!--        <li class="list-group-item bg-dark text-white border-secondary d-flex justify-content-between align-items-center">-->
<!--            <div>-->
<!--              <span>${f.name}</span> <span class="badge bg-secondary ms-1">ID: ${f.id}</span>-->
<!--            </div>-->
<!--            <button onclick="openModal('fleet', ${f.id})" class="btn btn-sm btn-outline-info" title="Steruj całą grupą">-->
<!--               <i class="fas fa-sliders-h"></i>-->
<!--            </button>-->
<!--        </li>`;-->
<!--    });-->
<!--  }-->

<!--  async function loadLamps() {-->
<!--    const res = await authFetch(`${API}/users/me/lamps`);-->
<!--    if(!res) return;-->
<!--    let lamps = await res.json();-->

<!--    // -&#45;&#45; NOWE: SORTOWANIE -&#45;&#45;-->
<!--    // 1. Lampy bez floty (null) na górę.-->
<!--    // 2. Lampy z flotą rosnąco po ID floty.-->
<!--    // 3. Wewnątrz grupy sortujemy alfabetycznie po ID lampy.-->
<!--    lamps.sort((a, b) => {-->
<!--      const fA = a.fleetId;-->
<!--      const fB = b.fleetId;-->

<!--      // Jeśli oba nie mają floty -> sortuj po nazwie lampy-->
<!--      if (!fA && !fB) return a.id.localeCompare(b.id);-->

<!--      // Jeśli A nie ma floty -> A idzie na początek (-1)-->
<!--      if (!fA) return -1;-->

<!--      // Jeśli B nie ma floty -> B idzie na początek (1)-->
<!--      if (!fB) return 1;-->

<!--      // Jeśli oba mają floty -> sortuj po ID floty-->
<!--      if (fA !== fB) return fA - fB;-->

<!--      // Jeśli ta sama flota -> sortuj po nazwie lampy-->
<!--      return a.id.localeCompare(b.id);-->
<!--    });-->
<!--    // &#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;-->

<!--    const grid = document.getElementById('lamp-grid');-->
<!--    grid.innerHTML = '';-->

<!--    lamps.forEach(lamp => {-->
<!--      let optionsHtml = '<option value="" disabled selected>Flota...</option>';-->
<!--      myFleets.forEach(f => { optionsHtml += `<option value="${f.id}">${f.name}</option>`; });-->

<!--      let fleetSec = lamp.fleetId-->
<!--              ? `<div class="alert alert-dark border-secondary p-1 mb-2 d-flex justify-content-between align-items-center"><small class="text-info mx-2">Flota: ${lamp.fleetId}</small><button onclick="removeFromFleet(${lamp.fleetId}, '${lamp.id}')" class="btn btn-sm btn-outline-warning">X</button></div>`-->
<!--              : `<div class="input-group input-group-sm mb-2"><select id="sel-${lamp.id}" class="form-select bg-dark text-white border-secondary">${optionsHtml}</select><button onclick="assignToFleet('${lamp.id}')" class="btn btn-outline-secondary"><i class="fas fa-check"></i></button></div>`;-->

<!--      grid.innerHTML += `-->
<!--        <div class="col"><div class="card h-100"><div class="card-body">-->
<!--            <div class="d-flex justify-content-between align-items-center mb-3">-->
<!--                <h5 class="card-title m-0 text-truncate" title="${lamp.id}">${lamp.id}</h5>-->
<!--                <span class="status-dot ${lamp.on ? 'status-on':'status-off'}"></span>-->
<!--            </div>-->
<!--            ${fleetSec}-->
<!--            <div class="d-grid gap-2 d-flex">-->
<!--                <button onclick="openModal('lamp', '${lamp.id}')" class="btn btn-sm btn-primary flex-grow-1">Steruj</button>-->
<!--                <button onclick="delLamp('${lamp.id}')" class="btn btn-sm btn-danger"><i class="fas fa-trash"></i></button>-->
<!--            </div>-->
<!--        </div></div></div>`;-->
<!--    });-->
<!--  }-->

<!--  // -&#45;&#45; CONTROL MODAL -&#45;&#45;-->
<!--  async function openModal(type, id) {-->
<!--    currentTarget = { type: type, id: id };-->
<!--    const title = (type === 'lamp') ? `Lampa: ${id}` : `Flota: ${id} (Wszystkie)`;-->
<!--    document.getElementById('modalTitle').innerText = title;-->
<!--    document.getElementById('targetInfo').innerText = (type==='fleet')-->
<!--            ? "Zmiany zostaną wysłane do wszystkich lamp w tej flocie."-->
<!--            : "Sterujesz pojedynczym urządzeniem. Wartości wczytane z bazy.";-->

<!--    // Reset formularza do wartości domyślnych (na wypadek błędu ładowania)-->
<!--    document.getElementById('confBri').value = 50;-->
<!--    document.getElementById('briVal').innerText = "50";-->
<!--    document.getElementById('confCol').value = "#ffffff";-->
<!--    document.getElementById('confInt').value = 60;-->

<!--    // Jeśli to pojedyncza lampa, pobieramy jej aktualny config z bazy-->
<!--    if(type === 'lamp') {-->
<!--      try {-->
<!--        const res = await fetch(`${API}/lamps/${id}/config`, {-->
<!--          headers: { 'Authorization': `Bearer ${token}` }-->
<!--        });-->

<!--        if(res.ok) {-->
<!--          const buffer = await res.arrayBuffer();-->
<!--          // Dekodowanie Protobuf-->
<!--          const decoded = LampConfig.decode(new Uint8Array(buffer));-->

<!--          // -&#45;&#45; TUTAJ AKTUALIZUJEMY UI WARTOŚCIAMI Z BAZY -&#45;&#45;-->
<!--          // Jasność-->
<!--          const bri = decoded.brightness !== undefined ? decoded.brightness : 50;-->
<!--          document.getElementById('confBri').value = bri;-->
<!--          document.getElementById('briVal').innerText = bri; // Aktualizacja etykiety tekstowej!-->

<!--          // Kolor-->
<!--          const col = decoded.color || "#ffffff";-->
<!--          document.getElementById('confCol').value = col;-->

<!--          // Interwał-->
<!--          const interval = decoded.report_interval !== undefined ? decoded.report_interval : 60;-->
<!--          document.getElementById('confInt').value = interval;-->
<!--        }-->
<!--      } catch(e) {-->
<!--        console.error("Błąd pobierania configu lampy:", e);-->
<!--      }-->
<!--    }-->
<!--    // Dla floty (type === 'fleet') zostawiamy wartości domyślne,-->
<!--    // ponieważ flota może mieć lampy o różnych ustawieniach, więc nie ma jednego "wspólnego" stanu do wyświetlenia.-->

<!--    new bootstrap.Modal(document.getElementById('controlModal')).show();-->
<!--  }-->

<!--  async function sendProtoCmd(typeStr) {-->
<!--    const payload = { type: (typeStr==='ON'?0:1) };-->
<!--    const buf = LampCommand.encode(LampCommand.create(payload)).finish();-->

<!--    // WYBÓR URL W ZALEŻNOŚCI OD TYPU-->
<!--    let url = (currentTarget.type === 'lamp')-->
<!--            ? `${API}/lamps/${currentTarget.id}/command`-->
<!--            : `${API}/fleets/${currentTarget.id}/command`;-->

<!--    await sendBin(url, buf);-->
<!--    if(currentTarget.type === 'lamp') setTimeout(loadLamps, 1000);-->
<!--  }-->

<!--  async function sendProtoConfig() {-->
<!--    const payload = {-->
<!--      brightness: parseInt(document.getElementById('confBri').value),-->
<!--      color: document.getElementById('confCol').value,-->
<!--      report_interval: parseInt(document.getElementById('confInt').value)-->
<!--    };-->
<!--    const buf = LampConfig.encode(LampConfig.create(payload)).finish();-->

<!--    // WYBÓR URL W ZALEŻNOŚCI OD TYPU-->
<!--    let url = (currentTarget.type === 'lamp')-->
<!--            ? `${API}/lamps/${currentTarget.id}/config`-->
<!--            : `${API}/fleets/${currentTarget.id}/config`;-->

<!--    await sendBin(url, buf, 'PUT');-->
<!--    alert('Wysłano');-->

<!--    // -&#45;&#45; NOWE: ODŚWIEŻ WIDOK LAMP -&#45;&#45;-->
<!--    // Czekamy chwilę (500ms), żeby baza zdążyła się zapisać, a potem przeładowujemy siatkę lamp-->
<!--    setTimeout(loadLamps, 500);-->
<!--  }-->

<!--  // -&#45;&#45; ACTIONS -&#45;&#45;-->
<!--  async function createFleet() {-->
<!--    const name = document.getElementById('newFleetName').value;-->
<!--    if(!name) return;-->
<!--    await authFetch(`${API}/fleets`, { method: 'POST', body: JSON.stringify({name}) });-->
<!--    document.getElementById('newFleetName').value=''; refreshAll();-->
<!--  }-->
<!--  async function addLamp() {-->
<!--    const id = document.getElementById('newLampId').value;-->
<!--    if(!id) return;-->

<!--    const res = await authFetch(`${API}/users/me/lamps`, {-->
<!--      method:'POST',-->
<!--      body: JSON.stringify({lampId: id})-->
<!--    });-->

<!--    if(res && res.ok) {-->
<!--      const data = await res.json();-->
<!--      // Wyświetl token użytkownikowi-->
<!--      alert("Lampa dodana! \nTwój UNIKALNY TOKEN urządzenia to:\n\n" + data.device_token + "\n\nZapisz go w kodzie ESP32, nie zobaczysz go ponownie!");-->

<!--      document.getElementById('newLampId').value='';-->
<!--      loadLamps();-->
<!--    }-->
<!--  }-->
<!--  async function delLamp(id) { if(confirm('Usunąć?')) { await authFetch(`${API}/users/me/lamps/${id}`, {method:'DELETE'}); loadLamps(); } }-->
<!--  async function assignToFleet(lId) {-->
<!--    const fId = document.getElementById(`sel-${lId}`).value;-->
<!--    if(!fId) return;-->
<!--    await authFetch(`${API}/fleets/${fId}/lamps/${lId}`, { method: 'POST' });-->
<!--    loadLamps();-->
<!--  }-->
<!--  async function removeFromFleet(fId, lId) {-->
<!--    if(confirm('Odpiąć?')) { await authFetch(`${API}/fleets/${fId}/lamps/${lId}`, { method: 'DELETE' }); loadLamps(); }-->
<!--  }-->

<!--  // -&#45;&#45; UTILS -&#45;&#45;-->
<!--  async function handleOtaUpload(e) {-->
<!--    e.preventDefault();-->

<!--    // 1. Pobierz dane z formularza-->
<!--    const targetType = document.getElementById('otaTargetType').value; // 'lamp' lub 'fleet'-->
<!--    const targetId = document.getElementById('otaTargetId').value;-->
<!--    const fileInput = document.getElementById('otaFile');-->

<!--    // UWAGA: Twój obecny backend (LampCommand proto) przyjmuje 'ota_url' (String).-->
<!--    // Jeśli nie masz serwera plików, musisz tu wpisać URL ręcznie zamiast uploadować plik.-->
<!--    // Zakładając, że pole input type="file" służy tylko do symulacji, a backend chce URL:-->

<!--    const firmwareUrl = "http://http://srv38.mikr.us:40142/firmware.bin"; // Tutaj logika uploadu lub wpisania URL-->

<!--    // Budowanie komendy Proto (Type = OTA_UPDATE = 3)-->
<!--    // Musisz sprawdzić w .proto jaki numer ma OTA_UPDATE (w kodzie wyżej: ON=0, OFF=1, REBOOT=2, OTA=3)-->
<!--    const payload = {-->
<!--      type: 3,-->
<!--      ota_url: firmwareUrl-->
<!--    };-->

<!--    const buf = LampCommand.encode(LampCommand.create(payload)).finish();-->

<!--    // Wybór endpointu (lamps vs fleets)-->
<!--    let url = (targetType === 'lamp')-->
<!--            ? `${API}/lamps/${targetId}/command`-->
<!--            : `${API}/fleets/${targetId}/command`;-->

<!--    await sendBin(url, buf);-->
<!--    alert('Rozkaz aktualizacji wysłany!');-->
<!--  }-->
<!--  function toggleOtaTarget() { /* ... */ }-->
<!--  async function authFetch(url, opts={}) {-->
<!--    opts.headers = opts.headers || {};-->
<!--    opts.headers['Authorization'] = `Bearer ${token}`;-->
<!--    if(opts.body && !opts.headers['Content-Type']) opts.headers['Content-Type']='application/json';-->
<!--    const res = await fetch(url, opts);-->
<!--    if(res.status === 401) {-->
<!--      logout();-->
<!--      return null;-->
<!--    }-->

<!--    // Opcjonalnie: Możesz tu obsłużyć 403 alertem, zamiast wylogowaniem-->
<!--    if(res.status === 403) {-->
<!--      console.warn("Brak uprawnień do tego zasobu (403)");-->
<!--      // Nie wylogowujemy! Zwracamy response, żeby funkcja wywołująca mogła obsłużyć błąd-->
<!--    }-->
<!--    return res;-->
<!--  }-->
<!--  async function sendBin(url, body, method='POST') {-->
<!--    const res = await fetch(url, { method: method, headers: {'Authorization':`Bearer ${token}`, 'Content-Type':'application/x-protobuf'}, body: body });-->
<!--    if(!res.ok) alert('Błąd wysyłania');-->
<!--  }-->
<!--  function logout() { localStorage.removeItem('jwt'); location.reload(); }-->
<!--  function deleteAccount() { if(confirm('Usunąć konto?')) { authFetch(`${API}/users/me`, {method:'DELETE'}); logout(); } }-->
<!--</script>-->
<!--</body>-->
<!--</html>-->