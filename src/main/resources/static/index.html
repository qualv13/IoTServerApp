<!DOCTYPE html>
<html lang="pl" data-bs-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IoT Lamp Management System</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/protobufjs@7.2.4/dist/protobuf.min.js"></script>

  <style>
    :root {
      --primary: #0d6efd;
      --success: #198754;
      --danger: #dc3545;
      --warning: #ffc107;
      --info: #0dcaf0;
      --dark-bg: #1a1d24;
      --card-bg: #252932;
      --border: #3a3f4b;
    }

    body {
      background: linear-gradient(135deg, #1a1d24 0%, #2d3138 100%);
      color: #e9ecef;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      min-height: 100vh;
    }

    .navbar {
      background: rgba(26, 29, 36, 0.95) !important;
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }

    .card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 25px rgba(0,0,0,0.4);
    }

    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 8px;
    }

    /* Animacja tylko dla statusu ONLINE */
    .status-online { background: var(--success); box-shadow: 0 0 10px var(--success); animation: pulse 2s infinite; }
    .status-offline { background: var(--danger); opacity: 0.6; }

    .status-on { background: var(--info); box-shadow: 0 0 10px var(--info); }
    .status-off { background: #6c757d; opacity: 0.6; }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .lamp-card {
      cursor: pointer;
      transition: all 0.3s;
    }

    /* Jeśli lampa offline, wyszarzamy kafelek */
    .lamp-card.is-offline {
      opacity: 0.6;
      border-color: var(--danger) !important;
    }

    .lamp-card:hover {
      border-color: var(--info) !important;
    }

    .chart-container {
      position: relative;
      height: 300px;
      margin-top: 20px;
    }

    .kpi-card {
      text-align: center;
      padding: 20px;
    }

    .kpi-value {
      font-size: 2.5rem;
      font-weight: bold;
      margin: 10px 0;
    }

    .kpi-label {
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      opacity: 0.7;
    }

    .btn-modern {
      border-radius: 8px;
      padding: 10px 20px;
      font-weight: 500;
      transition: all 0.3s;
    }

    .btn-modern:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    .modal-content {
      background: var(--card-bg);
      border: 1px solid var(--border);
    }

    .form-control, .form-select {
      background: var(--dark-bg);
      border: 1px solid var(--border);
      color: #e9ecef;
    }

    .form-control:focus, .form-select:focus {
      background: var(--dark-bg);
      border-color: var(--info);
      color: #e9ecef;
      box-shadow: 0 0 0 0.2rem rgba(13, 202, 240, 0.25);
    }

    .loader {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      flex-direction: column;
    }

    .spinner-border {
      width: 3rem;
      height: 3rem;
    }

    .lamp-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
    }

    .auth-fullscreen {
      min-height: calc(100vh - 80px);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .lamp-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }

    .detail-item {
      padding: 15px;
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      border-left: 3px solid var(--info);
    }

    .detail-label {
      font-size: 0.85rem;
      opacity: 0.7;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .detail-value {
      font-size: 1.2rem;
      font-weight: 600;
      margin-top: 5px;
    }

    .color-preview {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      border: 2px solid var(--border);
      display: inline-block;
      vertical-align: middle;
      margin-left: 10px;
    }
  </style>
</head>
<body>

<div id="loader" class="loader" style="display: none;">
  <div class="spinner-border text-info" role="status"></div>
  <div class="mt-3">Ładowanie...</div>
</div>

<nav id="mainNavbar" class="navbar navbar-expand-lg navbar-dark sticky-top" style="display: none;">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold" href="#">
      <i class="fas fa-lightbulb text-info me-2"></i>IoT Lamp Manager
    </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav me-auto">
        <li class="nav-item">
          <a class="nav-link active" href="#" onclick="showView('dashboard'); return false;">
            <i class="fas fa-home me-1"></i> Pulpit
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#" onclick="showView('stats'); return false;">
            <i class="fas fa-chart-bar me-1"></i> Statystyki
          </a>
        </li>
        <li class="nav-item" id="adminNav" style="display: none;">
          <a class="nav-link" href="#" onclick="showView('admin'); return false;">
            <i class="fas fa-cog me-1"></i> Admin
          </a>
        </li>
      </ul>
      <div class="d-flex align-items-center">
        <span class="me-3"><i class="fas fa-user-circle me-2"></i><span id="username">Użytkownik</span></span>
        <button class="btn btn-outline-light btn-sm" onclick="logout()">
          <i class="fas fa-sign-out-alt me-1"></i> Wyloguj
        </button>
      </div>
    </div>
  </div>
</nav>

<main class="container-fluid py-4">

  <div id="loginView" class="row justify-content-center auth-fullscreen">
    <div class="col-md-4">
      <div class="card">
        <div class="card-body p-4">
          <div class="text-center mb-4">
            <i class="fas fa-user-shield fa-3x text-info mb-3"></i>
            <h3>Logowanie</h3>
          </div>
          <form onsubmit="handleLogin(event)">
            <div class="mb-3">
              <label class="form-label">Login</label>
              <input type="text" id="loginUsername" class="form-control" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Hasło</label>
              <input type="password" id="loginPassword" class="form-control" required>
            </div>
            <button type="submit" class="btn btn-info btn-modern w-100">
              <i class="fas fa-sign-in-alt me-2"></i>Zaloguj
            </button>
          </form>
          <div class="text-center mt-3">
            <small class="text-muted">Nie masz konta? <a href="#" onclick="showRegister(); return false;">Zarejestruj się</a></small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="registerView" class="row justify-content-center auth-fullscreen" style="display: none;">
    <div class="col-md-4">
      <div class="card">
        <div class="card-body p-4">
          <div class="text-center mb-4">
            <i class="fas fa-user-plus fa-3x text-info mb-3"></i>
            <h3>Rejestracja</h3>
          </div>
          <form onsubmit="handleRegister(event)">
            <div class="mb-3">
              <label class="form-label">Login</label>
              <input type="text" id="registerUsername" class="form-control" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Hasło</label>
              <input type="password" id="registerPassword" class="form-control" required>
            </div>
            <button type="submit" class="btn btn-info btn-modern w-100">
              <i class="fas fa-user-plus me-2"></i>Zarejestruj
            </button>
          </form>
          <div class="text-center mt-3">
            <small class="text-muted">Masz już konto? <a href="#" onclick="showLogin(); return false;">Zaloguj się</a></small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="dashboardView" style="display: none;">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2><i class="fas fa-lightbulb me-2 text-info"></i>Moje Lampy</h2>
      <button class="btn btn-info btn-modern" onclick="refreshLamps()">
        <i class="fas fa-sync-alt me-2"></i>Odśwież
      </button>
    </div>
    <div id="lampsContainer" class="lamp-grid"></div>
  </div>

  <div id="statsView" style="display: none;">
    <h2 class="mb-4"><i class="fas fa-chart-bar me-2 text-info"></i>Statystyki</h2>
    <div class="row mb-4">
      <div class="col-md-3">
        <div class="card kpi-card">
          <div class="kpi-label">Łącznie urządzeń</div>
          <div class="kpi-value text-info" id="statTotal">0</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card kpi-card">
          <div class="kpi-label">Online</div>
          <div class="kpi-value text-success" id="statOnline">0</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card kpi-card">
          <div class="kpi-label">Średnia temperatura</div>
          <div class="kpi-value text-warning" id="statTemp">0°C</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card kpi-card">
          <div class="kpi-label">Zużycie mocy</div>
          <div class="kpi-value text-danger" id="statPower">0 W</div>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-md-6">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Rozkład kolorów</h5>
            <canvas id="chartColors"></canvas>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Historia temperatury</h5>
            <canvas id="chartHistory"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="adminView" style="display: none;">
    <h2 class="mb-4"><i class="fas fa-cog me-2 text-info"></i>Panel Administracyjny</h2>

    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-cloud-download-alt me-2"></i>OTA Update</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <label class="form-label">Lampa ID</label>
            <input type="text" id="otaLampId" class="form-control mb-3" placeholder="np. LAMP001">
            <label class="form-label">URL aktualizacji</label>
            <input type="url" id="otaUrl" class="form-control mb-3" placeholder="https://example.com/firmware.bin">
            <div class="d-flex gap-2 flex-wrap">
              <button class="btn btn-warning btn-modern" onclick="sendOtaUpdate()">
                <i class="fas fa-paper-plane me-2"></i>Wyślij OTA do lampy
              </button>
              <button class="btn btn-danger btn-modern" onclick="sendOtaUpdateAll()">
                <i class="fas fa-broadcast-tower me-2"></i>Wyślij OTA do wszystkich lamp
              </button>
            </div>
          </div>
          <div class="col-md-6">
            <div class="alert alert-info">
              <i class="fas fa-info-circle me-2"></i>
              <strong>Uwaga:</strong> Aktualizacja OTA jest dostępna tylko dla administratorów.
              Upewnij się, że URL wskazuje na prawidłowy plik firmware.
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Zaawansowane statystyki</h5>
      </div>
      <div class="card-body">
        <div id="adminStatsContainer"></div>
      </div>
    </div>
  </div>

</main>

<div class="modal fade" id="lampModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-lightbulb me-2"></i>Szczegóły lampy</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="lampDetailsContent"></div>

        <hr class="border-secondary my-4">
        <h5 class="mb-3 text-info"><i class="fas fa-gamepad me-2"></i>Sterowanie</h5>
        <div class="d-flex gap-3 justify-content-center mb-4">
          <button onclick="sendCommandToCurrent('ON')" class="btn btn-lg btn-success px-4">
            <i class="fas fa-power-off me-2"></i>WŁĄCZ
          </button>
          <button onclick="sendCommandToCurrent('OFF')" class="btn btn-lg btn-danger px-4">
            <i class="fas fa-power-off me-2"></i>WYŁĄCZ
          </button>
        </div>

        <div class="chart-container">
          <canvas id="lampChart"></canvas>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zamknij</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const API_BASE = window.location.origin;
  let accessToken = localStorage.getItem('accessToken');
  let refreshToken = localStorage.getItem('refreshToken');
  let currentUser = null;
  let isAdmin = false;
  let lampCharts = {};
  let refreshInterval = null;

  // PROTOBUF & CONTROLS
  let LampCommand;
  let currentModalLampId = null;

  async function loadProtoDef() {
    try {
      if (typeof protobuf === 'undefined') { console.error("Brak protobuf.js"); return; }
      // Prosta definicja potrzebna tylko do komend
      let protoDef = `syntax = "proto3"; message DirectSettings { uint32 red=1; uint32 green=2; uint32 blue=3; uint32 warm_white=6; } message SetDirectSettingsCommand { DirectSettings direct_settings=1; } message DownloadOtaUpdateCommand { string ota_url=1; } message LampCommand { uint32 version=1; int64 ts=2; oneof command { SetDirectSettingsCommand set_direct_settings_command=5; DownloadOtaUpdateCommand download_ota_update_command=10; } }`;
      const root = protobuf.parse(protoDef).root;
      LampCommand = root.lookupType("LampCommand");
      console.log("Protobuf załadowany.");
    } catch(e) { console.error("Proto error", e); }
  }

  // Initialize
  document.addEventListener('DOMContentLoaded', async () => {
    await loadProtoDef();
    if (accessToken) {
      checkAuth();
    } else {
      showLogin();
    }
  });

  async function checkAuth() {
    if (!accessToken) {
      showLogin();
      return;
    }

    try {
      const response = await fetch(`${API_BASE}/users/me`, {
        headers: { 'Authorization': `Bearer ${accessToken}` }
      });
      if (response.ok) {
        currentUser = await response.json();
        isAdmin = currentUser.username === 'admin';
        document.getElementById('username').textContent = currentUser.username;

        document.getElementById('mainNavbar').style.display = 'block';
        document.getElementById('loginView').style.display = 'none';
        document.getElementById('registerView').style.display = 'none';

        if (isAdmin) {
          document.getElementById('adminNav').style.display = 'block';
        } else {
          document.getElementById('adminNav').style.display = 'none';
        }

        showView('dashboard');
        //loadDashboard();
      } else {
        throw new Error('Auth failed');
      }
    } catch (error) {
      console.error('Auth check failed:', error);
      showLogin();
    }
  }

  async function handleLogin(e) {
    e.preventDefault();
    const username = document.getElementById('loginUsername').value;
    const password = document.getElementById('loginPassword').value;

    showLoader();
    try {
      const response = await fetch(`${API_BASE}/auth/login`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      });

      if (response.ok) {
        const data = await response.json();
        accessToken = data.accessToken;
        refreshToken = data.refreshToken;
        localStorage.setItem('accessToken', accessToken);
        localStorage.setItem('refreshToken', refreshToken);

        document.getElementById('loginUsername').value = '';
        document.getElementById('loginPassword').value = '';

        await checkAuth();
      } else {
        const errorData = await response.json().catch(() => ({}));
        alert(errorData.message || 'Błąd logowania. Sprawdź dane logowania.');
      }
    } catch (error) {
      alert('Błąd połączenia');
    } finally {
      hideLoader();
    }
  }

  async function handleRegister(e) {
    e.preventDefault();
    const username = document.getElementById('registerUsername').value;
    const password = document.getElementById('registerPassword').value;

    showLoader();
    try {
      const response = await fetch(`${API_BASE}/users`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      });

      if (response.ok) {
        alert('Rejestracja pomyślna! Zaloguj się.');
        showLogin();
      } else {
        const data = await response.json();
        alert(data.message || 'Błąd rejestracji');
      }
    } catch (error) {
      alert('Błąd połączenia');
    } finally {
      hideLoader();
    }
  }

  function showLogin() {
    document.getElementById('mainNavbar').style.display = 'none';
    document.getElementById('dashboardView').style.display = 'none';
    document.getElementById('statsView').style.display = 'none';
    document.getElementById('adminView').style.display = 'none';
    document.getElementById('loginView').style.display = 'block';
    document.getElementById('registerView').style.display = 'none';
    document.getElementById('loginUsername').value = '';
    document.getElementById('loginPassword').value = '';
  }

  function showRegister() {
    document.getElementById('mainNavbar').style.display = 'none';
    document.getElementById('dashboardView').style.display = 'none';
    document.getElementById('statsView').style.display = 'none';
    document.getElementById('adminView').style.display = 'none';
    document.getElementById('loginView').style.display = 'none';
    document.getElementById('registerView').style.display = 'block';
    document.getElementById('registerUsername').value = '';
    document.getElementById('registerPassword').value = '';
  }

  function showView(view) {
    if (!accessToken || !currentUser) {
      showLogin();
      return;
    }

    document.getElementById('loginView').style.display = 'none';
    document.getElementById('registerView').style.display = 'none';
    document.getElementById('dashboardView').style.display = 'none';
    document.getElementById('statsView').style.display = 'none';
    document.getElementById('adminView').style.display = 'none';

    document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
    const activeLink = document.querySelector(`[onclick*="showView('${view}')"]`);
    if (activeLink) {
      activeLink.classList.add('active');
    }

    if (view === 'dashboard') {
      document.getElementById('dashboardView').style.display = 'block';
      loadDashboard();
    } else if (view === 'stats') {
      document.getElementById('statsView').style.display = 'block';
      loadStats();
    } else if (view === 'admin') {
      if (!isAdmin) {
        showView('dashboard');
        return;
      }
      document.getElementById('adminView').style.display = 'block';
      loadAdminStats();
    }
  }

  async function loadDashboard() {
    // showLoader(); // Opcjonalnie wyłączamy, żeby nie migało przy auto-refresh
    try {
      const response = await authFetch(`${API_BASE}/users/me/lamps`);
      if (response.ok) {
        const lamps = await response.json();
        renderLamps(lamps);
        startAutoRefresh();
      }
    } catch (error) {
      console.error('Error loading lamps:', error);
    } finally {
      hideLoader();
    }
  }

  async function renderLamps(lamps) {
    const container = document.getElementById('lampsContainer');
    container.innerHTML = '';

    for (const lamp of lamps) {
      const lampDetails = await getLampDetails(lamp.id);
      const card = createLampCard(lamp, lampDetails);
      container.appendChild(card);
    }
  }

  async function getLampDetails(lampId) {
    try {
      const response = await authFetch(`${API_BASE}/lamps/${lampId}/details`);
      if (response.ok) {
        return await response.json();
      }
    } catch (error) {
      console.error('Error loading lamp details:', error);
    }
    return null;
  }

  function createLampCard(lamp, details) {
    const card = document.createElement('div');

    // LOGIKA NAPRAWCZA: Lampa jest "ON" tylko jeśli (online == true) ORAZ (on == true)
    const isOnline = details?.isOnline || false;
    const rawIsOn = details?.isOn || false;
    const effectiveIsOn = isOnline && rawIsOn;

    // Styl kafelka zależy od online
    card.className = `card lamp-card ${isOnline ? '' : 'is-offline'}`;
    card.onclick = () => showLampModal(lamp.id, details);

    const onlineStatus = isOnline ? 'online' : 'offline';
    // Status wizualny (on/off)
    const onStatus = effectiveIsOn ? 'on' : 'off';
    const onBadgeColor = effectiveIsOn ? 'info' : 'secondary';
    const onText = effectiveIsOn ? 'ON' : 'OFF';

    card.innerHTML = `
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start mb-3">
          <div>
            <h5 class="card-title mb-1">
              <span class="status-indicator status-${onlineStatus}"></span>
              ${details?.deviceName || lamp.id}
            </h5>
            <small class="text-muted">ID: ${lamp.id}</small>
          </div>
          <span class="badge bg-${onBadgeColor}">
            <span class="status-indicator status-${onStatus}"></span>
            ${onText}
          </span>
        </div>

        <div class="lamp-details">
          <div class="detail-item">
            <div class="detail-label">Temperatura</div>
            <div class="detail-value">${details?.currentTemperature?.toFixed(1) || 'N/A'}°C</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Jasność</div>
            <div class="detail-value">${details?.brightness || 0}%</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Firmware</div>
            <div class="detail-value">${details?.firmwareVersion || 'N/A'}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Kolor</div>
            <div class="detail-value">
              ${details?.color || '#ffffff'}
              <span class="color-preview" style="background-color: ${details?.color || '#ffffff'}"></span>
            </div>
          </div>
        </div>

        <div class="mt-3" style="height: 150px;">
          <canvas id="chart-${lamp.id}"></canvas>
        </div>
      </div>
    `;

    // Render chart for this lamp
    setTimeout(() => {
      renderLampChart(lamp.id);
    }, 100);

    return card;
  }

  async function renderLampChart(lampId) {
    try {
      const response = await authFetch(`${API_BASE}/stats/lamps/${lampId}/history`);
      if (response.ok) {
        const data = await response.json();
        const canvas = document.getElementById(`chart-${lampId}`);
        if (!canvas) return;

        const ctx = canvas.getContext('2d');
        if (lampCharts[lampId]) {
          lampCharts[lampId].destroy();
        }

        lampCharts[lampId] = new Chart(ctx, {
          type: 'line',
          data: {
            labels: data.labels || [],
            datasets: [{
              label: 'Temperatura (°C)',
              data: data.temperatures || [],
              borderColor: '#0dcaf0',
              backgroundColor: 'rgba(13, 202, 240, 0.1)',
              tension: 0.4,
              fill: true
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false }
            },
            scales: {
              y: {
                ticks: { color: '#999' },
                grid: { color: 'rgba(255,255,255,0.1)' }
              },
              x: {
                ticks: { color: '#999' },
                grid: { color: 'rgba(255,255,255,0.1)' }
              }
            }
          }
        });
      }
    } catch (error) {
      console.error('Error loading chart data:', error);
    }
  }

  async function showLampModal(lampId, details) {
    currentModalLampId = lampId; // Zapisz ID do sterowania
    const modal = new bootstrap.Modal(document.getElementById('lampModal'));
    const content = document.getElementById('lampDetailsContent');

    const isOnline = details?.isOnline || false;
    const effectiveIsOn = isOnline && (details?.isOn || false);

    content.innerHTML = `
      <div class="lamp-details">
        <div class="detail-item">
          <div class="detail-label">ID Lampy</div>
          <div class="detail-value">${details?.id || lampId}</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Nazwa</div>
          <!-- <div class="detail-value">${details?.deviceName || 'N/A'}</div> -->
          <div class="input-group mt-2">
            <input type="text" id="editLampName" class="form-control" value="${deviceName}">
            <button class="btn btn-outline-info" onclick="saveLampName('${lampId}')">
                <i class="fas fa-save"></i> Zapisz
            </button>
          </div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Status</div>
          <div class="detail-value">
            <span class="status-indicator status-${isOnline ? 'online' : 'offline'}"></span>
            ${isOnline ? 'Online' : 'Offline'}
          </div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Włączona</div>
          <div class="detail-value">
            <span class="status-indicator status-${effectiveIsOn ? 'on' : 'off'}"></span>
            ${effectiveIsOn ? 'Tak' : 'Nie'}
          </div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Temperatura</div>
          <div class="detail-value">${details?.currentTemperature?.toFixed(1) || 'N/A'}°C</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Jasność</div>
          <div class="detail-value">${details?.brightness || 0}%</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Kolor</div>
          <div class="detail-value">
            ${details?.color || '#ffffff'}
            <span class="color-preview" style="background-color: ${details?.color || '#ffffff'}"></span>
          </div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Uptime</div>
          <div class="detail-value">${formatUptime(details?.uptimeSeconds || 0)}</div>
        </div>
      </div>
    `;

    // Load chart data
    setTimeout(() => {
      loadLampModalChart(lampId);
    }, 100);

    modal.show();
  }

  async function saveLampName(lampId) {
    const newName = document.getElementById('editLampName').value;
    if(!newName) return;

    try {
      const res = await authFetch(`${API_BASE}/lamps/${lampId}/name`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: newName })
      });

      if(res.ok) {
        alert('Nazwa zmieniona!');
        loadDashboard(); // Odśwież kafelki na pulpicie
        // Opcjonalnie zamknij modal:
        // bootstrap.Modal.getInstance(document.getElementById('lampModal')).hide();
      } else {
        alert('Błąd zmiany nazwy');
      }
    } catch(e) {
      console.error(e);
      alert('Błąd połączenia');
    }
  }

  // --- STEROWANIE ---
  async function sendCommandToCurrent(type) {
    if(!currentModalLampId) return;
    if(!LampCommand) { alert("Protobuf nie gotowy"); return; }

    let m={version:1,ts:Math.floor(Date.now()/1000)};
    let ds={red:0,green:0,blue:0,warmWhite:0};

    if(type === 'ON') {
      // Biały
      ds = {red:0,green:0,blue:0,warmWhite:255};
    }
    // Dla OFF wysyłamy same zera

    m.setDirectSettingsCommand = { directSettings: ds };

    try {
      const buffer = LampCommand.encode(LampCommand.create(m)).finish();
      const res = await fetch(`${API_BASE}/lamps/${currentModalLampId}/command`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${accessToken}`,
          'Content-Type': 'application/x-protobuf'
        },
        body: buffer
      });

      if(res.ok) {
        // alert('Wysłano: ' + type);
        // Odśwież po chwili
        setTimeout(() => {
          loadDashboard();
          // Zamknij modal (opcjonalne)
          // bootstrap.Modal.getInstance(document.getElementById('lampModal')).hide();
        }, 1000);
      } else {
        alert('Błąd wysyłania komendy');
      }
    } catch(e) {
      console.error(e);
      alert('Błąd sieci');
    }
  }

  async function loadLampModalChart(lampId) {
    try {
      const response = await authFetch(`${API_BASE}/stats/lamps/${lampId}/history`);
      if (response.ok) {
        const data = await response.json();
        const canvas = document.getElementById('lampChart');
        const ctx = canvas.getContext('2d');

        if (window.lampModalChart) {
          window.lampModalChart.destroy();
        }

        window.lampModalChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: data.labels || [],
            datasets: [{
              label: 'Temperatura (°C)',
              data: data.temperatures || [],
              borderColor: '#0dcaf0',
              backgroundColor: 'rgba(13, 202, 240, 0.1)',
              tension: 0.4,
              fill: true
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { labels: { color: '#e9ecef' } }
            },
            scales: {
              y: {
                ticks: { color: '#999' },
                grid: { color: 'rgba(255,255,255,0.1)' }
              },
              x: {
                ticks: { color: '#999' },
                grid: { color: 'rgba(255,255,255,0.1)' }
              }
            }
          }
        });
      }
    } catch (error) {
      console.error('Error loading modal chart:', error);
    }
  }

  async function loadStats() {
    try {
      const endpoint = isAdmin ? '/stats/global' : '/stats/me';
      const response = await authFetch(`${API_BASE}${endpoint}`);
      if (response.ok) {
        const stats = await response.json();
        renderStats(stats);
      }
    } catch (error) {
      console.error('Error loading stats:', error);
    }
  }

  function renderStats(stats) {
    document.getElementById('statTotal').textContent = stats.totalDevices || 0;
    document.getElementById('statOnline').textContent = stats.onlineDevices || 0;
    document.getElementById('statTemp').textContent = `${stats.averageTemperature || 0}°C`;
    document.getElementById('statPower').textContent = `${stats.estimatedPowerUsageWatts || 0} W`;

    // Colors chart
    const colorsCtx = document.getElementById('chartColors').getContext('2d');
    if (window.colorsChart) window.colorsChart.destroy();
    window.colorsChart = new Chart(colorsCtx, {
      type: 'doughnut',
      data: {
        labels: Object.keys(stats.colorDistribution || {}),
        datasets: [{
          data: Object.values(stats.colorDistribution || {}),
          backgroundColor: Object.keys(stats.colorDistribution || {}).map(c => c.startsWith('#') ? c : '#0dcaf0')
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { labels: { color: '#e9ecef' } }
        }
      }
    });

    // History chart
    const historyCtx = document.getElementById('chartHistory').getContext('2d');
    if (window.historyChart) window.historyChart.destroy();
    window.historyChart = new Chart(historyCtx, {
      type: 'line',
      data: {
        labels: stats.historyLabels || [],
        datasets: [{
          label: 'Średnia temperatura (°C)',
          data: stats.historyValues || [],
          borderColor: '#0dcaf0',
          backgroundColor: 'rgba(13, 202, 240, 0.1)',
          tension: 0.4,
          fill: true
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { labels: { color: '#e9ecef' } }
        },
        scales: {
          y: {
            ticks: { color: '#999' },
            grid: { color: 'rgba(255,255,255,0.1)' }
          },
          x: {
            ticks: { color: '#999' },
            grid: { color: 'rgba(255,255,255,0.1)' }
          }
        }
      }
    });
  }

  async function loadAdminStats() {
    if (!isAdmin) return;

    try {
      const response = await authFetch(`${API_BASE}/stats/global`);
      if (response.ok) {
        const stats = await response.json();
        const container = document.getElementById('adminStatsContainer');
        container.innerHTML = `
          <div class="row">
            <div class="col-md-6">
              <h6>Rozkład firmware</h6>
              <canvas id="adminFirmwareChart"></canvas>
            </div>
            <div class="col-md-6">
              <h6>Szczegółowe statystyki</h6>
              <ul class="list-group">
                <li class="list-group-item bg-dark border-secondary">
                  <strong>Łącznie urządzeń:</strong> ${stats.totalDevices}
                </li>
                <li class="list-group-item bg-dark border-secondary">
                  <strong>Online:</strong> ${stats.onlineDevices}
                </li>
                <li class="list-group-item bg-dark border-secondary">
                  <strong>Średnia temperatura:</strong> ${stats.averageTemperature}°C
                </li>
                <li class="list-group-item bg-dark border-secondary">
                  <strong>Zużycie mocy:</strong> ${stats.estimatedPowerUsageWatts} W
                </li>
              </ul>
            </div>
          </div>
        `;

        // Firmware chart
        setTimeout(() => {
          const firmwareCtx = document.getElementById('adminFirmwareChart').getContext('2d');
          if (window.firmwareChart) window.firmwareChart.destroy();
          window.firmwareChart = new Chart(firmwareCtx, {
            type: 'bar',
            data: {
              labels: Object.keys(stats.firmwareDistribution || {}),
              datasets: [{
                label: 'Liczba urządzeń',
                data: Object.values(stats.firmwareDistribution || {}),
                backgroundColor: '#0dcaf0'
              }]
            },
            options: {
              responsive: true,
              plugins: {
                legend: { display: false },
                labels: { color: '#e9ecef' }
              },
              scales: {
                y: {
                  ticks: { color: '#999' },
                  grid: { color: 'rgba(255,255,255,0.1)' }
                },
                x: {
                  ticks: { color: '#999' },
                  grid: { color: 'rgba(255,255,255,0.1)' }
                }
              }
            }
          });
        }, 100);
      }
    } catch (error) {
      console.error('Error loading admin stats:', error);
    }
  }

  async function sendOtaUpdate() {
    if (!isAdmin) {
      alert('Tylko administrator może wysyłać aktualizacje OTA');
      return;
    }

    const lampId = document.getElementById('otaLampId').value;
    const url = document.getElementById('otaUrl').value;

    if (!lampId || !url) {
      alert('Wypełnij wszystkie pola');
      return;
    }

    if (!confirm(`Czy na pewno chcesz wysłać aktualizację OTA do lampy ${lampId}?`)) {
      return;
    }

    showLoader();
    try {
      const response = await authFetch(`${API_BASE}/ota/lamps/${lampId}?url=${encodeURIComponent(url)}`, {
        method: 'POST'
      });

      if (response.ok) {
        alert('Aktualizacja OTA wysłana pomyślnie!');
        document.getElementById('otaLampId').value = '';
        document.getElementById('otaUrl').value = '';
      } else {
        alert('Błąd wysyłania aktualizacji OTA');
      }
    } catch (error) {
      alert('Błąd połączenia');
    } finally {
      hideLoader();
    }
  }

  async function sendOtaUpdateAll() {
    if (!isAdmin) {
      alert('Tylko administrator może wysyłać aktualizacje OTA');
      return;
    }

    const url = document.getElementById('otaUrl').value;

    if (!url) {
      alert('Podaj URL aktualizacji');
      return;
    }

    if (!confirm('Czy na pewno chcesz wysłać aktualizację OTA do WSZYSTKICH lamp?')) {
      return;
    }

    showLoader();
    try {
      const response = await authFetch(`${API_BASE}/ota/lamps?url=${encodeURIComponent(url)}`, {
        method: 'POST'
      });

      if (response.ok) {
        alert('Aktualizacja OTA do wszystkich lamp wysłana pomyślnie!');
        document.getElementById('otaUrl').value = '';
      } else {
        alert('Błąd wysyłania aktualizacji OTA do wszystkich lamp');
      }
    } catch (error) {
      alert('Błąd połączenia');
    } finally {
      hideLoader();
    }
  }

  function refreshLamps() {
    loadDashboard();
  }

  function startAutoRefresh() {
    if (refreshInterval) clearInterval(refreshInterval);
    refreshInterval = setInterval(() => {
      loadDashboard();
    }, 30000); // Refresh every 30 seconds
  }

  function formatUptime(seconds) {
    const days = Math.floor(seconds / 86400);
    const hours = Math.floor((seconds % 86400) / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    return `${days}d ${hours}h ${minutes}m`;
  }

  function logout() {
    // Wyczyść dane autoryzacji
    localStorage.removeItem('accessToken');
    localStorage.removeItem('refreshToken');
    accessToken = null;
    refreshToken = null;
    currentUser = null;
    isAdmin = false;

    // Zatrzymaj auto-refresh
    if (refreshInterval) {
      clearInterval(refreshInterval);
      refreshInterval = null;
    }

    // Zniszcz wszystkie wykresy
    Object.values(lampCharts).forEach(chart => {
      if (chart) chart.destroy();
    });
    lampCharts = {};

    if (window.lampModalChart) {
      window.lampModalChart.destroy();
      window.lampModalChart = null;
    }
    if (window.colorsChart) {
      window.colorsChart.destroy();
      window.colorsChart = null;
    }
    if (window.historyChart) {
      window.historyChart.destroy();
      window.historyChart = null;
    }
    if (window.firmwareChart) {
      window.firmwareChart.destroy();
      window.firmwareChart = null;
    }

    // Pokaż formularz logowania
    showLogin();
  }

  function showLoader() {
    document.getElementById('loader').style.display = 'flex';
  }

  function hideLoader() {
    document.getElementById('loader').style.display = 'none';
  }

  async function authFetch(url, options = {}) {
    const headers = {
      'Authorization': `Bearer ${accessToken}`,
      ...options.headers
    };

    let response = await fetch(url, { ...options, headers });

    if (response.status === 401 && refreshToken) {
      // Try to refresh token
      try {
        const refreshResponse = await fetch(`${API_BASE}/auth/refresh`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ refreshToken })
        });

        if (refreshResponse.ok) {
          const data = await refreshResponse.json();
          accessToken = data.accessToken;
          refreshToken = data.refreshToken;
          localStorage.setItem('accessToken', accessToken);
          localStorage.setItem('refreshToken', refreshToken);

          headers['Authorization'] = `Bearer ${accessToken}`;
          response = await fetch(url, { ...options, headers });
        } else {
          logout();
          throw new Error('Token refresh failed');
        }
      } catch (error) {
        logout();
        throw error;
      }
    }

    return response;
  }
</script>
</body>
</html>