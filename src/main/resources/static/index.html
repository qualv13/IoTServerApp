<!DOCTYPE html>
<html lang="pl" data-bs-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IoT Control Panel v7.1 (STATS ENABLED)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <style>
    body { background-color: #212529; color: #f8f9fa; font-family: 'Segoe UI', sans-serif; }
    .card { background-color: #2b3035; border: 1px solid #495057; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
    .status-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; transition: all 0.3s; }
    .status-on { background-color: #2ecc71; box-shadow: 0 0 10px #2ecc71; }
    .status-off { background-color: #e74c3c; box-shadow: none; }
    #loader {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.85); z-index: 9999; display: none;
      justify-content: center; align-items: center; flex-direction: column;
    }
    .auth-container { max-width: 400px; margin: 80px auto; }
    .chart-box { height: 250px; position: relative; width: 100%; }
    .nav-link { cursor: pointer; transition: color 0.2s; }
    .nav-link:hover { color: #fff !important; }
    .btn-action { width: 32px; height: 32px; padding: 0; display: inline-flex; align-items: center; justify-content: center; }
  </style>
</head>
<body>

<div id="loader">
  <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div>
  <div class="text-light">Przetwarzanie...</div>
</div>

<nav id="navbar" class="navbar navbar-expand-lg navbar-dark bg-dark border-bottom border-secondary mb-4 sticky-top" style="display: none;">
  <div class="container">
    <span class="navbar-brand fw-bold"><i class="fas fa-network-wired text-primary me-2"></i>IoT Manager</span>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav me-auto">
        <li class="nav-item"><a class="nav-link active" onclick="showView('dashboard')"><i class="fas fa-home me-1"></i> Pulpit</a></li>
        <li class="nav-item"><a class="nav-link" onclick="showView('stats')"><i class="fas fa-chart-pie me-1"></i> Statystyki</a></li>
      </ul>
      <div class="d-flex align-items-center gap-3">
        <div class="dropdown">
          <button class="btn btn-sm btn-outline-light dropdown-toggle" type="button" data-bs-toggle="dropdown">
            <i class="fas fa-user-circle me-1"></i> <span id="nav-username">User</span>
          </button>
          <ul class="dropdown-menu dropdown-menu-dark dropdown-menu-end">
            <li><a class="dropdown-item text-danger" href="#" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i> Wyloguj</a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</nav>

<main class="container py-4">

  <div id="login-view" class="auth-container">
    <div class="card p-4 shadow-lg border-0">
      <div class="text-center mb-4">
        <i class="fas fa-user-shield fa-3x text-primary mb-2"></i>
        <h3>Logowanie</h3>
      </div>
      <form onsubmit="handleLogin(event)">
        <div class="form-floating mb-3">
          <input type="text" id="loginUser" class="form-control" placeholder="Użytkownik" required>
          <label for="loginUser" class="text-secondary">Login</label>
        </div>
        <div class="form-floating mb-3">
          <input type="password" id="loginPass" class="form-control" placeholder="Hasło" required>
          <label for="loginPass" class="text-secondary">Hasło</label>
        </div>
        <button class="btn btn-primary w-100 fw-bold py-2 mb-3">Zaloguj się</button>
        <div class="text-center"><a href="#" onclick="showView('register')" class="text-decoration-none text-info">Zarejestruj się</a></div>
      </form>
    </div>
  </div>

  <div id="register-view" class="auth-container" style="display: none;">
    <div class="card p-4 shadow-lg border-info">
      <div class="text-center mb-4">
        <i class="fas fa-user-plus fa-3x text-info mb-2"></i>
        <h3>Rejestracja</h3>
      </div>
      <form onsubmit="handleRegister(event)">
        <div class="form-floating mb-3">
          <input type="text" id="regUser" class="form-control" placeholder="Login" required>
          <label for="regUser" class="text-secondary">Login</label>
        </div>
        <div class="form-floating mb-3">
          <input type="password" id="regPass" class="form-control" placeholder="Hasło" required>
          <label for="regPass" class="text-secondary">Hasło</label>
        </div>
        <button class="btn btn-info w-100 fw-bold py-2 mb-3 text-dark">Utwórz konto</button>
        <div class="text-center"><a href="#" onclick="showView('login')" class="text-decoration-none text-light">Powrót do logowania</a></div>
      </form>
    </div>
  </div>

  <div id="dashboard-view" style="display: none;">
    <div class="row g-4 mb-4">
      <div class="col-md-6">
        <div class="card h-100">
          <div class="card-header bg-success bg-opacity-25 fw-bold border-success"><i class="fas fa-plus-circle me-2"></i>Rejestracja Urządzenia</div>
          <div class="card-body d-flex align-items-center">
            <div class="input-group">
              <span class="input-group-text bg-dark border-secondary"><i class="fas fa-barcode"></i></span>
              <input type="text" id="newLampId" class="form-control bg-dark text-white border-secondary" placeholder="Serial Number">
              <button onclick="addLamp()" class="btn btn-success">Dodaj</button>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card h-100 border-warning bg-dark">
          <div class="card-header bg-warning text-dark bg-opacity-75 fw-bold"><i class="fas fa-cloud-upload-alt me-2"></i>Aktualizacja Firmware (OTA)</div>
          <div class="card-body">
            <form onsubmit="handleOtaUpload(event)">
              <div class="input-group input-group-sm mb-2">
                <span class="input-group-text bg-dark border-secondary text-light">URL</span>
                <input type="url" id="otaUrl" class="form-control bg-dark text-white border-secondary" placeholder="http://server.com/firmware.bin" required>
              </div>
              <div class="row g-2">
                <div class="col-4">
                  <select id="otaTargetType" class="form-select form-select-sm bg-dark text-white border-secondary">
                    <option value="lamp">Lampa</option>
                    <option value="fleet">Flota</option>
                  </select>
                </div>
                <div class="col-8">
                  <input type="text" id="otaTargetId" class="form-control form-control-sm bg-dark text-white border-secondary" placeholder="ID Celu" required>
                </div>
              </div>
              <button type="submit" class="btn btn-sm btn-outline-warning w-100 mt-2">Wyślij Rozkaz Aktualizacji</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div class="row g-4">
      <div class="col-lg-8">
        <div class="d-flex justify-content-between align-items-center mb-3 border-bottom border-secondary pb-2">
          <h4 class="m-0"><i class="fas fa-lightbulb text-warning me-2"></i>Twoje Urządzenia</h4>
          <button onclick="loadLamps()" class="btn btn-sm btn-outline-light"><i class="fas fa-sync-alt"></i></button>
        </div>
        <div id="lamp-grid" class="row row-cols-1 row-cols-md-2 g-3"></div>
      </div>

      <div class="col-lg-4">
        <div class="card mb-4">
          <div class="card-header bg-primary bg-gradient text-white fw-bold"><i class="fas fa-layer-group me-2"></i>Zarządzanie Flotami</div>
          <div class="card-body p-2">
            <div class="input-group mb-3">
              <input type="text" id="newFleetName" class="form-control form-control-sm bg-dark text-white border-secondary" placeholder="Nazwa nowej floty">
              <button onclick="createFleet()" class="btn btn-sm btn-primary"><i class="fas fa-plus"></i></button>
            </div>
            <ul class="list-group list-group-flush small" id="fleet-list"></ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="stats-view" style="display: none;">
    <h3 class="mb-4 text-info"><i class="fas fa-chart-line me-2"></i>Centrum Danych</h3>

    <div id="admin-stats-panel" class="card mb-5 border-warning" style="display: none;">
      <div class="card-header bg-warning text-dark fw-bold"><i class="fas fa-user-secret me-2"></i>Panel Administratora</div>
      <div class="card-body">
        <div class="row text-center mb-4">
          <div class="col-md-3"><h2 id="adm-users" class="text-warning fw-bold">0</h2><small>Użytkowników</small></div>
          <div class="col-md-3"><h2 id="adm-lamps" class="text-light fw-bold">0</h2><small>Wszystkie Lampy</small></div>
          <div class="col-md-3"><h2 id="adm-online" class="text-success fw-bold">0</h2><small>Globalnie Online</small></div>
          <div class="col-md-3"><h2 id="adm-temp" class="text-info fw-bold">0°C</h2><small>Śr. Temperatura</small></div>
        </div>
        <div class="row">
          <div class="col-md-4"><div class="chart-box"><canvas id="adminStatusChart"></canvas></div></div>
          <div class="col-md-4"><div class="chart-box"><canvas id="adminColorChart"></canvas></div></div>
          <div class="col-md-4"><div class="chart-box"><canvas id="adminTempChart"></canvas></div></div>
        </div>
      </div>
    </div>

    <div class="card border-primary">
      <div class="card-header bg-primary text-white fw-bold"><i class="fas fa-user-tag me-2"></i>Twoje Statystyki</div>
      <div class="card-body">
        <div class="row text-center mb-4">
          <div class="col-3"><h3 id="my-lamps" class="text-primary fw-bold">0</h3><small>Lampy</small></div>
          <div class="col-3"><h3 id="my-online" class="text-success fw-bold">0</h3><small>Włączone</small></div>
          <div class="col-3"><h3 id="my-offline" class="text-secondary fw-bold">0</h3><small>Wyłączone</small></div>
          <div class="col-3"><h3 id="my-temp" class="text-info fw-bold">0°C</h3><small>Śr. Temp</small></div>
        </div>
        <div class="row justify-content-center">
          <div class="col-md-5"><h6 class="text-center text-muted">Rozkład Kolorów</h6><div class="chart-box"><canvas id="userColorChart"></canvas></div></div>
          <div class="col-md-5"><h6 class="text-center text-muted">Średnia Temperatura</h6><div class="chart-box"><canvas id="userTempChart"></canvas></div></div>
        </div>
      </div>
    </div>
  </div>

</main>

<div class="modal fade" id="controlModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-white border-secondary">
      <div class="modal-header border-secondary">
        <h5 class="modal-title" id="modalTitle">Sterowanie</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-info py-2 small" id="targetInfo"></div>

        <div class="d-flex justify-content-center gap-4 mb-4">
          <button onclick="sendProtoCmd('ON')" class="btn btn-lg btn-success px-5 fw-bold shadow">ON</button>
          <button onclick="sendProtoCmd('OFF')" class="btn btn-lg btn-danger px-5 fw-bold shadow">OFF</button>
        </div>

        <hr class="border-secondary">
        <h6 class="mb-3 text-muted">Konfiguracja Koloru (Direct)</h6>

        <div class="row mb-3">
          <div class="col-6">
            <label class="form-label">Kolor</label>
            <input type="color" id="confCol" class="form-control form-control-color w-100 bg-secondary border-0" value="#ffffff" title="Wybierz kolor">
          </div>
          <div class="col-6">
            <label class="form-label">Warm White (0-255)</label>
            <input type="number" id="confWW" class="form-control bg-dark text-white border-secondary" value="0" min="0" max="255">
          </div>
        </div>

        <hr class="border-secondary">
        <h6 class="mb-3 text-muted">Ustawienia Lampy (Config)</h6>
        <div class="mb-3">
          <label class="form-label">Interwał Raportowania (s)</label>
          <input type="number" id="confInt" class="form-control bg-dark text-white border-secondary" value="60">
        </div>

        <button onclick="sendProtoConfig()" class="btn btn-primary w-100 mt-2"><i class="fas fa-save me-2"></i>Wyślij (Kolor + Config)</button>

        <div class="mt-3 text-center">
          <button onclick="sendReboot()" class="btn btn-outline-warning btn-sm">Restart Urządzenia</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="detailsModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content bg-dark text-white border-secondary">
      <div class="modal-header border-secondary">
        <h5 class="modal-title"><i class="fas fa-chart-area me-2 text-info"></i>Telemetria: <span id="detLampId"></span></h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="row mb-3">
          <div class="col-md-6">
            <div class="p-3 border border-secondary rounded text-center bg-secondary bg-opacity-10">
              <small class="text-muted d-block">Czas pracy (Uptime)</small>
              <span id="detUptime" class="fs-5 fw-bold text-success">--</span>
            </div>
          </div>
          <div class="col-md-6">
            <div class="p-3 border border-secondary rounded text-center bg-secondary bg-opacity-10">
              <small class="text-muted d-block">Światło Otoczenia</small>
              <span id="detLight" class="fs-5 fw-bold text-info">--</span>
            </div>
          </div>
        </div>
        <h6 class="text-muted">Ostatnie Pomiary Temperatur</h6>
        <div class="chart-box">
          <canvas id="detailsChart"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/protobufjs@7.2.4/dist/protobuf.min.js"></script>

<script>
  const API = window.location.origin;
  // const API = "http://srv38.mikr.us:40142"; // Testy lokalne
  let token = localStorage.getItem('jwt');
  let myFleets = [];
  let charts = {};
  let currentTarget = { type: 'lamp', id: null };

  // --- 1. PROTOBUF DEFINITIONS ---
  let LampCommand, LampConfig, StatusReport;

  async function loadProtoDef() {
    try {
      let protoDef = `
      syntax = "proto3";
      message StatusReport {
        uint32 version = 1; int64 ts = 2; uint32 uptime_seconds = 3;
        repeated uint32 temperature_readings = 4; uint32 ambient_light = 5; uint32 ambient_noise = 6;
        DirectSettings led_settings = 7;
      }
      message DirectSettings {
        uint32 red = 1; uint32 green = 2; uint32 blue = 3; uint32 cold_white = 4; uint32 neutral_white = 5; uint32 warm_white = 6;
      }
      message InternalLampConfig { uint32 reporting_interval_seconds = 1; }
      message LampConfig { uint32 version = 1; int64 ts = 2; InternalLampConfig internal_lamp_config = 4; }
      message SetWifiParamsCommand { string ssid = 1; string password = 2; }
      message BlinkLedCommand { uint32 duration = 1; }
      message SetDirectSettingsCommand { DirectSettings direct_settings = 1; }
      message RebootCommand {}
      message DownloadOtaUpdateCommand { string ota_url = 1; }
      message LampCommand {
        uint32 version = 1; int64 ts = 2;
        oneof command {
            SetWifiParamsCommand set_wifi_params_command = 3;
            BlinkLedCommand blink_led_command = 4;
            SetDirectSettingsCommand set_direct_settings_command = 5;
            RebootCommand reboot_command = 9;
            DownloadOtaUpdateCommand download_ota_update_command = 10;
        }
      }
      `;
      const root = protobuf.parse(protoDef).root;
      LampCommand = root.lookupType("LampCommand");
      LampConfig = root.lookupType("LampConfig");
      StatusReport = root.lookupType("StatusReport");
    } catch(e) { console.error("Proto error", e); }
  }

  // --- INIT ---
  (async function(){
    await loadProtoDef();
    if(token) init(); else showView('login');
  })();

  function showView(viewName) {
    ['login-view','register-view','dashboard-view','stats-view','navbar'].forEach(id => document.getElementById(id).style.display='none');
    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));

    if(viewName === 'login') document.getElementById('login-view').style.display = 'block';
    if(viewName === 'register') document.getElementById('register-view').style.display = 'block';

    if(viewName === 'dashboard' || viewName === 'stats') {
      document.getElementById(viewName+'-view').style.display = 'block';
      document.getElementById('navbar').style.display = 'block';
      if(viewName === 'dashboard') document.querySelectorAll('.nav-link')[0].classList.add('active');
      if(viewName === 'stats') {
        document.querySelectorAll('.nav-link')[1].classList.add('active');
        loadStats(); // Ładujemy statystyki przy wejściu w widok
      }
    }
  }

  // --- AUTH FETCH ---
  async function authFetch(url, opts={}) {
    document.getElementById('loader').style.display = 'flex';
    opts.headers = opts.headers || {};
    opts.headers['Authorization'] = `Bearer ${token}`;
    if(opts.body && !opts.headers['Content-Type']) opts.headers['Content-Type']='application/json';

    try {
      const res = await fetch(url, opts);
      document.getElementById('loader').style.display = 'none';
      if(res.status === 401) { logout(); return null; }
      return res;
    } catch(e) {
      document.getElementById('loader').style.display = 'none';
      console.error("Network error", e);
      return null;
    }
  }

  async function handleLogin(e) {
    e.preventDefault();
    const u = document.getElementById('loginUser').value;
    const p = document.getElementById('loginPass').value;
    try {
      const res = await fetch(`${API}/auth/login`, {
        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({username: u, password: p})
      });
      if(!res.ok) throw new Error();
      const data = await res.json();
      token = data.accessToken;
      localStorage.setItem('jwt', token);
      localStorage.setItem('user', u);
      init();
    } catch(e) { alert('Błąd logowania.'); }
  }

  async function handleRegister(e) {
    e.preventDefault();
    const u = document.getElementById('regUser').value;
    const p = document.getElementById('regPass').value;
    const res = await fetch(`${API}/users`, {
      method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({username: u, password: p})
    });
    if(res.ok) { alert("Konto utworzone!"); showView('login'); }
    else alert("Błąd rejestracji.");
  }

  function init() {
    showView('dashboard');
    document.getElementById('nav-username').innerText = localStorage.getItem('user');
    refreshAll();
  }

  function logout() { localStorage.removeItem('jwt'); location.reload(); }

  // --- CORE DATA ---
  async function refreshAll() { await loadFleets(); await loadLamps(); }

  async function loadFleets() {
    const res = await authFetch(`${API}/fleets`);
    if(!res) return;
    myFleets = await res.json();
    const list = document.getElementById('fleet-list');
    list.innerHTML = '';
    myFleets.forEach(f => {
      list.innerHTML += `
        <li class="list-group-item bg-dark text-white border-secondary d-flex justify-content-between align-items-center p-2">
            <div><i class="fas fa-folder text-primary me-2"></i> ${f.name}</div>
            <div>
              <button onclick="openModal('fleet', ${f.id})" class="btn btn-action btn-sm btn-outline-info me-1"><i class="fas fa-sliders-h"></i></button>
              <button onclick="deleteFleet(${f.id})" class="btn btn-action btn-sm btn-outline-danger"><i class="fas fa-trash-alt"></i></button>
            </div>
        </li>`;
    });
  }

  async function createFleet() {
    const name = document.getElementById('newFleetName').value;
    if(!name) return;
    await authFetch(`${API}/fleets`, { method: 'POST', body: JSON.stringify({name}) });
    document.getElementById('newFleetName').value=''; refreshAll();
  }

  async function deleteFleet(id) {
    if(confirm("Czy usunąć tę flotę?")) {
      await authFetch(`${API}/fleets/${id}`, { method: 'DELETE' });
      refreshAll();
    }
  }

  async function loadLamps() {
    const res = await authFetch(`${API}/users/me/lamps`);
    if(!res) return;
    let lamps = await res.json();

    lamps.sort((a, b) => {
      const fA = a.fleetId; const fB = b.fleetId;
      if (!fA && !fB) return a.id.localeCompare(b.id);
      if (!fA) return -1;
      if (!fB) return 1;
      if (fA !== fB) return fA - fB;
      return a.id.localeCompare(b.id);
    });

    const grid = document.getElementById('lamp-grid');
    grid.innerHTML = '';

    lamps.forEach(lamp => {
      let optionsHtml = '<option value="" disabled selected>Wybierz flotę</option>';
      myFleets.forEach(f => { optionsHtml += `<option value="${f.id}">${f.name}</option>`; });

      let fleetSec = lamp.fleetId
              ? `<div class="d-flex justify-content-between align-items-center bg-secondary bg-opacity-25 rounded p-1 mb-2">
                   <small class="text-info mx-2"><i class="fas fa-link me-1"></i>Flota: ${lamp.fleetId}</small>
                   <button onclick="removeFromFleet(${lamp.fleetId}, '${lamp.id}')" class="btn btn-action btn-sm btn-outline-warning border-0"><i class="fas fa-unlink"></i></button>
                 </div>`
              : `<div class="input-group input-group-sm mb-2">
                   <select id="sel-${lamp.id}" class="form-select bg-dark text-white border-secondary py-0">${optionsHtml}</select>
                   <button onclick="assignToFleet('${lamp.id}')" class="btn btn-outline-secondary"><i class="fas fa-plus"></i></button>
                 </div>`;

      grid.innerHTML += `
        <div class="col"><div class="card h-100 border-secondary">
          <div class="card-body p-3 d-flex flex-column">
            <div class="d-flex justify-content-between align-items-start mb-2">
                <div>
                  <h5 class="card-title m-0 text-truncate fw-bold text-light" title="${lamp.id}">${lamp.id}</h5>
                  <span class="badge ${lamp.on ? 'bg-success':'bg-danger'} text-dark rounded-pill" style="font-size:0.6rem">${lamp.on ? 'ON':'OFF'}</span>
                </div>
                <span class="status-dot ${lamp.on ? 'status-on':'status-off'} mt-1"></span>
            </div>
            ${fleetSec}
            <div class="mt-auto d-flex gap-2">
                <button onclick="openModal('lamp', '${lamp.id}')" class="btn btn-sm btn-primary flex-grow-1"><i class="fas fa-sliders-h me-1"></i></button>
                <button onclick="openLampDetails('${lamp.id}')" class="btn btn-sm btn-outline-info"><i class="fas fa-chart-area"></i></button>
                <button onclick="delLamp('${lamp.id}')" class="btn btn-sm btn-outline-danger"><i class="fas fa-trash"></i></button>
            </div>
        </div></div></div>`;
    });
  }

  // --- LAMP MANAGEMENT ---
  async function addLamp() {
    const id = document.getElementById('newLampId').value;
    if(!id) return;
    const res = await authFetch(`${API}/users/me/lamps`, { method:'POST', body: JSON.stringify({lampId: id}) });
    if(res && res.ok) {
      const data = await res.json();
      alert("Lampa dodana!\n\nTOKEN: " + data.device_token);
      document.getElementById('newLampId').value=''; loadLamps();
    }
  }
  async function delLamp(id) {
    if(confirm(`Usunąć lampę ${id}?`)) {
      await authFetch(`${API}/users/me/lamps/${id}`, {method:'DELETE'});
      loadLamps();
    }
  }
  async function assignToFleet(lId) {
    const fId = document.getElementById(`sel-${lId}`).value;
    if(!fId) return;
    await authFetch(`${API}/fleets/${fId}/lamps/${lId}`, { method: 'POST' });
    loadLamps();
  }
  async function removeFromFleet(fId, lId) {
    if(confirm('Odpiąć z floty?')) {
      await authFetch(`${API}/fleets/${fId}/lamps/${lId}`, { method: 'DELETE' });
      loadLamps();
    }
  }

  // --- CONTROL LOGIC ---
  function hexToRgb(hex) {
    const bigint = parseInt(hex.slice(1), 16);
    return { r: (bigint >> 16) & 255, g: (bigint >> 8) & 255, b: bigint & 255 };
  }

  function openModal(type, id) {
    currentTarget = { type: type, id: id };
    document.getElementById('modalTitle').innerText = (type==='lamp') ? `Lampa: ${id}` : `Flota: ${id}`;
    document.getElementById('targetInfo').innerText = (type==='fleet') ? "Sterowanie grupowe." : "Sterowanie indywidualne.";
    document.getElementById('confCol').value = "#ffffff";
    document.getElementById('confWW').value = 0;
    document.getElementById('confInt').value = 60;
    new bootstrap.Modal(document.getElementById('controlModal')).show();
  }

  async function sendBin(url, body, method='POST') {
    document.getElementById('loader').style.display='flex';
    try {
      const res = await fetch(url, {
        method: method,
        headers: {'Authorization':`Bearer ${token}`, 'Content-Type':'application/x-protobuf'},
        body: body
      });
      if(!res.ok) alert('Błąd wysyłania komendy');
      return res;
    } catch(err) { console.error(err); alert("Błąd sieci"); }
    finally { document.getElementById('loader').style.display='none'; }
  }

  async function sendProtoCmd(typeStr) {
    let message = { version: 1, ts: Math.floor(Date.now() / 1000) };
    if (typeStr === 'ON') {
      const hex = document.getElementById('confCol').value;
      const rgb = hexToRgb(hex);
      message.setDirectSettingsCommand = {
        directSettings: {
          red: rgb.r, green: rgb.g, blue: rgb.b,
          warmWhite: parseInt(document.getElementById('confWW').value || 0),
          coldWhite: 0, neutralWhite: 0
        }
      };
    } else if (typeStr === 'OFF') {
      message.setDirectSettingsCommand = {
        directSettings: { red: 0, green: 0, blue: 0, warmWhite: 0, coldWhite: 0, neutralWhite: 0 }
      };
    }
    const buf = LampCommand.encode(LampCommand.create(message)).finish();
    const url = (currentTarget.type === 'lamp') ? `${API}/lamps/${currentTarget.id}/command` : `${API}/fleets/${currentTarget.id}/command`;
    await sendBin(url, buf);
    if(currentTarget.type==='lamp') setTimeout(loadLamps, 800);
  }

  async function sendProtoConfig() {
    await sendProtoCmd('ON');
    let configMsg = {
      version: 1, ts: Math.floor(Date.now() / 1000),
      internalLampConfig: { reportingIntervalSeconds: parseInt(document.getElementById('confInt').value) }
    };
    const buf = LampConfig.encode(LampConfig.create(configMsg)).finish();
    const url = (currentTarget.type === 'lamp') ? `${API}/lamps/${currentTarget.id}/config` : `${API}/fleets/${currentTarget.id}/config`;
    await sendBin(url, buf, 'PUT');
    setTimeout(loadLamps, 500);
  }

  async function sendReboot() {
    if(!confirm("Zrestartować urządzenie?")) return;
    let message = { version: 1, ts: Math.floor(Date.now() / 1000), rebootCommand: {} };
    const buf = LampCommand.encode(LampCommand.create(message)).finish();
    const url = (currentTarget.type === 'lamp') ? `${API}/lamps/${currentTarget.id}/command` : `${API}/fleets/${currentTarget.id}/command`;
    await sendBin(url, buf);
  }

  // --- OTA ---
  async function handleOtaUpload(e) {
    e.preventDefault();
    const urlStr = document.getElementById('otaUrl').value;
    const targetType = document.getElementById('otaTargetType').value;
    const targetId = document.getElementById('otaTargetId').value;
    if(!urlStr || !targetId) return;

    let message = { version: 1, ts: Math.floor(Date.now() / 1000), downloadOtaUpdateCommand: { otaUrl: urlStr } };
    const buf = LampCommand.encode(LampCommand.create(message)).finish();
    const endpoint = (targetType === 'lamp') ? `${API}/lamps/${targetId}/command` : `${API}/fleets/${targetId}/command`;

    if(confirm(`Wysłać OTA ${urlStr} do ${targetId}?`)) {
      await sendBin(endpoint, buf);
      alert("Rozkaz aktualizacji wysłany!");
    }
  }

  // --- DETAILS ---
  async function openLampDetails(id) {
    document.getElementById('detLampId').innerText = id;
    document.getElementById('detUptime').innerText = "...";
    document.getElementById('detLight').innerText = "...";
    new bootstrap.Modal(document.getElementById('detailsModal')).show();

    try {
      const res = await fetch(`${API}/lamps/${id}/status`, {
        headers: {'Authorization': `Bearer ${token}`, 'Accept': 'application/x-protobuf'}
      });
      if(res.ok) {
        const buffer = await res.arrayBuffer();
        const report = StatusReport.decode(new Uint8Array(buffer));
        const uptimeHrs = (report.uptimeSeconds / 3600).toFixed(1);
        document.getElementById('detUptime').innerText = `${uptimeHrs}h`;
        document.getElementById('detLight').innerText = report.ambientLight || 0;
        const temps = report.temperatureReadings || [];
        const labels = temps.map((_, i) => `${i+1}`);
        renderChart('detailsChart', 'line', labels, temps, 'Temperatura (°C)', ['#e74c3c']);
      } else { document.getElementById('detUptime').innerText = "Brak danych"; }
    } catch(e) { console.error("Chart error", e); }
  }

  // --- STATS (NOWE, DZIAŁAJĄCE) ---
  async function loadStats() {
    const user = localStorage.getItem('user');

    // 1. Statystyki Użytkownika (/stats/me)
    try {
      const res = await authFetch(`${API}/stats/me`);
      if(res && res.ok) {
        const data = await res.json();

        // Wypełnianie liczników
        document.getElementById('my-lamps').innerText = data.totalLamps;
        document.getElementById('my-online').innerText = data.onlineLamps;
        document.getElementById('my-offline').innerText = data.offlineLamps;
        document.getElementById('my-temp').innerText = (data.averageTemperature || 0).toFixed(1) + '°C';

        // Wykres Kolorów
        renderChart('userColorChart', 'doughnut',
                Object.keys(data.colorDistribution),
                Object.values(data.colorDistribution),
                'Kolory'
        );

        // Wykres Temperatury (jeden słupek to średnia)
        renderChart('userTempChart', 'bar',
                ['Twoja Średnia'],
                [data.averageTemperature],
                'Temp °C',
                ['#3498db']
        );
      }
    } catch(e){ console.error("Stats/me error", e); }

    // 2. Statystyki Admina (/stats/global)
    if(user === 'admin') {
      document.getElementById('admin-stats-panel').style.display = 'block';
      try {
        const res = await authFetch(`${API}/stats/global`);
        if(res && res.ok) {
          const data = await res.json();
          document.getElementById('adm-users').innerText = data.totalUsers;
          document.getElementById('adm-lamps').innerText = data.totalLamps;
          document.getElementById('adm-online').innerText = data.onlineLamps;
          document.getElementById('adm-temp').innerText = (data.averageTemperature || 0).toFixed(1) + '°C';

          renderChart('adminStatusChart', 'pie', ['On', 'Off'], [data.onlineLamps, data.offlineLamps], 'Status', ['#2ecc71', '#e74c3c']);
          renderChart('adminColorChart', 'doughnut', Object.keys(data.colorDistribution), Object.values(data.colorDistribution), 'Kolory');
          renderChart('adminTempChart', 'bar', ['Globalna Średnia'], [data.averageTemperature], 'Temp °C', ['#f1c40f']);
        }
      } catch(e){ console.error("Stats/global error", e); }
    } else {
      document.getElementById('admin-stats-panel').style.display = 'none';
    }
  }

  function renderChart(canvasId, type, labels, dataArr, label, colors = null) {
    const ctx = document.getElementById(canvasId).getContext('2d');
    if(charts[canvasId]) charts[canvasId].destroy();

    let bgColors = colors;
    if(!bgColors) bgColors = labels.map(c => {
      // Jeśli label to kod hex (kolor lampy), użyj go jako koloru wykresu
      return c.startsWith('#') ? c : '#3498db';
    });

    charts[canvasId] = new Chart(ctx, {
      type: type,
      data: {
        labels: labels,
        datasets: [{ label: label, data: dataArr, backgroundColor: bgColors, borderColor: bgColors[0], borderWidth: 1, tension: 0.3 }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { display: type!=='bar' && type!=='line', labels: { color: '#ccc' } } },
        scales: (type==='bar'||type==='line') ? { y: { beginAtZero: true, ticks:{color:'#999'} }, x:{ticks:{color:'#999'}} } : {}
      }
    });
  }
</script>
</body>
</html>

<!--<!DOCTYPE html>-->
<!--<html lang="pl" data-bs-theme="dark">-->
<!--<head>-->
<!--  <meta charset="UTF-8">-->
<!--  <meta name="viewport" content="width=device-width, initial-scale=1.0">-->
<!--  <title>IoT Control Panel v6.0 (FULL)</title>-->
<!--  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">-->
<!--  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>-->
<!--  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">-->

<!--  <style>-->
<!--    body { background-color: #212529; color: #f8f9fa; font-family: 'Segoe UI', sans-serif; }-->
<!--    .card { background-color: #2b3035; border: 1px solid #495057; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }-->
<!--    .status-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; transition: all 0.3s; }-->
<!--    .status-on { background-color: #2ecc71; box-shadow: 0 0 10px #2ecc71; }-->
<!--    .status-off { background-color: #e74c3c; box-shadow: none; }-->
<!--    #loader {-->
<!--      position: fixed; top: 0; left: 0; width: 100%; height: 100%;-->
<!--      background: rgba(0,0,0,0.85); z-index: 9999; display: none;-->
<!--      justify-content: center; align-items: center; flex-direction: column;-->
<!--    }-->
<!--    .auth-container { max-width: 400px; margin: 80px auto; }-->
<!--    .chart-box { height: 250px; position: relative; width: 100%; }-->
<!--    .nav-link { cursor: pointer; transition: color 0.2s; }-->
<!--    .nav-link:hover { color: #fff !important; }-->
<!--    .btn-action { width: 32px; height: 32px; padding: 0; display: inline-flex; align-items: center; justify-content: center; }-->
<!--  </style>-->
<!--</head>-->
<!--<body>-->

<!--<div id="loader">-->
<!--  <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div>-->
<!--  <div class="text-light">Ładowanie danych...</div>-->
<!--</div>-->

<!--<nav id="navbar" class="navbar navbar-expand-lg navbar-dark bg-dark border-bottom border-secondary mb-4 sticky-top" style="display: none;">-->
<!--  <div class="container">-->
<!--    <span class="navbar-brand fw-bold"><i class="fas fa-network-wired text-primary me-2"></i>IoT Manager</span>-->
<!--    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">-->
<!--      <span class="navbar-toggler-icon"></span>-->
<!--    </button>-->
<!--    <div class="collapse navbar-collapse" id="navbarNav">-->
<!--      <ul class="navbar-nav me-auto">-->
<!--        <li class="nav-item"><a class="nav-link active" onclick="showView('dashboard')"><i class="fas fa-home me-1"></i> Pulpit</a></li>-->
<!--        <li class="nav-item"><a class="nav-link" onclick="showView('stats')"><i class="fas fa-chart-pie me-1"></i> Statystyki</a></li>-->
<!--      </ul>-->
<!--      <div class="d-flex align-items-center gap-3">-->
<!--        <div class="dropdown">-->
<!--          <button class="btn btn-sm btn-outline-light dropdown-toggle" type="button" data-bs-toggle="dropdown">-->
<!--            <i class="fas fa-user-circle me-1"></i> <span id="nav-username">User</span>-->
<!--          </button>-->
<!--          <ul class="dropdown-menu dropdown-menu-dark dropdown-menu-end">-->
<!--            <li><a class="dropdown-item" href="#" onclick="openProfileModal()"><i class="fas fa-cog me-2"></i> Ustawienia konta</a></li>-->
<!--            <li><hr class="dropdown-divider"></li>-->
<!--            <li><a class="dropdown-item text-danger" href="#" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i> Wyloguj</a></li>-->
<!--          </ul>-->
<!--        </div>-->
<!--      </div>-->
<!--    </div>-->
<!--  </div>-->
<!--</nav>-->

<!--<main class="container py-4">-->

<!--  <div id="login-view" class="auth-container">-->
<!--    <div class="card p-4 shadow-lg border-0">-->
<!--      <div class="text-center mb-4">-->
<!--        <i class="fas fa-user-shield fa-3x text-primary mb-2"></i>-->
<!--        <h3>Logowanie</h3>-->
<!--      </div>-->
<!--      <form onsubmit="handleLogin(event)">-->
<!--        <div class="form-floating mb-3">-->
<!--          <input type="text" id="loginUser" class="form-control" placeholder="Użytkownik" required>-->
<!--          <label for="loginUser" class="text-secondary">Login</label>-->
<!--        </div>-->
<!--        <div class="form-floating mb-3">-->
<!--          <input type="password" id="loginPass" class="form-control" placeholder="Hasło" required>-->
<!--          <label for="loginPass" class="text-secondary">Hasło</label>-->
<!--        </div>-->
<!--        <button class="btn btn-primary w-100 fw-bold py-2 mb-3">Zaloguj się</button>-->
<!--        <div class="text-center"><a href="#" onclick="showView('register')" class="text-decoration-none text-info">Nie masz konta? Zarejestruj się</a></div>-->
<!--      </form>-->
<!--    </div>-->
<!--  </div>-->

<!--  <div id="register-view" class="auth-container" style="display: none;">-->
<!--    <div class="card p-4 shadow-lg border-info">-->
<!--      <div class="text-center mb-4">-->
<!--        <i class="fas fa-user-plus fa-3x text-info mb-2"></i>-->
<!--        <h3>Rejestracja</h3>-->
<!--      </div>-->
<!--      <form onsubmit="handleRegister(event)">-->
<!--        <div class="form-floating mb-3">-->
<!--          <input type="text" id="regUser" class="form-control" placeholder="Login" required>-->
<!--          <label for="regUser" class="text-secondary">Login</label>-->
<!--        </div>-->
<!--        <div class="form-floating mb-3">-->
<!--          <input type="password" id="regPass" class="form-control" placeholder="Hasło" required>-->
<!--          <label for="regPass" class="text-secondary">Hasło</label>-->
<!--        </div>-->
<!--        <button class="btn btn-info w-100 fw-bold py-2 mb-3 text-dark">Utwórz konto</button>-->
<!--        <div class="text-center"><a href="#" onclick="showView('login')" class="text-decoration-none text-light">Powrót do logowania</a></div>-->
<!--      </form>-->
<!--    </div>-->
<!--  </div>-->

<!--  <div id="dashboard-view" style="display: none;">-->
<!--    <div class="row g-4 mb-4">-->
<!--      <div class="col-md-6">-->
<!--        <div class="card h-100">-->
<!--          <div class="card-header bg-success bg-opacity-25 fw-bold border-success"><i class="fas fa-plus-circle me-2"></i>Rejestracja Urządzenia</div>-->
<!--          <div class="card-body d-flex align-items-center">-->
<!--            <div class="input-group">-->
<!--              <span class="input-group-text bg-dark border-secondary"><i class="fas fa-barcode"></i></span>-->
<!--              <input type="text" id="newLampId" class="form-control bg-dark text-white border-secondary" placeholder="Serial Number (np. lamp_01)">-->
<!--              <button onclick="addLamp()" class="btn btn-success">Dodaj</button>-->
<!--            </div>-->
<!--          </div>-->
<!--        </div>-->
<!--      </div>-->
<!--      <div class="col-md-6">-->
<!--        <div class="card h-100 border-warning bg-dark">-->
<!--          <div class="card-header bg-warning text-dark bg-opacity-75 fw-bold"><i class="fas fa-cloud-upload-alt me-2"></i>Aktualizacja Firmware (OTA)</div>-->
<!--          <div class="card-body">-->
<!--            <form onsubmit="handleOtaUpload(event)">-->
<!--              <div class="input-group input-group-sm mb-2">-->
<!--                <span class="input-group-text bg-dark border-secondary text-light">URL</span>-->
<!--                <input type="url" id="otaUrl" class="form-control bg-dark text-white border-secondary" placeholder="http://server.com/firmware.bin" required>-->
<!--              </div>-->
<!--              <div class="row g-2">-->
<!--                <div class="col-4">-->
<!--                  <select id="otaTargetType" class="form-select form-select-sm bg-dark text-white border-secondary">-->
<!--                    <option value="lamp">Lampa</option>-->
<!--                    <option value="fleet">Flota</option>-->
<!--                  </select>-->
<!--                </div>-->
<!--                <div class="col-8">-->
<!--                  <input type="text" id="otaTargetId" class="form-control form-control-sm bg-dark text-white border-secondary" placeholder="ID Celu" required>-->
<!--                </div>-->
<!--              </div>-->
<!--              <button type="submit" class="btn btn-sm btn-outline-warning w-100 mt-2">Wyślij Rozkaz Aktualizacji</button>-->
<!--            </form>-->
<!--          </div>-->
<!--        </div>-->
<!--      </div>-->
<!--    </div>-->

<!--    <div class="row g-4">-->
<!--      <div class="col-lg-8">-->
<!--        <div class="d-flex justify-content-between align-items-center mb-3 border-bottom border-secondary pb-2">-->
<!--          <h4 class="m-0"><i class="fas fa-lightbulb text-warning me-2"></i>Twoje Urządzenia</h4>-->
<!--          <button onclick="loadLamps()" class="btn btn-sm btn-outline-light"><i class="fas fa-sync-alt"></i></button>-->
<!--        </div>-->
<!--        <div id="lamp-grid" class="row row-cols-1 row-cols-md-2 g-3"></div>-->
<!--      </div>-->

<!--      <div class="col-lg-4">-->
<!--        <div class="card mb-4">-->
<!--          <div class="card-header bg-primary bg-gradient text-white fw-bold"><i class="fas fa-layer-group me-2"></i>Zarządzanie Flotami</div>-->
<!--          <div class="card-body p-2">-->
<!--            <div class="input-group mb-3">-->
<!--              <input type="text" id="newFleetName" class="form-control form-control-sm bg-dark text-white border-secondary" placeholder="Nazwa nowej floty">-->
<!--              <button onclick="createFleet()" class="btn btn-sm btn-primary"><i class="fas fa-plus"></i></button>-->
<!--            </div>-->
<!--            <ul class="list-group list-group-flush small" id="fleet-list"></ul>-->
<!--          </div>-->
<!--        </div>-->

<!--        <div class="alert alert-secondary d-flex align-items-center" role="alert">-->
<!--          <i class="fas fa-info-circle me-2"></i>-->
<!--          <small>Grupuj lampy, aby sterować nimi jednocześnie.</small>-->
<!--        </div>-->
<!--      </div>-->
<!--    </div>-->
<!--  </div>-->

<!--  <div id="stats-view" style="display: none;">-->
<!--    <h3 class="mb-4 text-info"><i class="fas fa-chart-line me-2"></i>Centrum Danych</h3>-->

<!--    <div id="admin-stats-panel" class="card mb-5 border-warning" style="display: none;">-->
<!--      <div class="card-header bg-warning text-dark fw-bold"><i class="fas fa-user-secret me-2"></i>Panel Administratora</div>-->
<!--      <div class="card-body">-->
<!--        <div class="row text-center mb-4">-->
<!--          <div class="col-md-3"><h2 id="adm-users" class="text-warning fw-bold">0</h2><small>Użytkowników</small></div>-->
<!--          <div class="col-md-3"><h2 id="adm-lamps" class="text-light fw-bold">0</h2><small>Wszystkie Lampy</small></div>-->
<!--          <div class="col-md-3"><h2 id="adm-online" class="text-success fw-bold">0</h2><small>Globalnie Online</small></div>-->
<!--          <div class="col-md-3"><h2 id="adm-temp" class="text-info fw-bold">0°C</h2><small>Śr. Temperatura</small></div>-->
<!--        </div>-->
<!--        <div class="row">-->
<!--          <div class="col-md-4"><div class="chart-box"><canvas id="adminStatusChart"></canvas></div></div>-->
<!--          <div class="col-md-4"><div class="chart-box"><canvas id="adminColorChart"></canvas></div></div>-->
<!--          <div class="col-md-4"><div class="chart-box"><canvas id="adminTempChart"></canvas></div></div>-->
<!--        </div>-->
<!--      </div>-->
<!--    </div>-->

<!--    <div class="card border-primary">-->
<!--      <div class="card-header bg-primary text-white fw-bold">Twoje Statystyki</div>-->
<!--      <div class="card-body">-->
<!--        <div class="row text-center mb-4">-->
<!--          <div class="col-3"><h3 id="my-lamps" class="text-primary fw-bold">0</h3><small>Lampy</small></div>-->
<!--          <div class="col-3"><h3 id="my-online" class="text-success fw-bold">0</h3><small>Włączone</small></div>-->
<!--          <div class="col-3"><h3 id="my-offline" class="text-secondary fw-bold">0</h3><small>Wyłączone</small></div>-->
<!--          <div class="col-3"><h3 id="my-temp" class="text-info fw-bold">0°C</h3><small>Śr. Temp</small></div>-->
<!--        </div>-->
<!--        <div class="row justify-content-center">-->
<!--          <div class="col-md-5"><h6 class="text-center text-muted">Rozkład Kolorów</h6><div class="chart-box"><canvas id="userColorChart"></canvas></div></div>-->
<!--          <div class="col-md-5"><h6 class="text-center text-muted">Średnia Temperatura</h6><div class="chart-box"><canvas id="userTempChart"></canvas></div></div>-->
<!--        </div>-->
<!--      </div>-->
<!--    </div>-->
<!--  </div>-->

<!--</main>-->

<!--<div class="modal fade" id="controlModal" tabindex="-1">-->
<!--  <div class="modal-dialog modal-dialog-centered">-->
<!--    <div class="modal-content bg-dark text-white border-secondary">-->
<!--      <div class="modal-header border-secondary">-->
<!--        <h5 class="modal-title" id="modalTitle">Sterowanie</h5>-->
<!--        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>-->
<!--      </div>-->
<!--      <div class="modal-body">-->
<!--        <div class="alert alert-info py-2 small" id="targetInfo"></div>-->
<!--        <div class="d-flex justify-content-center gap-4 mb-4">-->
<!--          <button onclick="sendProtoCmd('ON')" class="btn btn-lg btn-success px-5 fw-bold shadow">ON</button>-->
<!--          <button onclick="sendProtoCmd('OFF')" class="btn btn-lg btn-danger px-5 fw-bold shadow">OFF</button>-->
<!--        </div>-->
<!--        <hr class="border-secondary">-->
<!--        <h6 class="mb-3 text-muted">Konfiguracja</h6>-->
<!--        <div class="mb-3">-->
<!--          <label class="form-label d-flex justify-content-between"><span>Jasność</span> <span id="briVal" class="badge bg-primary">50%</span></label>-->
<!--          <input type="range" id="confBri" class="form-range" min="0" max="100" oninput="document.getElementById('briVal').innerText=this.value+'%'">-->
<!--        </div>-->
<!--        <div class="row mb-3">-->
<!--          <div class="col-6">-->
<!--            <label class="form-label">Kolor</label>-->
<!--            <input type="color" id="confCol" class="form-control form-control-color w-100 bg-secondary border-0" value="#ffffff" title="Wybierz kolor">-->
<!--          </div>-->
<!--          <div class="col-6">-->
<!--            <label class="form-label">Raportowanie (s)</label>-->
<!--            <input type="number" id="confInt" class="form-control bg-dark text-white border-secondary" value="60">-->
<!--          </div>-->
<!--        </div>-->
<!--        <button onclick="sendProtoConfig()" class="btn btn-primary w-100 mt-2"><i class="fas fa-save me-2"></i>Wyślij Konfigurację</button>-->
<!--      </div>-->
<!--    </div>-->
<!--  </div>-->
<!--</div>-->

<!--<div class="modal fade" id="detailsModal" tabindex="-1">-->
<!--  <div class="modal-dialog modal-lg modal-dialog-centered">-->
<!--    <div class="modal-content bg-dark text-white border-secondary">-->
<!--      <div class="modal-header border-secondary">-->
<!--        <h5 class="modal-title"><i class="fas fa-chart-area me-2 text-info"></i>Telemetria: <span id="detLampId"></span></h5>-->
<!--        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>-->
<!--      </div>-->
<!--      <div class="modal-body">-->
<!--        <div class="row mb-3">-->
<!--          <div class="col-md-4">-->
<!--            <div class="p-3 border border-secondary rounded text-center bg-secondary bg-opacity-10">-->
<!--              <small class="text-muted d-block">Czas pracy (Uptime)</small>-->
<!--              <span id="detUptime" class="fs-5 fw-bold text-success">&#45;&#45;</span>-->
<!--            </div>-->
<!--          </div>-->
<!--          <div class="col-md-4">-->
<!--            <div class="p-3 border border-secondary rounded text-center bg-secondary bg-opacity-10">-->
<!--              <small class="text-muted d-block">Moc (W)</small>-->
<!--              <span id="detPower" class="fs-5 fw-bold text-warning">&#45;&#45;</span>-->
<!--            </div>-->
<!--          </div>-->
<!--          <div class="col-md-4">-->
<!--            <div class="p-3 border border-secondary rounded text-center bg-secondary bg-opacity-10">-->
<!--              <small class="text-muted d-block">Jasność (Sensor)</small>-->
<!--              <span id="detLux" class="fs-5 fw-bold text-info">&#45;&#45;</span>-->
<!--            </div>-->
<!--          </div>-->
<!--        </div>-->
<!--        <h6 class="text-muted">Historia Temperatury</h6>-->
<!--        <div class="chart-box">-->
<!--          <canvas id="detailsChart"></canvas>-->
<!--        </div>-->
<!--      </div>-->
<!--    </div>-->
<!--  </div>-->
<!--</div>-->

<!--<div class="modal fade" id="profileModal" tabindex="-1">-->
<!--  <div class="modal-dialog modal-dialog-centered">-->
<!--    <div class="modal-content bg-dark text-white border-secondary">-->
<!--      <div class="modal-header border-secondary">-->
<!--        <h5 class="modal-title"><i class="fas fa-user-cog me-2"></i>Ustawienia Konta</h5>-->
<!--        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>-->
<!--      </div>-->
<!--      <div class="modal-body">-->
<!--        <ul class="nav nav-tabs border-secondary mb-3" id="profileTabs" role="tablist">-->
<!--          <li class="nav-item"><button class="nav-link active text-light" data-bs-toggle="tab" data-bs-target="#tab-general">Ogólne</button></li>-->
<!--          <li class="nav-item"><button class="nav-link text-light" data-bs-toggle="tab" data-bs-target="#tab-security">Bezpieczeństwo</button></li>-->
<!--        </ul>-->
<!--        <div class="tab-content">-->
<!--          <div class="tab-pane fade show active" id="tab-general">-->
<!--            <form onsubmit="updateProfile(event)">-->
<!--              <div class="mb-3">-->
<!--                <label class="form-label">Nazwa użytkownika</label>-->
<!--                <input type="text" id="profUsername" class="form-control bg-dark text-white border-secondary">-->
<!--              </div>-->
<!--              <button class="btn btn-success w-100">Zapisz zmiany</button>-->
<!--            </form>-->
<!--            <hr class="border-secondary my-4">-->
<!--            <button onclick="deleteAccount()" class="btn btn-outline-danger w-100"><i class="fas fa-trash me-2"></i>Usuń konto trwale</button>-->
<!--          </div>-->
<!--          <div class="tab-pane fade" id="tab-security">-->
<!--            <form onsubmit="changePassword(event)">-->
<!--              <div class="mb-3">-->
<!--                <label class="form-label">Obecne hasło</label>-->
<!--                <input type="password" id="passOld" class="form-control bg-dark text-white border-secondary" required>-->
<!--              </div>-->
<!--              <div class="mb-3">-->
<!--                <label class="form-label">Nowe hasło</label>-->
<!--                <input type="password" id="passNew" class="form-control bg-dark text-white border-secondary" required>-->
<!--              </div>-->
<!--              <button class="btn btn-warning text-dark w-100">Zmień hasło</button>-->
<!--            </form>-->
<!--          </div>-->
<!--        </div>-->
<!--      </div>-->
<!--    </div>-->
<!--  </div>-->
<!--</div>-->

<!--<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>-->
<!--<script src="https://cdn.jsdelivr.net/npm/protobufjs@7.2.4/dist/protobuf.min.js"></script>-->

<!--<script>-->
<!--  const API = window.location.origin;-->
<!--  //const API = "http://localhost:8080"; // Uncomment for local dev if backend is on 8080-->
<!--  let token = localStorage.getItem('jwt');-->
<!--  let myFleets = [];-->
<!--  let charts = {};-->
<!--  let currentTarget = { type: 'lamp', id: null };-->

<!--  // -&#45;&#45; PROTOBUF DEFINITIONS -&#45;&#45;-->
<!--  let LampCommand, LampConfig, StatusReport;-->
<!--  async function loadProtoDef() {-->
<!--    try {-->
<!--      // Definicja musi pasować do Twojego pliku .proto w backendzie-->
<!--      let protoDef = `-->
<!--        syntax = "proto3"; package com.iot.backend.proto;-->
<!--        message LampCommand { enum Type { ON=0; OFF=1; REBOOT=2; OTA_UPDATE=3; } Type type=1; string ota_url=2; }-->
<!--        message LampConfig { int32 brightness=1; string color=2; int32 report_interval=3; }-->
<!--        message StatusReport {-->
<!--            uint32 version=1;-->
<!--            int64 ts=2;-->
<!--            uint32 uptime_seconds=3;-->
<!--            repeated double temperature_readings=4;-->
<!--            float power_consumption_watts=5;-->
<!--            float brightness_level=6;-->
<!--        }-->
<!--      `;-->
<!--      const root = protobuf.parse(protoDef).root;-->
<!--      LampCommand = root.lookupType("com.iot.backend.proto.LampCommand");-->
<!--      LampConfig = root.lookupType("com.iot.backend.proto.LampConfig");-->
<!--      StatusReport = root.lookupType("com.iot.backend.proto.StatusReport");-->
<!--    } catch(e) { console.error("Proto error", e); }-->
<!--  }-->

<!--  // -&#45;&#45; INIT -&#45;&#45;-->
<!--  (async function(){-->
<!--    await loadProtoDef();-->
<!--    if(token) init(); else showView('login');-->
<!--  })();-->

<!--  function showView(viewName) {-->
<!--    // Hide all-->
<!--    ['login-view','register-view','dashboard-view','stats-view','navbar'].forEach(id => document.getElementById(id).style.display='none');-->
<!--    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));-->

<!--    if(viewName === 'login') document.getElementById('login-view').style.display = 'block';-->
<!--    if(viewName === 'register') document.getElementById('register-view').style.display = 'block';-->

<!--    if(viewName === 'dashboard' || viewName === 'stats') {-->
<!--      document.getElementById(viewName+'-view').style.display = 'block';-->
<!--      document.getElementById('navbar').style.display = 'block';-->
<!--      // Highlight nav item-->
<!--      if(viewName === 'dashboard') document.querySelectorAll('.nav-link')[0].classList.add('active');-->
<!--      if(viewName === 'stats') {-->
<!--        document.querySelectorAll('.nav-link')[1].classList.add('active');-->
<!--        loadStats();-->
<!--      }-->
<!--    }-->
<!--  }-->

<!--  // -&#45;&#45; AUTH FETCH (POPRAWIONY) -&#45;&#45;-->
<!--  async function authFetch(url, opts={}) {-->
<!--    document.getElementById('loader').style.display = 'flex';-->
<!--    opts.headers = opts.headers || {};-->
<!--    opts.headers['Authorization'] = `Bearer ${token}`;-->
<!--    if(opts.body && !opts.headers['Content-Type']) opts.headers['Content-Type']='application/json';-->

<!--    try {-->
<!--      const res = await fetch(url, opts);-->
<!--      document.getElementById('loader').style.display = 'none';-->

<!--      // Obsługa wygasłego tokena (401)-->
<!--      if(res.status === 401) { logout(); return null; }-->

<!--      // Obsługa braku dostępu (403) - nie wylogowuje, tylko loguje błąd-->
<!--      if(res.status === 403) { console.warn("403 Forbidden:", url); return res; }-->

<!--      return res;-->
<!--    } catch(e) {-->
<!--      document.getElementById('loader').style.display = 'none';-->
<!--      console.error("Network error", e);-->
<!--      return null;-->
<!--    }-->
<!--  }-->

<!--  async function handleLogin(e) {-->
<!--    e.preventDefault();-->
<!--    const u = document.getElementById('loginUser').value;-->
<!--    const p = document.getElementById('loginPass').value;-->
<!--    try {-->
<!--      const res = await fetch(`${API}/auth/login`, {-->
<!--        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({username: u, password: p})-->
<!--      });-->
<!--      if(!res.ok) throw new Error();-->
<!--      const data = await res.json();-->
<!--      token = data.accessToken;-->
<!--      localStorage.setItem('jwt', token);-->
<!--      localStorage.setItem('user', u);-->
<!--      init();-->
<!--    } catch(e) { alert('Błąd logowania. Sprawdź dane.'); }-->
<!--  }-->

<!--  async function handleRegister(e) {-->
<!--    e.preventDefault();-->
<!--    const u = document.getElementById('regUser').value;-->
<!--    const p = document.getElementById('regPass').value;-->
<!--    const res = await fetch(`${API}/users`, {-->
<!--      method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({username: u, password: p})-->
<!--    });-->
<!--    if(res.ok) { alert("Konto utworzone!"); showView('login'); }-->
<!--    else alert("Błąd rejestracji (może login zajęty?)");-->
<!--  }-->

<!--  function init() {-->
<!--    showView('dashboard');-->
<!--    document.getElementById('nav-username').innerText = localStorage.getItem('user');-->
<!--    refreshAll();-->
<!--  }-->

<!--  function logout() { localStorage.removeItem('jwt'); location.reload(); }-->

<!--  // -&#45;&#45; PROFILE MANAGEMENT -&#45;&#45;-->
<!--  function openProfileModal() {-->
<!--    document.getElementById('profUsername').value = localStorage.getItem('user');-->
<!--    new bootstrap.Modal(document.getElementById('profileModal')).show();-->
<!--  }-->

<!--  async function updateProfile(e) {-->
<!--    e.preventDefault();-->
<!--    const newName = document.getElementById('profUsername').value;-->
<!--    const res = await authFetch(`${API}/users/me`, { method: 'PUT', body: JSON.stringify({username: newName}) });-->
<!--    if(res && res.ok) {-->
<!--      localStorage.setItem('user', newName);-->
<!--      alert('Nazwa zmieniona!');-->
<!--      location.reload();-->
<!--    } else {-->
<!--      alert('Błąd zmiany nazwy.');-->
<!--    }-->
<!--  }-->

<!--  async function changePassword(e) {-->
<!--    e.preventDefault();-->
<!--    const oldP = document.getElementById('passOld').value;-->
<!--    const newP = document.getElementById('passNew').value;-->
<!--    const res = await authFetch(`${API}/users/me/password`, { method: 'PUT', body: JSON.stringify({currentPassword: oldP, newPassword: newP}) });-->
<!--    if(res && res.ok) { alert('Hasło zmienione!'); }-->
<!--    else { alert('Błąd! Sprawdź stare hasło.'); }-->
<!--  }-->

<!--  async function deleteAccount() {-->
<!--    if(confirm('CZY NA PEWNO? To usunie twoje konto i odepnie wszystkie lampy.')) {-->
<!--      await authFetch(`${API}/users/me`, {method:'DELETE'});-->
<!--      logout();-->
<!--    }-->
<!--  }-->

<!--  // -&#45;&#45; CORE DATA -&#45;&#45;-->
<!--  async function refreshAll() { await loadFleets(); await loadLamps(); }-->

<!--  async function loadFleets() {-->
<!--    const res = await authFetch(`${API}/fleets`);-->
<!--    if(!res) return;-->
<!--    myFleets = await res.json();-->
<!--    const list = document.getElementById('fleet-list');-->
<!--    list.innerHTML = '';-->
<!--    myFleets.forEach(f => {-->
<!--      list.innerHTML += `-->
<!--        <li class="list-group-item bg-dark text-white border-secondary d-flex justify-content-between align-items-center p-2">-->
<!--            <div class="d-flex align-items-center">-->
<!--              <i class="fas fa-folder text-primary me-2"></i>-->
<!--              <span class="fw-bold">${f.name}</span>-->
<!--              <span class="badge bg-secondary ms-2 small">ID:${f.id}</span>-->
<!--            </div>-->
<!--            <div>-->
<!--              <button onclick="openModal('fleet', ${f.id})" class="btn btn-action btn-sm btn-outline-info me-1" title="Steruj grupą"><i class="fas fa-sliders-h"></i></button>-->
<!--              <button onclick="deleteFleet(${f.id})" class="btn btn-action btn-sm btn-outline-danger" title="Usuń flotę"><i class="fas fa-trash-alt"></i></button>-->
<!--            </div>-->
<!--        </li>`;-->
<!--    });-->
<!--  }-->

<!--  async function createFleet() {-->
<!--    const name = document.getElementById('newFleetName').value;-->
<!--    if(!name) return;-->
<!--    await authFetch(`${API}/fleets`, { method: 'POST', body: JSON.stringify({name}) });-->
<!--    document.getElementById('newFleetName').value=''; refreshAll();-->
<!--  }-->

<!--  async function deleteFleet(id) {-->
<!--    if(confirm("Czy usunąć tę flotę? Lampy zostaną zachowane (odpięte).")) {-->
<!--      await authFetch(`${API}/fleets/${id}`, { method: 'DELETE' });-->
<!--      refreshAll();-->
<!--    }-->
<!--  }-->

<!--  async function loadLamps() {-->
<!--    const res = await authFetch(`${API}/users/me/lamps`);-->
<!--    if(!res) return;-->
<!--    let lamps = await res.json();-->

<!--    // Sortowanie: Bez floty -> Z flotą (po ID floty) -> Nazwa-->
<!--    lamps.sort((a, b) => {-->
<!--      const fA = a.fleetId; const fB = b.fleetId;-->
<!--      if (!fA && !fB) return a.id.localeCompare(b.id);-->
<!--      if (!fA) return -1;-->
<!--      if (!fB) return 1;-->
<!--      if (fA !== fB) return fA - fB;-->
<!--      return a.id.localeCompare(b.id);-->
<!--    });-->

<!--    const grid = document.getElementById('lamp-grid');-->
<!--    grid.innerHTML = '';-->

<!--    lamps.forEach(lamp => {-->
<!--      let optionsHtml = '<option value="" disabled selected>Wybierz flotę</option>';-->
<!--      myFleets.forEach(f => { optionsHtml += `<option value="${f.id}">${f.name}</option>`; });-->

<!--      let fleetSec = lamp.fleetId-->
<!--              ? `<div class="d-flex justify-content-between align-items-center bg-secondary bg-opacity-25 rounded p-1 mb-2">-->
<!--                   <small class="text-info mx-2"><i class="fas fa-link me-1"></i>Flota: ${lamp.fleetId}</small>-->
<!--                   <button onclick="removeFromFleet(${lamp.fleetId}, '${lamp.id}')" class="btn btn-action btn-sm btn-outline-warning border-0" title="Odepnij"><i class="fas fa-unlink"></i></button>-->
<!--                 </div>`-->
<!--              : `<div class="input-group input-group-sm mb-2">-->
<!--                   <select id="sel-${lamp.id}" class="form-select bg-dark text-white border-secondary py-0" style="font-size:0.8rem">${optionsHtml}</select>-->
<!--                   <button onclick="assignToFleet('${lamp.id}')" class="btn btn-outline-secondary"><i class="fas fa-plus"></i></button>-->
<!--                 </div>`;-->

<!--      grid.innerHTML += `-->
<!--        <div class="col"><div class="card h-100 border-secondary">-->
<!--          <div class="card-body p-3 d-flex flex-column">-->
<!--            <div class="d-flex justify-content-between align-items-start mb-2">-->
<!--                <div>-->
<!--                  <h5 class="card-title m-0 text-truncate fw-bold text-light" title="${lamp.id}">${lamp.id}</h5>-->
<!--                  <span class="badge ${lamp.on ? 'bg-success':'bg-danger'} text-dark rounded-pill" style="font-size:0.6rem">${lamp.on ? 'ON':'OFF'}</span>-->
<!--                </div>-->
<!--                <span class="status-dot ${lamp.on ? 'status-on':'status-off'} mt-1"></span>-->
<!--            </div>-->

<!--            ${fleetSec}-->

<!--            <div class="mt-auto d-flex gap-2">-->
<!--                <button onclick="openModal('lamp', '${lamp.id}')" class="btn btn-sm btn-primary flex-grow-1"><i class="fas fa-sliders-h me-1"></i></button>-->
<!--                <button onclick="openLampDetails('${lamp.id}')" class="btn btn-sm btn-outline-info" title="Wykresy"><i class="fas fa-chart-area"></i></button>-->
<!--                <button onclick="delLamp('${lamp.id}')" class="btn btn-sm btn-outline-danger" title="Usuń"><i class="fas fa-trash"></i></button>-->
<!--            </div>-->
<!--        </div></div></div>`;-->
<!--    });-->
<!--  }-->

<!--  // -&#45;&#45; LAMP OPERATIONS -&#45;&#45;-->
<!--  async function addLamp() {-->
<!--    const id = document.getElementById('newLampId').value;-->
<!--    if(!id) return;-->
<!--    const res = await authFetch(`${API}/users/me/lamps`, { method:'POST', body: JSON.stringify({lampId: id}) });-->
<!--    if(res && res.ok) {-->
<!--      const data = await res.json();-->
<!--      alert("Lampa dodana!\n\nTOKEN URZĄDZENIA (Ważne!):\n" + data.device_token);-->
<!--      document.getElementById('newLampId').value=''; loadLamps();-->
<!--    }-->
<!--  }-->
<!--  async function delLamp(id) {-->
<!--    if(confirm(`Usunąć lampę ${id}?`)) {-->
<!--      await authFetch(`${API}/users/me/lamps/${id}`, {method:'DELETE'});-->
<!--      loadLamps();-->
<!--    }-->
<!--  }-->
<!--  async function assignToFleet(lId) {-->
<!--    const fId = document.getElementById(`sel-${lId}`).value;-->
<!--    if(!fId) return;-->
<!--    await authFetch(`${API}/fleets/${fId}/lamps/${lId}`, { method: 'POST' });-->
<!--    loadLamps();-->
<!--  }-->
<!--  async function removeFromFleet(fId, lId) {-->
<!--    if(confirm('Odpiąć z floty?')) {-->
<!--      await authFetch(`${API}/fleets/${fId}/lamps/${lId}`, { method: 'DELETE' });-->
<!--      loadLamps();-->
<!--    }-->
<!--  }-->

<!--  // -&#45;&#45; CONTROL MODAL -&#45;&#45;-->
<!--  async function openModal(type, id) {-->
<!--    currentTarget = { type: type, id: id };-->
<!--    document.getElementById('modalTitle').innerText = (type==='lamp') ? `Lampa: ${id}` : `Flota: ${id}`;-->
<!--    document.getElementById('targetInfo').innerText = (type==='fleet') ? "Sterowanie grupowe." : "Sterowanie indywidualne.";-->

<!--    // Defaults-->
<!--    document.getElementById('confBri').value = 50;-->
<!--    document.getElementById('briVal').innerText = "50%";-->
<!--    document.getElementById('confCol').value = "#ffffff";-->
<!--    document.getElementById('confInt').value = 60;-->

<!--    if(type === 'lamp') {-->
<!--      try {-->
<!--        const res = await fetch(`${API}/lamps/${id}/config`, { headers: { 'Authorization': `Bearer ${token}` } });-->
<!--        if(res.ok) {-->
<!--          const buffer = await res.arrayBuffer();-->
<!--          const decoded = LampConfig.decode(new Uint8Array(buffer));-->
<!--          if(decoded.brightness) {-->
<!--            document.getElementById('confBri').value = decoded.brightness;-->
<!--            document.getElementById('briVal').innerText = decoded.brightness+"%";-->
<!--          }-->
<!--          if(decoded.color) document.getElementById('confCol').value = decoded.color;-->
<!--          if(decoded.report_interval) document.getElementById('confInt').value = decoded.report_interval;-->
<!--        }-->
<!--      } catch(e) {}-->
<!--    }-->
<!--    new bootstrap.Modal(document.getElementById('controlModal')).show();-->
<!--  }-->

<!--  async function sendBin(url, body, method='POST') {-->
<!--    document.getElementById('loader').style.display='flex';-->
<!--    const res = await fetch(url, { method: method, headers: {'Authorization':`Bearer ${token}`, 'Content-Type':'application/x-protobuf'}, body: body });-->
<!--    document.getElementById('loader').style.display='none';-->
<!--    if(!res.ok) alert('Błąd wysyłania komendy');-->
<!--    return res;-->
<!--  }-->

<!--  async function sendProtoCmd(typeStr) {-->
<!--    const payload = { type: (typeStr==='ON'?0:1) };-->
<!--    const buf = LampCommand.encode(LampCommand.create(payload)).finish();-->
<!--    const url = (currentTarget.type === 'lamp') ? `${API}/lamps/${currentTarget.id}/command` : `${API}/fleets/${currentTarget.id}/command`;-->
<!--    await sendBin(url, buf);-->
<!--    if(currentTarget.type==='lamp') setTimeout(loadLamps, 800);-->
<!--  }-->

<!--  async function sendProtoConfig() {-->
<!--    const payload = {-->
<!--      brightness: parseInt(document.getElementById('confBri').value),-->
<!--      color: document.getElementById('confCol').value,-->
<!--      report_interval: parseInt(document.getElementById('confInt').value)-->
<!--    };-->
<!--    const buf = LampConfig.encode(LampConfig.create(payload)).finish();-->
<!--    const url = (currentTarget.type === 'lamp') ? `${API}/lamps/${currentTarget.id}/config` : `${API}/fleets/${currentTarget.id}/config`;-->
<!--    await sendBin(url, buf, 'PUT');-->
<!--    setTimeout(loadLamps, 500);-->
<!--  }-->

<!--  // -&#45;&#45; OTA -&#45;&#45;-->
<!--  async function handleOtaUpload(e) {-->
<!--    e.preventDefault();-->
<!--    const urlStr = document.getElementById('otaUrl').value;-->
<!--    const targetType = document.getElementById('otaTargetType').value;-->
<!--    const targetId = document.getElementById('otaTargetId').value;-->

<!--    if(!urlStr || !targetId) return;-->

<!--    // Tworzymy komendę z Typem 3 (OTA) i URL-em-->
<!--    const payload = { type: 3, ota_url: urlStr };-->
<!--    const buf = LampCommand.encode(LampCommand.create(payload)).finish();-->

<!--    const endpoint = (targetType === 'lamp') ? `${API}/lamps/${targetId}/command` : `${API}/fleets/${targetId}/command`;-->

<!--    if(confirm(`Wysłać OTA ${urlStr} do ${targetId}?`)) {-->
<!--      await sendBin(endpoint, buf);-->
<!--      alert("Rozkaz aktualizacji wysłany!");-->
<!--    }-->
<!--  }-->

<!--  // -&#45;&#45; DETAILS & CHARTS -&#45;&#45;-->
<!--  async function openLampDetails(id) {-->
<!--    document.getElementById('detLampId').innerText = id;-->

<!--    // Clear previous data-->
<!--    document.getElementById('detUptime').innerText = "...";-->
<!--    document.getElementById('detPower').innerText = "...";-->
<!--    document.getElementById('detLux').innerText = "...";-->

<!--    // Show modal first-->
<!--    const modal = new bootstrap.Modal(document.getElementById('detailsModal'));-->
<!--    modal.show();-->

<!--    try {-->
<!--      const res = await fetch(`${API}/lamps/${id}/status`, {-->
<!--        headers: {'Authorization': `Bearer ${token}`, 'Accept': 'application/x-protobuf'}-->
<!--      });-->

<!--      if(res.ok) {-->
<!--        const buffer = await res.arrayBuffer();-->
<!--        const report = StatusReport.decode(new Uint8Array(buffer));-->

<!--        // Fill basics-->
<!--        const uptimeHrs = (report.uptime_seconds / 3600).toFixed(1);-->
<!--        document.getElementById('detUptime').innerText = `${uptimeHrs}h`;-->
<!--        document.getElementById('detPower').innerText = (report.power_consumption_watts || 0).toFixed(1);-->
<!--        document.getElementById('detLux').innerText = (report.brightness_level || 0).toFixed(0);-->

<!--        // Render Chart-->
<!--        const temps = report.temperature_readings || [];-->
<!--        // Create fake labels (Latest is last)-->
<!--        const labels = temps.map((_, i) => `Pomiar ${i+1}`);-->

<!--        renderChart('detailsChart', 'line', labels, temps, 'Temperatura (°C)', ['#e74c3c']);-->
<!--      } else {-->
<!--        document.getElementById('detUptime').innerText = "Brak danych";-->
<!--      }-->
<!--    } catch(e) {-->
<!--      console.error("Chart error", e);-->
<!--    }-->
<!--  }-->

<!--  // -&#45;&#45; STATS LOGIC -&#45;&#45;-->
<!--  async function loadStats() {-->
<!--    const user = localStorage.getItem('user');-->
<!--    // User stats-->
<!--    try {-->
<!--      const res = await authFetch(`${API}/stats/me`);-->
<!--      if(res && res.ok) {-->
<!--        const data = await res.json();-->
<!--        document.getElementById('my-lamps').innerText = data.totalLamps;-->
<!--        document.getElementById('my-online').innerText = data.onlineLamps;-->
<!--        document.getElementById('my-offline').innerText = data.offlineLamps;-->
<!--        document.getElementById('my-temp').innerText = (data.averageTemperature || 0).toFixed(1) + '°C';-->

<!--        renderChart('userColorChart', 'doughnut', Object.keys(data.colorDistribution), Object.values(data.colorDistribution), 'Kolory');-->
<!--        renderChart('userTempChart', 'bar', ['Twoja Średnia'], [data.averageTemperature], 'Temp °C', ['#3498db']);-->
<!--      }-->
<!--    } catch(e){}-->

<!--    // Admin stats-->
<!--    if(user === 'admin') {-->
<!--      document.getElementById('admin-stats-panel').style.display = 'block';-->
<!--      try {-->
<!--        const res = await authFetch(`${API}/stats/global`);-->
<!--        if(res && res.ok) {-->
<!--          const data = await res.json();-->
<!--          document.getElementById('adm-users').innerText = data.totalUsers;-->
<!--          document.getElementById('adm-lamps').innerText = data.totalLamps;-->
<!--          document.getElementById('adm-online').innerText = data.onlineLamps;-->
<!--          document.getElementById('adm-temp').innerText = (data.averageTemperature || 0).toFixed(1) + '°C';-->

<!--          renderChart('adminStatusChart', 'pie', ['On', 'Off'], [data.onlineLamps, data.offlineLamps], 'Status', ['#2ecc71', '#e74c3c']);-->
<!--          renderChart('adminColorChart', 'doughnut', Object.keys(data.colorDistribution), Object.values(data.colorDistribution), 'Kolory');-->
<!--          renderChart('adminTempChart', 'bar', ['Globalna Średnia'], [data.averageTemperature], 'Temp °C', ['#f1c40f']);-->
<!--        }-->
<!--      } catch(e){}-->
<!--    } else {-->
<!--      document.getElementById('admin-stats-panel').style.display = 'none';-->
<!--    }-->
<!--  }-->

<!--  function renderChart(canvasId, type, labels, dataArr, label, colors = null) {-->
<!--    const ctx = document.getElementById(canvasId).getContext('2d');-->
<!--    if(charts[canvasId]) charts[canvasId].destroy();-->

<!--    let bgColors = colors;-->
<!--    if(!bgColors) bgColors = labels.map(c => c.startsWith('#') ? c : '#3498db');-->

<!--    charts[canvasId] = new Chart(ctx, {-->
<!--      type: type,-->
<!--      data: {-->
<!--        labels: labels,-->
<!--        datasets: [{ label: label, data: dataArr, backgroundColor: bgColors, borderColor: bgColors[0], borderWidth: 1, tension: 0.3 }]-->
<!--      },-->
<!--      options: {-->
<!--        responsive: true, maintainAspectRatio: false,-->
<!--        plugins: { legend: { display: type!=='bar' && type!=='line', labels: { color: '#ccc' } } },-->
<!--        scales: (type==='bar'||type==='line') ? { y: { beginAtZero: false, ticks:{color:'#999'} }, x:{ticks:{color:'#999'}} } : {}-->
<!--      }-->
<!--    });-->
<!--  }-->
<!--</script>-->
<!--</body>-->
<!--</html>-->

<!--&lt;!&ndash;<!DOCTYPE html>&ndash;&gt;-->
<!--&lt;!&ndash;<html lang="pl" data-bs-theme="dark">&ndash;&gt;-->
<!--&lt;!&ndash;<head>&ndash;&gt;-->
<!--&lt;!&ndash;  <meta charset="UTF-8">&ndash;&gt;-->
<!--&lt;!&ndash;  <meta name="viewport" content="width=device-width, initial-scale=1.0">&ndash;&gt;-->
<!--&lt;!&ndash;  <title>IoT Control Panel v5.0 (FLEETS & TEMP)</title>&ndash;&gt;-->
<!--&lt;!&ndash;  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">&ndash;&gt;-->
<!--&lt;!&ndash;  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>&ndash;&gt;-->
<!--&lt;!&ndash;  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">&ndash;&gt;-->

<!--&lt;!&ndash;  <style>&ndash;&gt;-->
<!--&lt;!&ndash;    body { background-color: #212529; color: #f8f9fa; font-family: 'Segoe UI', sans-serif; }&ndash;&gt;-->
<!--&lt;!&ndash;    .card { background-color: #2b3035; border: 1px solid #495057; }&ndash;&gt;-->
<!--&lt;!&ndash;    .status-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; }&ndash;&gt;-->
<!--&lt;!&ndash;    .status-on { background-color: #2ecc71; box-shadow: 0 0 8px #2ecc71; }&ndash;&gt;-->
<!--&lt;!&ndash;    .status-off { background-color: #e74c3c; }&ndash;&gt;-->
<!--&lt;!&ndash;    #loader {&ndash;&gt;-->
<!--&lt;!&ndash;      position: fixed; top: 0; left: 0; width: 100%; height: 100%;&ndash;&gt;-->
<!--&lt;!&ndash;      background: rgba(0,0,0,0.8); z-index: 9999; display: none;&ndash;&gt;-->
<!--&lt;!&ndash;      justify-content: center; align-items: center;&ndash;&gt;-->
<!--&lt;!&ndash;    }&ndash;&gt;-->
<!--&lt;!&ndash;    .auth-container { max-width: 400px; margin: 80px auto; }&ndash;&gt;-->
<!--&lt;!&ndash;    .chart-box { height: 200px; position: relative; }&ndash;&gt;-->
<!--&lt;!&ndash;  </style>&ndash;&gt;-->
<!--&lt;!&ndash;</head>&ndash;&gt;-->
<!--&lt;!&ndash;<body>&ndash;&gt;-->

<!--&lt;!&ndash;<div id="loader">&ndash;&gt;-->
<!--&lt;!&ndash;  <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>&ndash;&gt;-->
<!--&lt;!&ndash;</div>&ndash;&gt;-->

<!--&lt;!&ndash;<nav id="navbar" class="navbar navbar-expand-lg navbar-dark bg-dark border-bottom border-secondary mb-4" style="display: none;">&ndash;&gt;-->
<!--&lt;!&ndash;  <div class="container">&ndash;&gt;-->
<!--&lt;!&ndash;    <span class="navbar-brand"><i class="fas fa-network-wired text-primary"></i> IoT Manager</span>&ndash;&gt;-->
<!--&lt;!&ndash;    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">&ndash;&gt;-->
<!--&lt;!&ndash;      <span class="navbar-toggler-icon"></span>&ndash;&gt;-->
<!--&lt;!&ndash;    </button>&ndash;&gt;-->
<!--&lt;!&ndash;    <div class="collapse navbar-collapse" id="navbarNav">&ndash;&gt;-->
<!--&lt;!&ndash;      <ul class="navbar-nav me-auto">&ndash;&gt;-->
<!--&lt;!&ndash;        <li class="nav-item">&ndash;&gt;-->
<!--&lt;!&ndash;          <a class="nav-link active" href="#" onclick="showView('dashboard')"><i class="fas fa-home"></i> Pulpit</a>&ndash;&gt;-->
<!--&lt;!&ndash;        </li>&ndash;&gt;-->
<!--&lt;!&ndash;        <li class="nav-item">&ndash;&gt;-->
<!--&lt;!&ndash;          <a class="nav-link" href="#" onclick="showView('stats')"><i class="fas fa-chart-pie"></i> Statystyki</a>&ndash;&gt;-->
<!--&lt;!&ndash;        </li>&ndash;&gt;-->
<!--&lt;!&ndash;      </ul>&ndash;&gt;-->
<!--&lt;!&ndash;      <div class="d-flex align-items-center">&ndash;&gt;-->
<!--&lt;!&ndash;        <span id="nav-username" class="me-3 text-muted small">User</span>&ndash;&gt;-->
<!--&lt;!&ndash;        <button onclick="logout()" class="btn btn-outline-danger btn-sm"><i class="fas fa-power-off"></i></button>&ndash;&gt;-->
<!--&lt;!&ndash;      </div>&ndash;&gt;-->
<!--&lt;!&ndash;    </div>&ndash;&gt;-->
<!--&lt;!&ndash;  </div>&ndash;&gt;-->
<!--&lt;!&ndash;</nav>&ndash;&gt;-->

<!--&lt;!&ndash;<main class="container py-4">&ndash;&gt;-->

<!--&lt;!&ndash;  <div id="login-view" class="auth-container">&ndash;&gt;-->
<!--&lt;!&ndash;    <div class="card p-4 shadow-lg">&ndash;&gt;-->
<!--&lt;!&ndash;      <h3 class="text-center mb-4"><i class="fas fa-user-shield"></i> Logowanie</h3>&ndash;&gt;-->
<!--&lt;!&ndash;      <form onsubmit="handleLogin(event)">&ndash;&gt;-->
<!--&lt;!&ndash;        <div class="mb-3"><input type="text" id="loginUser" class="form-control" placeholder="Użytkownik" required></div>&ndash;&gt;-->
<!--&lt;!&ndash;        <div class="mb-3"><input type="password" id="loginPass" class="form-control" placeholder="Hasło" required></div>&ndash;&gt;-->
<!--&lt;!&ndash;        <button class="btn btn-primary w-100 fw-bold mb-3">Zaloguj się</button>&ndash;&gt;-->
<!--&lt;!&ndash;        <div class="text-center"><a href="#" onclick="showView('register')" class="text-decoration-none small text-info">Rejestracja</a></div>&ndash;&gt;-->
<!--&lt;!&ndash;      </form>&ndash;&gt;-->
<!--&lt;!&ndash;    </div>&ndash;&gt;-->
<!--&lt;!&ndash;  </div>&ndash;&gt;-->

<!--&lt;!&ndash;  <div id="register-view" class="auth-container" style="display: none;">&ndash;&gt;-->
<!--&lt;!&ndash;    <div class="card p-4 shadow-lg border-info">&ndash;&gt;-->
<!--&lt;!&ndash;      <h3 class="text-center mb-4 text-info"><i class="fas fa-user-plus"></i> Rejestracja</h3>&ndash;&gt;-->
<!--&lt;!&ndash;      <form onsubmit="handleRegister(event)">&ndash;&gt;-->
<!--&lt;!&ndash;        <div class="mb-3"><input type="text" id="regUser" class="form-control" placeholder="Login" required></div>&ndash;&gt;-->
<!--&lt;!&ndash;        <div class="mb-3"><input type="password" id="regPass" class="form-control" placeholder="Hasło" required></div>&ndash;&gt;-->
<!--&lt;!&ndash;        <button class="btn btn-info w-100 fw-bold mb-3 text-dark">Utwórz konto</button>&ndash;&gt;-->
<!--&lt;!&ndash;        <div class="text-center"><a href="#" onclick="showView('login')" class="text-decoration-none small text-light">Powrót do logowania</a></div>&ndash;&gt;-->
<!--&lt;!&ndash;      </form>&ndash;&gt;-->
<!--&lt;!&ndash;    </div>&ndash;&gt;-->
<!--&lt;!&ndash;  </div>&ndash;&gt;-->

<!--&lt;!&ndash;  <div id="dashboard-view" style="display: none;">&ndash;&gt;-->
<!--&lt;!&ndash;    <div class="row g-4 mb-4">&ndash;&gt;-->
<!--&lt;!&ndash;      <div class="col-md-6">&ndash;&gt;-->
<!--&lt;!&ndash;        <div class="card h-100">&ndash;&gt;-->
<!--&lt;!&ndash;          <div class="card-header bg-success text-white bg-opacity-25 fw-bold"><i class="fas fa-tools"></i> Dodaj Urządzenie</div>&ndash;&gt;-->
<!--&lt;!&ndash;          <div class="card-body">&ndash;&gt;-->
<!--&lt;!&ndash;            <div class="input-group">&ndash;&gt;-->
<!--&lt;!&ndash;              <span class="input-group-text bg-dark border-secondary"><i class="fas fa-barcode"></i></span>&ndash;&gt;-->
<!--&lt;!&ndash;              <input type="text" id="newLampId" class="form-control" placeholder="ID Lampy (np. lamp_01)">&ndash;&gt;-->
<!--&lt;!&ndash;              <button onclick="addLamp()" class="btn btn-success">Dodaj</button>&ndash;&gt;-->
<!--&lt;!&ndash;            </div>&ndash;&gt;-->
<!--&lt;!&ndash;          </div>&ndash;&gt;-->
<!--&lt;!&ndash;        </div>&ndash;&gt;-->
<!--&lt;!&ndash;      </div>&ndash;&gt;-->
<!--&lt;!&ndash;      <div class="col-md-6">&ndash;&gt;-->
<!--&lt;!&ndash;        <div class="card h-100 border-warning">&ndash;&gt;-->
<!--&lt;!&ndash;          <div class="card-header bg-warning text-dark bg-opacity-75 fw-bold"><i class="fas fa-microchip"></i> Panel OTA</div>&ndash;&gt;-->
<!--&lt;!&ndash;          <div class="card-body">&ndash;&gt;-->
<!--&lt;!&ndash;            <form onsubmit="handleOtaUpload(event)">&ndash;&gt;-->
<!--&lt;!&ndash;              <input type="file" id="otaFile" class="form-control form-control-sm bg-dark text-light border-secondary mb-2" required>&ndash;&gt;-->
<!--&lt;!&ndash;              <div class="row g-2">&ndash;&gt;-->
<!--&lt;!&ndash;                <div class="col-4">&ndash;&gt;-->
<!--&lt;!&ndash;                  <select id="otaTargetType" class="form-select form-select-sm bg-dark text-light border-secondary" onchange="toggleOtaTarget()">&ndash;&gt;-->
<!--&lt;!&ndash;                    <option value="lamp">Lampa</option>&ndash;&gt;-->
<!--&lt;!&ndash;                    <option value="fleet">Flota</option>&ndash;&gt;-->
<!--&lt;!&ndash;                  </select>&ndash;&gt;-->
<!--&lt;!&ndash;                </div>&ndash;&gt;-->
<!--&lt;!&ndash;                <div class="col-8">&ndash;&gt;-->
<!--&lt;!&ndash;                  <input type="text" id="otaTargetId" class="form-control form-control-sm bg-dark text-light border-secondary" placeholder="ID Lampy" required>&ndash;&gt;-->
<!--&lt;!&ndash;                </div>&ndash;&gt;-->
<!--&lt;!&ndash;              </div>&ndash;&gt;-->
<!--&lt;!&ndash;              <button type="submit" class="btn btn-sm btn-outline-warning w-100 mt-2">Wyślij Update</button>&ndash;&gt;-->
<!--&lt;!&ndash;            </form>&ndash;&gt;-->
<!--&lt;!&ndash;          </div>&ndash;&gt;-->
<!--&lt;!&ndash;        </div>&ndash;&gt;-->
<!--&lt;!&ndash;      </div>&ndash;&gt;-->
<!--&lt;!&ndash;    </div>&ndash;&gt;-->

<!--&lt;!&ndash;    <div class="row g-4">&ndash;&gt;-->
<!--&lt;!&ndash;      <div class="col-lg-8">&ndash;&gt;-->
<!--&lt;!&ndash;        <h4 class="mb-3 border-bottom pb-2 border-secondary">Twoje Urządzenia</h4>&ndash;&gt;-->
<!--&lt;!&ndash;        <div id="lamp-grid" class="row row-cols-1 row-cols-md-2 g-3"></div>&ndash;&gt;-->
<!--&lt;!&ndash;      </div>&ndash;&gt;-->

<!--&lt;!&ndash;      <div class="col-lg-4">&ndash;&gt;-->
<!--&lt;!&ndash;        <div class="card mb-4">&ndash;&gt;-->
<!--&lt;!&ndash;          <div class="card-header bg-primary text-white fw-bold"><i class="fas fa-layer-group"></i> Floty</div>&ndash;&gt;-->
<!--&lt;!&ndash;          <div class="card-body">&ndash;&gt;-->
<!--&lt;!&ndash;            <div class="input-group mb-3">&ndash;&gt;-->
<!--&lt;!&ndash;              <input type="text" id="newFleetName" class="form-control form-control-sm" placeholder="Nazwa floty">&ndash;&gt;-->
<!--&lt;!&ndash;              <button onclick="createFleet()" class="btn btn-sm btn-light"><i class="fas fa-plus"></i></button>&ndash;&gt;-->
<!--&lt;!&ndash;            </div>&ndash;&gt;-->
<!--&lt;!&ndash;            <ul class="list-group list-group-flush small" id="fleet-list"></ul>&ndash;&gt;-->
<!--&lt;!&ndash;          </div>&ndash;&gt;-->
<!--&lt;!&ndash;        </div>&ndash;&gt;-->
<!--&lt;!&ndash;        <div class="text-center">&ndash;&gt;-->
<!--&lt;!&ndash;          <button onclick="deleteAccount()" class="btn btn-sm btn-outline-danger w-100">Usuń Konto</button>&ndash;&gt;-->
<!--&lt;!&ndash;        </div>&ndash;&gt;-->
<!--&lt;!&ndash;      </div>&ndash;&gt;-->
<!--&lt;!&ndash;    </div>&ndash;&gt;-->
<!--&lt;!&ndash;  </div>&ndash;&gt;-->

<!--&lt;!&ndash;  <div id="stats-view" style="display: none;">&ndash;&gt;-->
<!--&lt;!&ndash;    <h3 class="mb-4 text-info"><i class="fas fa-chart-line"></i> Centrum Danych</h3>&ndash;&gt;-->

<!--&lt;!&ndash;    <div id="admin-stats-panel" class="card mb-5 border-warning" style="display: none;">&ndash;&gt;-->
<!--&lt;!&ndash;      <div class="card-header bg-warning text-dark fw-bold">Admin View</div>&ndash;&gt;-->
<!--&lt;!&ndash;      <div class="card-body">&ndash;&gt;-->
<!--&lt;!&ndash;        <div class="row text-center mb-4">&ndash;&gt;-->
<!--&lt;!&ndash;          <div class="col-md-3"><h2 id="adm-users" class="text-warning fw-bold">0</h2><small>Użytkowników</small></div>&ndash;&gt;-->
<!--&lt;!&ndash;          <div class="col-md-3"><h2 id="adm-lamps" class="text-light fw-bold">0</h2><small>Lamp</small></div>&ndash;&gt;-->
<!--&lt;!&ndash;          <div class="col-md-3"><h2 id="adm-online" class="text-success fw-bold">0</h2><small>Online</small></div>&ndash;&gt;-->
<!--&lt;!&ndash;          <div class="col-md-3"><h2 id="adm-temp" class="text-info fw-bold">0°C</h2><small>Śr. Temperatura</small></div>&ndash;&gt;-->
<!--&lt;!&ndash;        </div>&ndash;&gt;-->
<!--&lt;!&ndash;        <div class="row">&ndash;&gt;-->
<!--&lt;!&ndash;          <div class="col-md-4"><div class="chart-box"><canvas id="adminStatusChart"></canvas></div></div>&ndash;&gt;-->
<!--&lt;!&ndash;          <div class="col-md-4"><div class="chart-box"><canvas id="adminColorChart"></canvas></div></div>&ndash;&gt;-->
<!--&lt;!&ndash;          <div class="col-md-4"><div class="chart-box"><canvas id="adminTempChart"></canvas></div></div>&ndash;&gt;-->
<!--&lt;!&ndash;        </div>&ndash;&gt;-->
<!--&lt;!&ndash;      </div>&ndash;&gt;-->
<!--&lt;!&ndash;    </div>&ndash;&gt;-->

<!--&lt;!&ndash;    <div class="card border-primary">&ndash;&gt;-->
<!--&lt;!&ndash;      <div class="card-header bg-primary text-white fw-bold">Twoje Statystyki</div>&ndash;&gt;-->
<!--&lt;!&ndash;      <div class="card-body">&ndash;&gt;-->
<!--&lt;!&ndash;        <div class="row text-center mb-4">&ndash;&gt;-->
<!--&lt;!&ndash;          <div class="col-3"><h3 id="my-lamps" class="text-primary fw-bold">0</h3><small>Lampy</small></div>&ndash;&gt;-->
<!--&lt;!&ndash;          <div class="col-3"><h3 id="my-online" class="text-success fw-bold">0</h3><small>Włączone</small></div>&ndash;&gt;-->
<!--&lt;!&ndash;          <div class="col-3"><h3 id="my-offline" class="text-secondary fw-bold">0</h3><small>Wyłączone</small></div>&ndash;&gt;-->
<!--&lt;!&ndash;          <div class="col-3"><h3 id="my-temp" class="text-info fw-bold">0°C</h3><small>Śr. Temp</small></div>&ndash;&gt;-->
<!--&lt;!&ndash;        </div>&ndash;&gt;-->
<!--&lt;!&ndash;        <div class="row justify-content-center">&ndash;&gt;-->
<!--&lt;!&ndash;          <div class="col-md-5"><h6 class="text-center text-muted">Kolory</h6><div class="chart-box"><canvas id="userColorChart"></canvas></div></div>&ndash;&gt;-->
<!--&lt;!&ndash;          <div class="col-md-5"><h6 class="text-center text-muted">Temperatura</h6><div class="chart-box"><canvas id="userTempChart"></canvas></div></div>&ndash;&gt;-->
<!--&lt;!&ndash;        </div>&ndash;&gt;-->
<!--&lt;!&ndash;      </div>&ndash;&gt;-->
<!--&lt;!&ndash;    </div>&ndash;&gt;-->
<!--&lt;!&ndash;  </div>&ndash;&gt;-->

<!--&lt;!&ndash;</main>&ndash;&gt;-->

<!--&lt;!&ndash;<div class="modal fade" id="controlModal" tabindex="-1">&ndash;&gt;-->
<!--&lt;!&ndash;  <div class="modal-dialog">&ndash;&gt;-->
<!--&lt;!&ndash;    <div class="modal-content bg-dark text-white border-secondary">&ndash;&gt;-->
<!--&lt;!&ndash;      <div class="modal-header border-secondary">&ndash;&gt;-->
<!--&lt;!&ndash;        <h5 class="modal-title" id="modalTitle">Sterowanie</h5>&ndash;&gt;-->
<!--&lt;!&ndash;        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>&ndash;&gt;-->
<!--&lt;!&ndash;      </div>&ndash;&gt;-->
<!--&lt;!&ndash;      <div class="modal-body">&ndash;&gt;-->
<!--&lt;!&ndash;        <div class="alert alert-info py-2 small" id="targetInfo"></div>&ndash;&gt;-->
<!--&lt;!&ndash;        <div class="d-flex justify-content-center gap-3 mb-4">&ndash;&gt;-->
<!--&lt;!&ndash;          <button onclick="sendProtoCmd('ON')" class="btn btn-lg btn-success px-4">ON</button>&ndash;&gt;-->
<!--&lt;!&ndash;          <button onclick="sendProtoCmd('OFF')" class="btn btn-lg btn-danger px-4">OFF</button>&ndash;&gt;-->
<!--&lt;!&ndash;        </div>&ndash;&gt;-->
<!--&lt;!&ndash;        <hr class="border-secondary">&ndash;&gt;-->
<!--&lt;!&ndash;        <div class="mb-3">&ndash;&gt;-->
<!--&lt;!&ndash;          <label class="form-label">Jasność (<span id="briVal">50</span>%)</label>&ndash;&gt;-->
<!--&lt;!&ndash;          <input type="range" id="confBri" class="form-range" min="0" max="100" oninput="document.getElementById('briVal').innerText=this.value">&ndash;&gt;-->
<!--&lt;!&ndash;        </div>&ndash;&gt;-->
<!--&lt;!&ndash;        <div class="row mb-3">&ndash;&gt;-->
<!--&lt;!&ndash;          <div class="col-6">&ndash;&gt;-->
<!--&lt;!&ndash;            <label class="form-label">Kolor</label>&ndash;&gt;-->
<!--&lt;!&ndash;            <input type="color" id="confCol" class="form-control form-control-color w-100 bg-secondary border-0" value="#ffffff">&ndash;&gt;-->
<!--&lt;!&ndash;          </div>&ndash;&gt;-->
<!--&lt;!&ndash;          <div class="col-6">&ndash;&gt;-->
<!--&lt;!&ndash;            <label class="form-label">Interwał (s)</label>&ndash;&gt;-->
<!--&lt;!&ndash;            <input type="number" id="confInt" class="form-control bg-secondary text-white border-0" value="60">&ndash;&gt;-->
<!--&lt;!&ndash;          </div>&ndash;&gt;-->
<!--&lt;!&ndash;        </div>&ndash;&gt;-->
<!--&lt;!&ndash;        <button onclick="sendProtoConfig()" class="btn btn-primary w-100 mt-2">Wyślij Konfigurację</button>&ndash;&gt;-->
<!--&lt;!&ndash;      </div>&ndash;&gt;-->
<!--&lt;!&ndash;    </div>&ndash;&gt;-->
<!--&lt;!&ndash;  </div>&ndash;&gt;-->
<!--&lt;!&ndash;</div>&ndash;&gt;-->

<!--&lt;!&ndash;<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>&ndash;&gt;-->
<!--&lt;!&ndash;<script src="https://cdn.jsdelivr.net/npm/protobufjs@7.2.4/dist/protobuf.min.js"></script>&ndash;&gt;-->

<!--&lt;!&ndash;<script>&ndash;&gt;-->
<!--&lt;!&ndash;  const API = window.location.origin;&ndash;&gt;-->
<!--&lt;!&ndash;  let token = localStorage.getItem('jwt');&ndash;&gt;-->
<!--&lt;!&ndash;  let myFleets = [];&ndash;&gt;-->
<!--&lt;!&ndash;  let charts = {};&ndash;&gt;-->

<!--&lt;!&ndash;  // ZMIENNE DO STEROWANIA: type='lamp'|'fleet', id='...'&ndash;&gt;-->
<!--&lt;!&ndash;  let currentTarget = { type: 'lamp', id: null };&ndash;&gt;-->

<!--&lt;!&ndash;  // -&#45;&#45; PROTOBUF -&#45;&#45;&ndash;&gt;-->
<!--&lt;!&ndash;  let LampCommand, LampConfig;&ndash;&gt;-->
<!--&lt;!&ndash;  async function loadProtoDef() {&ndash;&gt;-->
<!--&lt;!&ndash;    try {&ndash;&gt;-->
<!--&lt;!&ndash;      let protoDef = `&ndash;&gt;-->
<!--&lt;!&ndash;        syntax = "proto3"; package com.iot.backend.proto;&ndash;&gt;-->
<!--&lt;!&ndash;        message LampCommand { enum Type { ON=0; OFF=1; REBOOT=2; OTA_UPDATE=3; } Type type=1; string ota_url=2; }&ndash;&gt;-->
<!--&lt;!&ndash;        message LampConfig { int32 brightness=1; string color=2; int32 report_interval=3; }&ndash;&gt;-->
<!--&lt;!&ndash;        message LampStatus { bool is_on=1; double sensor_value=2; }&ndash;&gt;-->
<!--&lt;!&ndash;        message StatusReport { uint32 version=1; int64 ts=2; uint32 uptime_seconds=3; repeated double temperature_readings=4; }&ndash;&gt;-->
<!--&lt;!&ndash;      `;&ndash;&gt;-->
<!--&lt;!&ndash;      const root = protobuf.parse(protoDef).root;&ndash;&gt;-->
<!--&lt;!&ndash;      LampCommand = root.lookupType("com.iot.backend.proto.LampCommand");&ndash;&gt;-->
<!--&lt;!&ndash;      LampConfig = root.lookupType("com.iot.backend.proto.LampConfig");&ndash;&gt;-->
<!--&lt;!&ndash;    } catch(e) { console.error("Proto error", e); }&ndash;&gt;-->
<!--&lt;!&ndash;  }&ndash;&gt;-->

<!--&lt;!&ndash;  (async function(){&ndash;&gt;-->
<!--&lt;!&ndash;    await loadProtoDef();&ndash;&gt;-->
<!--&lt;!&ndash;    if(token) init(); else showView('login');&ndash;&gt;-->
<!--&lt;!&ndash;  })();&ndash;&gt;-->

<!--&lt;!&ndash;  function showView(viewName) {&ndash;&gt;-->
<!--&lt;!&ndash;    document.getElementById('login-view').style.display = 'none';&ndash;&gt;-->
<!--&lt;!&ndash;    document.getElementById('register-view').style.display = 'none';&ndash;&gt;-->
<!--&lt;!&ndash;    document.getElementById('dashboard-view').style.display = 'none';&ndash;&gt;-->
<!--&lt;!&ndash;    document.getElementById('stats-view').style.display = 'none';&ndash;&gt;-->
<!--&lt;!&ndash;    document.getElementById('navbar').style.display = 'none';&ndash;&gt;-->
<!--&lt;!&ndash;    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));&ndash;&gt;-->

<!--&lt;!&ndash;    if(viewName === 'login') document.getElementById('login-view').style.display = 'block';&ndash;&gt;-->
<!--&lt;!&ndash;    if(viewName === 'register') document.getElementById('register-view').style.display = 'block';&ndash;&gt;-->
<!--&lt;!&ndash;    if(viewName === 'dashboard') {&ndash;&gt;-->
<!--&lt;!&ndash;      document.getElementById('dashboard-view').style.display = 'block';&ndash;&gt;-->
<!--&lt;!&ndash;      document.getElementById('navbar').style.display = 'block';&ndash;&gt;-->
<!--&lt;!&ndash;      document.querySelector('a[onclick="showView(\'dashboard\')"]').classList.add('active');&ndash;&gt;-->
<!--&lt;!&ndash;    }&ndash;&gt;-->
<!--&lt;!&ndash;    if(viewName === 'stats') {&ndash;&gt;-->
<!--&lt;!&ndash;      document.getElementById('stats-view').style.display = 'block';&ndash;&gt;-->
<!--&lt;!&ndash;      document.getElementById('navbar').style.display = 'block';&ndash;&gt;-->
<!--&lt;!&ndash;      document.querySelector('a[onclick="showView(\'stats\')"]').classList.add('active');&ndash;&gt;-->
<!--&lt;!&ndash;      loadStats();&ndash;&gt;-->
<!--&lt;!&ndash;    }&ndash;&gt;-->
<!--&lt;!&ndash;  }&ndash;&gt;-->

<!--&lt;!&ndash;  // -&#45;&#45; AUTH -&#45;&#45;&ndash;&gt;-->
<!--&lt;!&ndash;  async function handleLogin(e) {&ndash;&gt;-->
<!--&lt;!&ndash;    e.preventDefault();&ndash;&gt;-->
<!--&lt;!&ndash;    const u = document.getElementById('loginUser').value;&ndash;&gt;-->
<!--&lt;!&ndash;    const p = document.getElementById('loginPass').value;&ndash;&gt;-->
<!--&lt;!&ndash;    try {&ndash;&gt;-->
<!--&lt;!&ndash;      const res = await fetch(`${API}/auth/login`, {&ndash;&gt;-->
<!--&lt;!&ndash;        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({username: u, password: p})&ndash;&gt;-->
<!--&lt;!&ndash;      });&ndash;&gt;-->
<!--&lt;!&ndash;      if(!res.ok) throw new Error();&ndash;&gt;-->
<!--&lt;!&ndash;      const data = await res.json();&ndash;&gt;-->
<!--&lt;!&ndash;      token = data.accessToken;&ndash;&gt;-->
<!--&lt;!&ndash;      localStorage.setItem('jwt', token);&ndash;&gt;-->
<!--&lt;!&ndash;      localStorage.setItem('user', u);&ndash;&gt;-->
<!--&lt;!&ndash;      init();&ndash;&gt;-->
<!--&lt;!&ndash;    } catch(e) { alert('Błąd logowania'); }&ndash;&gt;-->
<!--&lt;!&ndash;  }&ndash;&gt;-->

<!--&lt;!&ndash;  async function handleRegister(e) {&ndash;&gt;-->
<!--&lt;!&ndash;    e.preventDefault();&ndash;&gt;-->
<!--&lt;!&ndash;    const u = document.getElementById('regUser').value;&ndash;&gt;-->
<!--&lt;!&ndash;    const p = document.getElementById('regPass').value;&ndash;&gt;-->
<!--&lt;!&ndash;    try {&ndash;&gt;-->
<!--&lt;!&ndash;      const res = await fetch(`${API}/users`, {&ndash;&gt;-->
<!--&lt;!&ndash;        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({username: u, password: p})&ndash;&gt;-->
<!--&lt;!&ndash;      });&ndash;&gt;-->
<!--&lt;!&ndash;      if(res.ok) { alert("Konto utworzone!"); showView('login'); }&ndash;&gt;-->
<!--&lt;!&ndash;      else alert("Błąd rejestracji");&ndash;&gt;-->
<!--&lt;!&ndash;    } catch(e) {}&ndash;&gt;-->
<!--&lt;!&ndash;  }&ndash;&gt;-->

<!--&lt;!&ndash;  function init() {&ndash;&gt;-->
<!--&lt;!&ndash;    showView('dashboard');&ndash;&gt;-->
<!--&lt;!&ndash;    document.getElementById('nav-username').innerText = localStorage.getItem('user');&ndash;&gt;-->
<!--&lt;!&ndash;    refreshAll();&ndash;&gt;-->
<!--&lt;!&ndash;  }&ndash;&gt;-->

<!--&lt;!&ndash;  // -&#45;&#45; STATS -&#45;&#45;&ndash;&gt;-->
<!--&lt;!&ndash;  async function loadStats() {&ndash;&gt;-->
<!--&lt;!&ndash;    const user = localStorage.getItem('user');&ndash;&gt;-->
<!--&lt;!&ndash;    // User stats&ndash;&gt;-->
<!--&lt;!&ndash;    try {&ndash;&gt;-->
<!--&lt;!&ndash;      const res = await authFetch(`${API}/stats/me`);&ndash;&gt;-->
<!--&lt;!&ndash;      if(res) {&ndash;&gt;-->
<!--&lt;!&ndash;        const data = await res.json();&ndash;&gt;-->
<!--&lt;!&ndash;        document.getElementById('my-lamps').innerText = data.totalLamps;&ndash;&gt;-->
<!--&lt;!&ndash;        document.getElementById('my-online').innerText = data.onlineLamps;&ndash;&gt;-->
<!--&lt;!&ndash;        document.getElementById('my-offline').innerText = data.offlineLamps;&ndash;&gt;-->
<!--&lt;!&ndash;        document.getElementById('my-temp').innerText = (data.averageTemperature || 0) + '°C';&ndash;&gt;-->

<!--&lt;!&ndash;        renderChart('userColorChart', 'doughnut', Object.keys(data.colorDistribution), Object.values(data.colorDistribution), 'Kolory');&ndash;&gt;-->

<!--&lt;!&ndash;        // Wykres temperatury (Słupkowy - pojedynczy słupek dla średniej)&ndash;&gt;-->
<!--&lt;!&ndash;        renderChart('userTempChart', 'bar', ['Średnia Temp'], [data.averageTemperature], 'Temperatura °C', ['#36a2eb']);&ndash;&gt;-->
<!--&lt;!&ndash;      }&ndash;&gt;-->
<!--&lt;!&ndash;    } catch(e) {}&ndash;&gt;-->

<!--&lt;!&ndash;    // Admin stats&ndash;&gt;-->
<!--&lt;!&ndash;    if(user === 'admin') {&ndash;&gt;-->
<!--&lt;!&ndash;      document.getElementById('admin-stats-panel').style.display = 'block';&ndash;&gt;-->
<!--&lt;!&ndash;      try {&ndash;&gt;-->
<!--&lt;!&ndash;        const res = await authFetch(`${API}/stats/global`);&ndash;&gt;-->
<!--&lt;!&ndash;        if(res && res.ok) {&ndash;&gt;-->
<!--&lt;!&ndash;          const data = await res.json();&ndash;&gt;-->
<!--&lt;!&ndash;          document.getElementById('adm-users').innerText = data.totalUsers;&ndash;&gt;-->
<!--&lt;!&ndash;          document.getElementById('adm-lamps').innerText = data.totalLamps;&ndash;&gt;-->
<!--&lt;!&ndash;          document.getElementById('adm-online').innerText = data.onlineLamps;&ndash;&gt;-->
<!--&lt;!&ndash;          document.getElementById('adm-temp').innerText = (data.averageTemperature || 0) + '°C';&ndash;&gt;-->

<!--&lt;!&ndash;          renderChart('adminStatusChart', 'pie', ['Online', 'Offline'], [data.onlineLamps, data.offlineLamps], 'Status', ['#2ecc71', '#e74c3c']);&ndash;&gt;-->
<!--&lt;!&ndash;          renderChart('adminColorChart', 'doughnut', Object.keys(data.colorDistribution), Object.values(data.colorDistribution), 'Kolory');&ndash;&gt;-->
<!--&lt;!&ndash;          renderChart('adminTempChart', 'bar', ['Średnia Temp'], [data.averageTemperature], 'Temperatura °C', ['#ffcd56']);&ndash;&gt;-->
<!--&lt;!&ndash;        }&ndash;&gt;-->
<!--&lt;!&ndash;      } catch(e) {}&ndash;&gt;-->
<!--&lt;!&ndash;    } else {&ndash;&gt;-->
<!--&lt;!&ndash;      document.getElementById('admin-stats-panel').style.display = 'none';&ndash;&gt;-->
<!--&lt;!&ndash;    }&ndash;&gt;-->
<!--&lt;!&ndash;  }&ndash;&gt;-->

<!--&lt;!&ndash;  function renderChart(canvasId, type, labels, dataArr, label, colors = null) {&ndash;&gt;-->
<!--&lt;!&ndash;    const ctx = document.getElementById(canvasId).getContext('2d');&ndash;&gt;-->
<!--&lt;!&ndash;    if(charts[canvasId]) charts[canvasId].destroy();&ndash;&gt;-->

<!--&lt;!&ndash;    let bgColors = colors;&ndash;&gt;-->
<!--&lt;!&ndash;    if(!bgColors) bgColors = labels.map(c => c.startsWith('#') ? c : '#3498db');&ndash;&gt;-->

<!--&lt;!&ndash;    charts[canvasId] = new Chart(ctx, {&ndash;&gt;-->
<!--&lt;!&ndash;      type: type,&ndash;&gt;-->
<!--&lt;!&ndash;      data: {&ndash;&gt;-->
<!--&lt;!&ndash;        labels: labels,&ndash;&gt;-->
<!--&lt;!&ndash;        datasets: [{ label: label, data: dataArr, backgroundColor: bgColors, borderWidth: 0 }]&ndash;&gt;-->
<!--&lt;!&ndash;      },&ndash;&gt;-->
<!--&lt;!&ndash;      options: {&ndash;&gt;-->
<!--&lt;!&ndash;        responsive: true, maintainAspectRatio: false,&ndash;&gt;-->
<!--&lt;!&ndash;        plugins: { legend: { display: type!=='bar', labels: { color: '#ccc' } } },&ndash;&gt;-->
<!--&lt;!&ndash;        scales: (type==='bar') ? { y: { beginAtZero: true, ticks:{color:'#ccc'} }, x:{ticks:{color:'#ccc'}} } : {}&ndash;&gt;-->
<!--&lt;!&ndash;      }&ndash;&gt;-->
<!--&lt;!&ndash;    });&ndash;&gt;-->
<!--&lt;!&ndash;  }&ndash;&gt;-->

<!--&lt;!&ndash;  // -&#45;&#45; CORE LOGIC -&#45;&#45;&ndash;&gt;-->
<!--&lt;!&ndash;  async function refreshAll() { await loadFleets(); await loadLamps(); }&ndash;&gt;-->

<!--&lt;!&ndash;  async function loadFleets() {&ndash;&gt;-->
<!--&lt;!&ndash;    const res = await authFetch(`${API}/fleets`);&ndash;&gt;-->
<!--&lt;!&ndash;    if(!res) return;&ndash;&gt;-->
<!--&lt;!&ndash;    myFleets = await res.json();&ndash;&gt;-->
<!--&lt;!&ndash;    const list = document.getElementById('fleet-list');&ndash;&gt;-->
<!--&lt;!&ndash;    list.innerHTML = '';&ndash;&gt;-->
<!--&lt;!&ndash;    myFleets.forEach(f => {&ndash;&gt;-->
<!--&lt;!&ndash;      // DODAŁEM PRZYCISK "STERUJ" DLA FLOTY&ndash;&gt;-->
<!--&lt;!&ndash;      list.innerHTML += `&ndash;&gt;-->
<!--&lt;!&ndash;        <li class="list-group-item bg-dark text-white border-secondary d-flex justify-content-between align-items-center">&ndash;&gt;-->
<!--&lt;!&ndash;            <div>&ndash;&gt;-->
<!--&lt;!&ndash;              <span>${f.name}</span> <span class="badge bg-secondary ms-1">ID: ${f.id}</span>&ndash;&gt;-->
<!--&lt;!&ndash;            </div>&ndash;&gt;-->
<!--&lt;!&ndash;            <button onclick="openModal('fleet', ${f.id})" class="btn btn-sm btn-outline-info" title="Steruj całą grupą">&ndash;&gt;-->
<!--&lt;!&ndash;               <i class="fas fa-sliders-h"></i>&ndash;&gt;-->
<!--&lt;!&ndash;            </button>&ndash;&gt;-->
<!--&lt;!&ndash;        </li>`;&ndash;&gt;-->
<!--&lt;!&ndash;    });&ndash;&gt;-->
<!--&lt;!&ndash;  }&ndash;&gt;-->

<!--&lt;!&ndash;  async function loadLamps() {&ndash;&gt;-->
<!--&lt;!&ndash;    const res = await authFetch(`${API}/users/me/lamps`);&ndash;&gt;-->
<!--&lt;!&ndash;    if(!res) return;&ndash;&gt;-->
<!--&lt;!&ndash;    let lamps = await res.json();&ndash;&gt;-->

<!--&lt;!&ndash;    // -&#45;&#45; NOWE: SORTOWANIE -&#45;&#45;&ndash;&gt;-->
<!--&lt;!&ndash;    // 1. Lampy bez floty (null) na górę.&ndash;&gt;-->
<!--&lt;!&ndash;    // 2. Lampy z flotą rosnąco po ID floty.&ndash;&gt;-->
<!--&lt;!&ndash;    // 3. Wewnątrz grupy sortujemy alfabetycznie po ID lampy.&ndash;&gt;-->
<!--&lt;!&ndash;    lamps.sort((a, b) => {&ndash;&gt;-->
<!--&lt;!&ndash;      const fA = a.fleetId;&ndash;&gt;-->
<!--&lt;!&ndash;      const fB = b.fleetId;&ndash;&gt;-->

<!--&lt;!&ndash;      // Jeśli oba nie mają floty -> sortuj po nazwie lampy&ndash;&gt;-->
<!--&lt;!&ndash;      if (!fA && !fB) return a.id.localeCompare(b.id);&ndash;&gt;-->

<!--&lt;!&ndash;      // Jeśli A nie ma floty -> A idzie na początek (-1)&ndash;&gt;-->
<!--&lt;!&ndash;      if (!fA) return -1;&ndash;&gt;-->

<!--&lt;!&ndash;      // Jeśli B nie ma floty -> B idzie na początek (1)&ndash;&gt;-->
<!--&lt;!&ndash;      if (!fB) return 1;&ndash;&gt;-->

<!--&lt;!&ndash;      // Jeśli oba mają floty -> sortuj po ID floty&ndash;&gt;-->
<!--&lt;!&ndash;      if (fA !== fB) return fA - fB;&ndash;&gt;-->

<!--&lt;!&ndash;      // Jeśli ta sama flota -> sortuj po nazwie lampy&ndash;&gt;-->
<!--&lt;!&ndash;      return a.id.localeCompare(b.id);&ndash;&gt;-->
<!--&lt;!&ndash;    });&ndash;&gt;-->
<!--&lt;!&ndash;    // &#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&ndash;&gt;-->

<!--&lt;!&ndash;    const grid = document.getElementById('lamp-grid');&ndash;&gt;-->
<!--&lt;!&ndash;    grid.innerHTML = '';&ndash;&gt;-->

<!--&lt;!&ndash;    lamps.forEach(lamp => {&ndash;&gt;-->
<!--&lt;!&ndash;      let optionsHtml = '<option value="" disabled selected>Flota...</option>';&ndash;&gt;-->
<!--&lt;!&ndash;      myFleets.forEach(f => { optionsHtml += `<option value="${f.id}">${f.name}</option>`; });&ndash;&gt;-->

<!--&lt;!&ndash;      let fleetSec = lamp.fleetId&ndash;&gt;-->
<!--&lt;!&ndash;              ? `<div class="alert alert-dark border-secondary p-1 mb-2 d-flex justify-content-between align-items-center"><small class="text-info mx-2">Flota: ${lamp.fleetId}</small><button onclick="removeFromFleet(${lamp.fleetId}, '${lamp.id}')" class="btn btn-sm btn-outline-warning">X</button></div>`&ndash;&gt;-->
<!--&lt;!&ndash;              : `<div class="input-group input-group-sm mb-2"><select id="sel-${lamp.id}" class="form-select bg-dark text-white border-secondary">${optionsHtml}</select><button onclick="assignToFleet('${lamp.id}')" class="btn btn-outline-secondary"><i class="fas fa-check"></i></button></div>`;&ndash;&gt;-->

<!--&lt;!&ndash;      grid.innerHTML += `&ndash;&gt;-->
<!--&lt;!&ndash;        <div class="col"><div class="card h-100"><div class="card-body">&ndash;&gt;-->
<!--&lt;!&ndash;            <div class="d-flex justify-content-between align-items-center mb-3">&ndash;&gt;-->
<!--&lt;!&ndash;                <h5 class="card-title m-0 text-truncate" title="${lamp.id}">${lamp.id}</h5>&ndash;&gt;-->
<!--&lt;!&ndash;                <span class="status-dot ${lamp.on ? 'status-on':'status-off'}"></span>&ndash;&gt;-->
<!--&lt;!&ndash;            </div>&ndash;&gt;-->
<!--&lt;!&ndash;            ${fleetSec}&ndash;&gt;-->
<!--&lt;!&ndash;            <div class="d-grid gap-2 d-flex">&ndash;&gt;-->
<!--&lt;!&ndash;                <button onclick="openModal('lamp', '${lamp.id}')" class="btn btn-sm btn-primary flex-grow-1">Steruj</button>&ndash;&gt;-->
<!--&lt;!&ndash;                <button onclick="delLamp('${lamp.id}')" class="btn btn-sm btn-danger"><i class="fas fa-trash"></i></button>&ndash;&gt;-->
<!--&lt;!&ndash;            </div>&ndash;&gt;-->
<!--&lt;!&ndash;        </div></div></div>`;&ndash;&gt;-->
<!--&lt;!&ndash;    });&ndash;&gt;-->
<!--&lt;!&ndash;  }&ndash;&gt;-->

<!--&lt;!&ndash;  // -&#45;&#45; CONTROL MODAL -&#45;&#45;&ndash;&gt;-->
<!--&lt;!&ndash;  async function openModal(type, id) {&ndash;&gt;-->
<!--&lt;!&ndash;    currentTarget = { type: type, id: id };&ndash;&gt;-->
<!--&lt;!&ndash;    const title = (type === 'lamp') ? `Lampa: ${id}` : `Flota: ${id} (Wszystkie)`;&ndash;&gt;-->
<!--&lt;!&ndash;    document.getElementById('modalTitle').innerText = title;&ndash;&gt;-->
<!--&lt;!&ndash;    document.getElementById('targetInfo').innerText = (type==='fleet')&ndash;&gt;-->
<!--&lt;!&ndash;            ? "Zmiany zostaną wysłane do wszystkich lamp w tej flocie."&ndash;&gt;-->
<!--&lt;!&ndash;            : "Sterujesz pojedynczym urządzeniem. Wartości wczytane z bazy.";&ndash;&gt;-->

<!--&lt;!&ndash;    // Reset formularza do wartości domyślnych (na wypadek błędu ładowania)&ndash;&gt;-->
<!--&lt;!&ndash;    document.getElementById('confBri').value = 50;&ndash;&gt;-->
<!--&lt;!&ndash;    document.getElementById('briVal').innerText = "50";&ndash;&gt;-->
<!--&lt;!&ndash;    document.getElementById('confCol').value = "#ffffff";&ndash;&gt;-->
<!--&lt;!&ndash;    document.getElementById('confInt').value = 60;&ndash;&gt;-->

<!--&lt;!&ndash;    // Jeśli to pojedyncza lampa, pobieramy jej aktualny config z bazy&ndash;&gt;-->
<!--&lt;!&ndash;    if(type === 'lamp') {&ndash;&gt;-->
<!--&lt;!&ndash;      try {&ndash;&gt;-->
<!--&lt;!&ndash;        const res = await fetch(`${API}/lamps/${id}/config`, {&ndash;&gt;-->
<!--&lt;!&ndash;          headers: { 'Authorization': `Bearer ${token}` }&ndash;&gt;-->
<!--&lt;!&ndash;        });&ndash;&gt;-->

<!--&lt;!&ndash;        if(res.ok) {&ndash;&gt;-->
<!--&lt;!&ndash;          const buffer = await res.arrayBuffer();&ndash;&gt;-->
<!--&lt;!&ndash;          // Dekodowanie Protobuf&ndash;&gt;-->
<!--&lt;!&ndash;          const decoded = LampConfig.decode(new Uint8Array(buffer));&ndash;&gt;-->

<!--&lt;!&ndash;          // -&#45;&#45; TUTAJ AKTUALIZUJEMY UI WARTOŚCIAMI Z BAZY -&#45;&#45;&ndash;&gt;-->
<!--&lt;!&ndash;          // Jasność&ndash;&gt;-->
<!--&lt;!&ndash;          const bri = decoded.brightness !== undefined ? decoded.brightness : 50;&ndash;&gt;-->
<!--&lt;!&ndash;          document.getElementById('confBri').value = bri;&ndash;&gt;-->
<!--&lt;!&ndash;          document.getElementById('briVal').innerText = bri; // Aktualizacja etykiety tekstowej!&ndash;&gt;-->

<!--&lt;!&ndash;          // Kolor&ndash;&gt;-->
<!--&lt;!&ndash;          const col = decoded.color || "#ffffff";&ndash;&gt;-->
<!--&lt;!&ndash;          document.getElementById('confCol').value = col;&ndash;&gt;-->

<!--&lt;!&ndash;          // Interwał&ndash;&gt;-->
<!--&lt;!&ndash;          const interval = decoded.report_interval !== undefined ? decoded.report_interval : 60;&ndash;&gt;-->
<!--&lt;!&ndash;          document.getElementById('confInt').value = interval;&ndash;&gt;-->
<!--&lt;!&ndash;        }&ndash;&gt;-->
<!--&lt;!&ndash;      } catch(e) {&ndash;&gt;-->
<!--&lt;!&ndash;        console.error("Błąd pobierania configu lampy:", e);&ndash;&gt;-->
<!--&lt;!&ndash;      }&ndash;&gt;-->
<!--&lt;!&ndash;    }&ndash;&gt;-->
<!--&lt;!&ndash;    // Dla floty (type === 'fleet') zostawiamy wartości domyślne,&ndash;&gt;-->
<!--&lt;!&ndash;    // ponieważ flota może mieć lampy o różnych ustawieniach, więc nie ma jednego "wspólnego" stanu do wyświetlenia.&ndash;&gt;-->

<!--&lt;!&ndash;    new bootstrap.Modal(document.getElementById('controlModal')).show();&ndash;&gt;-->
<!--&lt;!&ndash;  }&ndash;&gt;-->

<!--&lt;!&ndash;  async function sendProtoCmd(typeStr) {&ndash;&gt;-->
<!--&lt;!&ndash;    const payload = { type: (typeStr==='ON'?0:1) };&ndash;&gt;-->
<!--&lt;!&ndash;    const buf = LampCommand.encode(LampCommand.create(payload)).finish();&ndash;&gt;-->

<!--&lt;!&ndash;    // WYBÓR URL W ZALEŻNOŚCI OD TYPU&ndash;&gt;-->
<!--&lt;!&ndash;    let url = (currentTarget.type === 'lamp')&ndash;&gt;-->
<!--&lt;!&ndash;            ? `${API}/lamps/${currentTarget.id}/command`&ndash;&gt;-->
<!--&lt;!&ndash;            : `${API}/fleets/${currentTarget.id}/command`;&ndash;&gt;-->

<!--&lt;!&ndash;    await sendBin(url, buf);&ndash;&gt;-->
<!--&lt;!&ndash;    if(currentTarget.type === 'lamp') setTimeout(loadLamps, 1000);&ndash;&gt;-->
<!--&lt;!&ndash;  }&ndash;&gt;-->

<!--&lt;!&ndash;  async function sendProtoConfig() {&ndash;&gt;-->
<!--&lt;!&ndash;    const payload = {&ndash;&gt;-->
<!--&lt;!&ndash;      brightness: parseInt(document.getElementById('confBri').value),&ndash;&gt;-->
<!--&lt;!&ndash;      color: document.getElementById('confCol').value,&ndash;&gt;-->
<!--&lt;!&ndash;      report_interval: parseInt(document.getElementById('confInt').value)&ndash;&gt;-->
<!--&lt;!&ndash;    };&ndash;&gt;-->
<!--&lt;!&ndash;    const buf = LampConfig.encode(LampConfig.create(payload)).finish();&ndash;&gt;-->

<!--&lt;!&ndash;    // WYBÓR URL W ZALEŻNOŚCI OD TYPU&ndash;&gt;-->
<!--&lt;!&ndash;    let url = (currentTarget.type === 'lamp')&ndash;&gt;-->
<!--&lt;!&ndash;            ? `${API}/lamps/${currentTarget.id}/config`&ndash;&gt;-->
<!--&lt;!&ndash;            : `${API}/fleets/${currentTarget.id}/config`;&ndash;&gt;-->

<!--&lt;!&ndash;    await sendBin(url, buf, 'PUT');&ndash;&gt;-->
<!--&lt;!&ndash;    alert('Wysłano');&ndash;&gt;-->

<!--&lt;!&ndash;    // -&#45;&#45; NOWE: ODŚWIEŻ WIDOK LAMP -&#45;&#45;&ndash;&gt;-->
<!--&lt;!&ndash;    // Czekamy chwilę (500ms), żeby baza zdążyła się zapisać, a potem przeładowujemy siatkę lamp&ndash;&gt;-->
<!--&lt;!&ndash;    setTimeout(loadLamps, 500);&ndash;&gt;-->
<!--&lt;!&ndash;  }&ndash;&gt;-->

<!--&lt;!&ndash;  // -&#45;&#45; ACTIONS -&#45;&#45;&ndash;&gt;-->
<!--&lt;!&ndash;  async function createFleet() {&ndash;&gt;-->
<!--&lt;!&ndash;    const name = document.getElementById('newFleetName').value;&ndash;&gt;-->
<!--&lt;!&ndash;    if(!name) return;&ndash;&gt;-->
<!--&lt;!&ndash;    await authFetch(`${API}/fleets`, { method: 'POST', body: JSON.stringify({name}) });&ndash;&gt;-->
<!--&lt;!&ndash;    document.getElementById('newFleetName').value=''; refreshAll();&ndash;&gt;-->
<!--&lt;!&ndash;  }&ndash;&gt;-->
<!--&lt;!&ndash;  async function addLamp() {&ndash;&gt;-->
<!--&lt;!&ndash;    const id = document.getElementById('newLampId').value;&ndash;&gt;-->
<!--&lt;!&ndash;    if(!id) return;&ndash;&gt;-->

<!--&lt;!&ndash;    const res = await authFetch(`${API}/users/me/lamps`, {&ndash;&gt;-->
<!--&lt;!&ndash;      method:'POST',&ndash;&gt;-->
<!--&lt;!&ndash;      body: JSON.stringify({lampId: id})&ndash;&gt;-->
<!--&lt;!&ndash;    });&ndash;&gt;-->

<!--&lt;!&ndash;    if(res && res.ok) {&ndash;&gt;-->
<!--&lt;!&ndash;      const data = await res.json();&ndash;&gt;-->
<!--&lt;!&ndash;      // Wyświetl token użytkownikowi&ndash;&gt;-->
<!--&lt;!&ndash;      alert("Lampa dodana! \nTwój UNIKALNY TOKEN urządzenia to:\n\n" + data.device_token + "\n\nZapisz go w kodzie ESP32, nie zobaczysz go ponownie!");&ndash;&gt;-->

<!--&lt;!&ndash;      document.getElementById('newLampId').value='';&ndash;&gt;-->
<!--&lt;!&ndash;      loadLamps();&ndash;&gt;-->
<!--&lt;!&ndash;    }&ndash;&gt;-->
<!--&lt;!&ndash;  }&ndash;&gt;-->
<!--&lt;!&ndash;  async function delLamp(id) { if(confirm('Usunąć?')) { await authFetch(`${API}/users/me/lamps/${id}`, {method:'DELETE'}); loadLamps(); } }&ndash;&gt;-->
<!--&lt;!&ndash;  async function assignToFleet(lId) {&ndash;&gt;-->
<!--&lt;!&ndash;    const fId = document.getElementById(`sel-${lId}`).value;&ndash;&gt;-->
<!--&lt;!&ndash;    if(!fId) return;&ndash;&gt;-->
<!--&lt;!&ndash;    await authFetch(`${API}/fleets/${fId}/lamps/${lId}`, { method: 'POST' });&ndash;&gt;-->
<!--&lt;!&ndash;    loadLamps();&ndash;&gt;-->
<!--&lt;!&ndash;  }&ndash;&gt;-->
<!--&lt;!&ndash;  async function removeFromFleet(fId, lId) {&ndash;&gt;-->
<!--&lt;!&ndash;    if(confirm('Odpiąć?')) { await authFetch(`${API}/fleets/${fId}/lamps/${lId}`, { method: 'DELETE' }); loadLamps(); }&ndash;&gt;-->
<!--&lt;!&ndash;  }&ndash;&gt;-->

<!--&lt;!&ndash;  // -&#45;&#45; UTILS -&#45;&#45;&ndash;&gt;-->
<!--&lt;!&ndash;  async function handleOtaUpload(e) {&ndash;&gt;-->
<!--&lt;!&ndash;    e.preventDefault();&ndash;&gt;-->

<!--&lt;!&ndash;    // 1. Pobierz dane z formularza&ndash;&gt;-->
<!--&lt;!&ndash;    const targetType = document.getElementById('otaTargetType').value; // 'lamp' lub 'fleet'&ndash;&gt;-->
<!--&lt;!&ndash;    const targetId = document.getElementById('otaTargetId').value;&ndash;&gt;-->
<!--&lt;!&ndash;    const fileInput = document.getElementById('otaFile');&ndash;&gt;-->

<!--&lt;!&ndash;    // UWAGA: Twój obecny backend (LampCommand proto) przyjmuje 'ota_url' (String).&ndash;&gt;-->
<!--&lt;!&ndash;    // Jeśli nie masz serwera plików, musisz tu wpisać URL ręcznie zamiast uploadować plik.&ndash;&gt;-->
<!--&lt;!&ndash;    // Zakładając, że pole input type="file" służy tylko do symulacji, a backend chce URL:&ndash;&gt;-->

<!--&lt;!&ndash;    const firmwareUrl = "http://http://srv38.mikr.us:40142/firmware.bin"; // Tutaj logika uploadu lub wpisania URL&ndash;&gt;-->

<!--&lt;!&ndash;    // Budowanie komendy Proto (Type = OTA_UPDATE = 3)&ndash;&gt;-->
<!--&lt;!&ndash;    // Musisz sprawdzić w .proto jaki numer ma OTA_UPDATE (w kodzie wyżej: ON=0, OFF=1, REBOOT=2, OTA=3)&ndash;&gt;-->
<!--&lt;!&ndash;    const payload = {&ndash;&gt;-->
<!--&lt;!&ndash;      type: 3,&ndash;&gt;-->
<!--&lt;!&ndash;      ota_url: firmwareUrl&ndash;&gt;-->
<!--&lt;!&ndash;    };&ndash;&gt;-->

<!--&lt;!&ndash;    const buf = LampCommand.encode(LampCommand.create(payload)).finish();&ndash;&gt;-->

<!--&lt;!&ndash;    // Wybór endpointu (lamps vs fleets)&ndash;&gt;-->
<!--&lt;!&ndash;    let url = (targetType === 'lamp')&ndash;&gt;-->
<!--&lt;!&ndash;            ? `${API}/lamps/${targetId}/command`&ndash;&gt;-->
<!--&lt;!&ndash;            : `${API}/fleets/${targetId}/command`;&ndash;&gt;-->

<!--&lt;!&ndash;    await sendBin(url, buf);&ndash;&gt;-->
<!--&lt;!&ndash;    alert('Rozkaz aktualizacji wysłany!');&ndash;&gt;-->
<!--&lt;!&ndash;  }&ndash;&gt;-->
<!--&lt;!&ndash;  function toggleOtaTarget() { /* ... */ }&ndash;&gt;-->
<!--&lt;!&ndash;  async function authFetch(url, opts={}) {&ndash;&gt;-->
<!--&lt;!&ndash;    opts.headers = opts.headers || {};&ndash;&gt;-->
<!--&lt;!&ndash;    opts.headers['Authorization'] = `Bearer ${token}`;&ndash;&gt;-->
<!--&lt;!&ndash;    if(opts.body && !opts.headers['Content-Type']) opts.headers['Content-Type']='application/json';&ndash;&gt;-->
<!--&lt;!&ndash;    const res = await fetch(url, opts);&ndash;&gt;-->
<!--&lt;!&ndash;    if(res.status === 401) {&ndash;&gt;-->
<!--&lt;!&ndash;      logout();&ndash;&gt;-->
<!--&lt;!&ndash;      return null;&ndash;&gt;-->
<!--&lt;!&ndash;    }&ndash;&gt;-->

<!--&lt;!&ndash;    // Opcjonalnie: Możesz tu obsłużyć 403 alertem, zamiast wylogowaniem&ndash;&gt;-->
<!--&lt;!&ndash;    if(res.status === 403) {&ndash;&gt;-->
<!--&lt;!&ndash;      console.warn("Brak uprawnień do tego zasobu (403)");&ndash;&gt;-->
<!--&lt;!&ndash;      // Nie wylogowujemy! Zwracamy response, żeby funkcja wywołująca mogła obsłużyć błąd&ndash;&gt;-->
<!--&lt;!&ndash;    }&ndash;&gt;-->
<!--&lt;!&ndash;    return res;&ndash;&gt;-->
<!--&lt;!&ndash;  }&ndash;&gt;-->
<!--&lt;!&ndash;  async function sendBin(url, body, method='POST') {&ndash;&gt;-->
<!--&lt;!&ndash;    const res = await fetch(url, { method: method, headers: {'Authorization':`Bearer ${token}`, 'Content-Type':'application/x-protobuf'}, body: body });&ndash;&gt;-->
<!--&lt;!&ndash;    if(!res.ok) alert('Błąd wysyłania');&ndash;&gt;-->
<!--&lt;!&ndash;  }&ndash;&gt;-->
<!--&lt;!&ndash;  function logout() { localStorage.removeItem('jwt'); location.reload(); }&ndash;&gt;-->
<!--&lt;!&ndash;  function deleteAccount() { if(confirm('Usunąć konto?')) { authFetch(`${API}/users/me`, {method:'DELETE'}); logout(); } }&ndash;&gt;-->
<!--&lt;!&ndash;</script>&ndash;&gt;-->
<!--&lt;!&ndash;</body>&ndash;&gt;-->
<!--&lt;!&ndash;</html>&ndash;&gt;-->